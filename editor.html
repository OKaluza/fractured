<html><head><meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1">

<title>Fractal WebGL - editor</title>

<link href='http://fonts.googleapis.com/css?family=Droid+Sans+Mono' rel='stylesheet' type='text/css'>


<!-- CodeMirror-->
<script src="codemirror/lib/codemirror.js"></script>
<link rel="stylesheet" href="codemirror/lib/codemirror.css">
<script src="codemirror/mode/clike/clike.js"></script>
<link rel="stylesheet" href="codemirror/theme/fractured.css">

<style type="text/css">
/* Override some codemirror defaults */
.CodeMirror {
  font-family: 'Droid Sans Mono',monospace;
  font-size: 10pt;
  line-height: 1.1em;
}
.CodeMirror-scroll {height: 100%;}
.searched {background: yellow; color: navy}

body {
  background: #ffe;
  font-family: 'Droid Sans Mono',monospace;
}
html, body { 
  padding: 0; margin: 0; 
}

#buttons{ 
  margin: 1px; padding:0px;
  background: #888;
  border-radius: 4px;
  height: 28px;
}
#buttons input,select{ 
  float: left;
  width: 80px; height: 24px;
  margin: 2px; padding: 0px 0px 2px 0px;
}

#code{
  position: absolute; top: 30px; left: 2px; right: 2px; bottom: 2px;
}
#editor{
  width: 100%; height: 100%;
}

</style>


<script type="text/javascript">
var editor;
var code;
var filename;
var type;
var formula;

  saveEditor = function() {
    editor.save();  //Updates textarea content
    window.opener.sources[filename] = code.value;
    window.opener.ajaxWriteFile(filename, window.opener.sources[filename], window.opener.consoleWrite);
  }

  updateEditor = function() {
    editor.save();  //Updates textarea content
    window.opener.sources[filename] = code.value;
    //Editing compiled shader source?
    if (filename == "gen-shader.frag")
      window.opener.fractal.updateShader(code.value);
    else {
      if (type) window.opener.fractal[type].select();
      window.opener.fractal.writeShader();
    }
    window.opener.fractal.draw();
  }

  loadEditor = function() {
    //Copy for fallback to code
    code = document.getElementById('editor');

    var query = decodeURI(window.location.href).split("?")[1]; //whole querystring including ?
    var param = query ? query.split("=")[1] : "";

    type = "";
    if (param.indexOf('.') == -1) {
      type = param;
      filename = window.opener.fractal[type].filename();
    } else
      filename = param;

    code.value = window.opener.sources[filename];

    editor = new CodeMirror.fromTextArea(code, {
      mode: "text/x-glsl",
      theme: "fractured" + window.opener.editorTheme,
      height: "100%",
      saveFunction: saveEditor,
      lineNumbers: true,
      firstLineNumber: window.opener.formulaOffsets[type],
      indentUnit: 2,
      tabMode: "classic",
      matchBrackets: true
    });
    sel = document.getElementById('theme');
    sel.value = window.opener.editorTheme;
  };

  function selectTheme(sel) {
    var themename = sel.options[sel.selectedIndex].innerHTML;
    var theme = "fractured" + themename;
    editor.setOption("theme", theme);
    window.opener.editorTheme = themename;
  }


/* Codemirror search/replace functions */
var lastPos = null, lastQuery = null, marked = [];

function unmark() {
  for (var i = 0; i < marked.length; ++i) marked[i]();
  marked.length = 0;
}

function search() {
  unmark();                     
  var text = document.getElementById("query").value;
  if (!text) return;
  for (var cursor = editor.getSearchCursor(text); cursor.findNext();)
    marked.push(editor.markText(cursor.from(), cursor.to(), "searched"));

  if (lastQuery != text) lastPos = null;
  var cursor = editor.getSearchCursor(text, lastPos || editor.getCursor());
  if (!cursor.findNext()) {
    cursor = editor.getSearchCursor(text);
    if (!cursor.findNext()) return;
  }
  editor.setSelection(cursor.from(), cursor.to());
  lastQuery = text; lastPos = cursor.to();
}

function replace() {
  unmark();
  var text = document.getElementById("query").value,
      replace = document.getElementById("replace").value;
  if (!text) return;
  for (var cursor = editor.getSearchCursor(text); cursor.findNext();)
    cursor.replace(replace);
}
</script>

</head>

<body onload="loadEditor()" onUnload="window.opener.closeEditor();" >

<div id="buttons">
  <input type="button" value="Update" onclick="updateEditor()">
  <input type="button" value="Save" onclick="saveEditor()">
  <input type="text" style="width: 15em" id="query" onkeypress="if(event.keyCode == 13 && this.value!='') search(); return true; ">
  <!--button type="button" onclick="search()">Search</button-->
  <select id="theme" style="float: right" onchange="selectTheme(this)">
    <option selected>light</option>
    <option>dark</option>
  </select>
</div>

<div id="code">
<textarea id="editor" spellcheck="false">
</textarea> 
</div>

</body></html>
