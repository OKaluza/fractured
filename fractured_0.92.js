function State(a){if(!this.supported())throw"Error initialising state: Local storage not supported";this.upgrademsg="<a href='javascript:resetReload()'>click here</a> to complete update by reloading from server";this.props="version fractal session formulae antialias debug renderer platform device cards active name thumbnail".split(" ");this.version=a;this.loggedin=!1;this.offline=null;this.gallery="#examples";this.offset=this.mode=0;this.recording=!1;this.baseurl="";this.locator=null;this.output=
!0;this.timers=350;this.cards={};this.fractal=null;this.formulae=this.session=0;this.antialias=2;this.debug=!1;this.renderer=WEBGL;this.platform=this.device=0;this.server=this.active=this.thumbnail=null;this.disabled=this.control=!1;this.drawMode(!0);this.controlMode(!0);this.loadStatus();this.cards||(this.cards={});this.debug&&this.debugOn();"string"!=typeof this.fractal&&(this.fractal=null);this.active=localStorage["fractured.active"];delete localStorage["fractured.active"];this.thumbnail||(this.thumbnail=
localStorage["fractured.thumbnail"],delete localStorage["fractured.thumbnail"]);a&&this.version!=a&&(this.version=a,this.saveStatus(),popup("New version <b>"+this.version+"</b>: Application upgraded<br>"+this.upgrademsg))}State.prototype.supported=function(){try{return"localStorage"in window&&null!==window.localStorage}catch(a){return!1}};State.prototype.clearStatus=function(){delete localStorage["fractured.current"]};
State.prototype.saveStatus=function(){var a={};for(i in this.props){var b=this.props[i];a[b]=this[b]}localStorage["fractured.current"]=JSON.stringify(a)};State.prototype.loadStatus=function(){var a=localStorage["fractured.current"];if(a)for(i in a=JSON.parse(a),this.props){var b=this.props[i];this[b]=a[b]}};
State.prototype.debugOn=function(){this.debug=!0;document.getElementById("debugmenu")&&(document.getElementById("debugmenu").style.display="block",document.getElementById("recordmenu").style.display="block")};State.prototype.debugOff=function(){this.debug=!1;this.saveStatus();document.getElementById("debugmenu").style.display="none";document.getElementById("recordmenu").style.display="none"};
State.prototype.drawMode=function(a){a||(this.disabled=!this.disabled);document.getElementById("drawmodebtn")&&(document.getElementById("drawmodebtn").innerHTML="Draw Mode"+(this.disabled?"":"&#10003;"))};State.prototype.controlMode=function(a){a||(this.control=!this.control);document.getElementById("ctrlmodebtn")&&(document.getElementById("ctrlmodebtn").innerHTML="Control Mode"+(this.control?"&#10003;":""))};State.prototype.resetFormulae=function(){print("Resetting all formulae to defaults");delete localStorage["fractured.formulae"]};
State.prototype.convertFractals=function(a){var b={};thumbnails=[];var c=localStorage["fractured.thumbnails"];c&&(thumbnails=JSON.parse(c));for(c=1;c<=a;c++){var d=localStorage["fractured.fractal."+c],f=localStorage["fractured.names."+c];d&&(b[f]=new FractalEntry(d,thumbnails[c]))}localStorage["fractured.fractals"]=JSON.stringify(b);for(c=1;c<=a;c++)localStorage.removeItem("fractured.names."+c),localStorage.removeItem("fractured.fractal."+c);localStorage.removeItem("fractured.thumbnails");this.fractal=
null;return b};State.prototype.getFractals=function(){var a={},b=localStorage["fractured.fractals"];if(void 0!=b)try{var a=JSON.parse(b),c=parseInt(b),a=isNaN(c)?JSON.parse(b):this.convertFractals(c)}catch(d){console.log("Invalid fractal string: "+b)}return a};
State.prototype.getPalettes=function(){var a=localStorage["fractured.palettes"];this.palettes=[];if(void 0!=a)try{this.palettes=JSON.parse(a),populatePalettes(this.palettes)}catch(b){var c=this;ajaxReadFile("/palettes.json",function(a){c.palettes=JSON.parse(a);populatePalettes(c.palettes)},!1)}};
State.prototype.save=function(){if(fractal)try{localStorage["fractured.formulae"]=JSON.stringify(formula_list),localStorage["fractured.fractals"]=JSON.stringify(fractals),localStorage["fractured.palettes"]=JSON.stringify(palettes),fractal.thumb&&(this.active=fractal.toString(),this.thumbnail=fractal.thumb,this.fractal=document.getElementById("name").value,this.saveStatus())}catch(a){alert("error: "+a)}};
State.prototype.reset=function(a){if(a||confirm("This will clear everything!"))localStorage.clear(),this.load(),this.offline||listFilesInApplicationDataFolder(loadDriveFiles),loadPalette(0),newFractal(),this.formulae=this.session=0,this.fractal=null,fractals={},this.saveStatus()};
State.prototype.load=function(a){var b="/includes_"+this.version+".json",c=this;ajaxReadFile(b,function(d){if(d){sources=JSON.parse(d);if(c.debug&&(d=document.getElementById("debugedit")))for(key in removeChildren(d),sources)addMenuItem(d,key,"openEditor('"+key+"')");formula_list=null;(d=localStorage["fractured.formulae"])&&importFormulaList(d);formula_list||importFormulaList(readURL("/formulae_"+c.version+".json",!1));c.getPalettes();fractals=c.getFractals();c.fractal&&!fractals[c.fractal]&&(c.fractal=
null);populateFractals();populateScripts();d=/AppleWebKit/.test(navigator.userAgent);d=JSON.stringify(localStorage).length/(d?25E5:5E6);var f=document.getElementById("indicator");f&&(f.style.width=350*d+"px");a&&a()}else popup("<b><i>"+b+"</i></b> not found! Application may have been upgraded, "+c.upgrademsg)},!1)};
State.prototype.read=function(a){if("string"==typeof a)try{if(a=JSON.parse(a),!a)return}catch(b){alert("ImportState: Error! "+b);return}try{for(key in localStorage.clear(),a)localStorage[key]=a[key]}catch(c){alert("ImportParsedState: Error! "+c);return}this.saveStatus();listFilesInApplicationDataFolder(loadDriveFiles);this.load();progress()};State.prototype.toString=function(){this.save();this.clearStatus();var a=JSON.stringify(localStorage);this.saveStatus();return a};
State.prototype.lastFractal=function(){if(this.active)return fractal.load(this.active,!1,!0),document.getElementById("name").value=this.fractal,this.thumbnail?document.getElementById("lastimage").src=this.thumbnail:document.getElementById("lastimage").style.display="none",!0;loadPalette(0);fractal.updatePalette();return!1};
function recordStart(){state.recording=!0;state.server&&(state.controlMode(!0),state.drawMode(!1));1==fractal.width%2&&(fractal.width-=1);1==fractal.height%2&&(fractal.height-=1);fractal.ondraw=outputFrame;document.getElementById("recordOn").className="selected_item";document.getElementById("recordOff").className=""}
function recordStop(){if(state.server){state.controlMode(!1);state.recording=!1;var a=new XMLHttpRequest;a.open("GET",fractal.server.url+"/command=quit",!1);a.send(null);state.drawMode(!0)}else state.recording&&(ajaxReadFile("http://localhost:8080/end",frameDone),fractal.ondraw=null);document.getElementById("recordOn").className="";document.getElementById("recordOff").className="selected_item"}
function outputFrame(){if(state.server){var a=new XMLHttpRequest;a.open("POST",fractal.server.url+"/update",!1);a.send(fractal.server.data)}else{document.getElementById("fractal-canvas");var b=imageToBlob("image/jpeg",.95),c=new FormData;c.append("image",b);try{a=new XMLHttpRequest,a.open("POST","http://localhost:8080/frame?name="+labelToName(document.getElementById("name").value),!1),a.send(c)}catch(d){debug(d.message)}}frameDone()}
function frameDone(a){document.body.style.cursor="default";debug("Request sent")}function ParamVals(a){this.set=a;for(key in a)"object"==typeof a[key]&&void 0!=a[key].type&&(this[key]=a[key].value)}ParamVals.prototype.update=function(){for(key in this.set)"object"==typeof this.set[key]&&void 0!=this.set[key].type&&(this.set[key].value=this[key],this.set[key].copyToElement());fractal.copyToForm()};
function Script(a){this.step=this.count=1;this.step=Function(a);this.core=new ParamVals(fractal.choices.core.currentParams);this.fractal=new ParamVals(fractal.choices.fractal.currentParams);this.preTransform=new ParamVals(fractal.choices.pre_transform.currentParams);this.postTransform=new ParamVals(fractal.choices.post_transform.currentParams);this.insideColour=new ParamVals(fractal.choices.inside_colour.currentParams);this.outsideColour=new ParamVals(fractal.choices.outside_colour.currentParams);
this.filter=new ParamVals(fractal.choices.filter.currentParams)}Script.prototype.update=function(){this.core.update();this.fractal.update();this.preTransform.update();this.postTransform.update();this.insideColour.update();this.outsideColour.update();this.filter.update()};
function runScript(a){function b(){c.step();document.getElementById("steps").innerHTML=c.count+" / "+c.steps;fractal.applyChanges(null,!0);state.recording&&window.outputFrame();state.paused?(state.paused=c,document.getElementById("resume").disabled=!1,document.getElementById("pause").disabled=!0):c.count<c.steps?(c.count++,window.requestAnimationFrame?window.requestAnimationFrame(b):b()):(state.output=!0,d.print("Script"),document.getElementById("script_controls").style.display="none")}var c,d=new Timer;
if(a)c=new Script(localStorage[a]);else{if(!state.paused)return;c=state.paused}state.output=!1;state.paused=!1;document.getElementById("script_controls").style.display="block";document.getElementById("resume").disabled=!0;document.getElementById("pause").disabled=!1;b()}
var paramreg=/(\/\/(.*))?(?:\r\n|[\r\n])(@@?)(\w*)\s*=\s*(bool|int|real|complex|rgba|range|list|real_function|complex_function|bailout_function|expression|define)\(([\S\s]*?)\);/gi,boolreg=/(true|false)/i,rfreg=/(neg|inv|sqr|cube)/g,listreg=/["'](([^'"|]*\|?)*)["']/i,complexreg=/\(?([-+]?(\d*\.)?\d+([eE][+-]?\d+)?)\s*,\s*([-+]?(\d*\.)?\d+([eE][+-]?\d+)?)\)?/,realfunctions=" abs acos acosh asin asinh atan atanh cos cosh exp log log10 lnr neg inv sin sinh sqr cube sqrt tan tanh zero".split(" "),complexfunctions=
" abs acos cacos cacosh asin casin casinh atan catan catanh ceil conj cos ccos ccosh exp cexp flip floor log log10 neg inv round sin csin csinh sqr cube sqrt tan ctan ctanh trunc czero cln clog10 csqrt".split(" "),bailfunctions="arg cabs norm imag manhattan real".split(" ");function Complex(a,b){this.re="string"==typeof a?parseReal(a):a;this.im="string"==typeof b?parseReal(b):b}Complex.prototype.toString=function(){return"("+this.re+","+this.im+")"};
Complex.prototype.set=function(a){"string"==typeof a&&(a=parseComplex(a));this.re=a.re;this.im=a.im};function parseComplex(a){var b=complexreg.exec(a);return b&&b[1]&&b[4]?new Complex(parseReal(b[1]),parseReal(b[4])):new Complex(parseReal(a),0)}function parseReal(a,b){var c=parseFloat(a);return!isNaN(c)&&isFinite(c)?c:void 0==b?0:b}
function parseExpression(a){a+="";for(var b=/@?([_a-zA-Z][_a-zA-Z0-9]*)/g,c;c=b.exec(a);){var d=c[1],f=savevars[d];void 0==f&&(f=fractal_savevars[d]);void 0!=f&&(f+="",a=a.slice(0,b.lastIndex-c[0].length)+f+a.slice(b.lastIndex,a.length),b.lastIndex+=f.length-c[0].length)}a=a.replace(/\)\(/g,")*(");a=a.replace(/([-+]?\d*\.?\d+)\(/g,"$1*(");a=a.replace(/\)(@?[_a-zA-Z][_a-zA-Z0-9]*)/g,")*$1");a=a.replace(/([-+]?\d*\.?\d+)(@?[_a-zA-Z][_a-zA-Z0-9]*)\(/g,"$1*$2*(");a=a.replace(/([-+]?\d*\.?\d+)(@?[_a-zA-Z][_a-zA-Z0-9]*)/g,
"$1*$2");debug("expr: "+a);var g;parser.yy={};try{g=parser.parse(a+"")}catch(l){return alert('Error parsing expression: "'+a+'"\n : '+l.message),"(0,0)"}return g}function Param(a,b,c,d){this.type=b;this.label=c;this.touched=!1;this.parse(a);this.uniform=1==d}
Param.prototype.parse=function(a){switch(this.type){case "bool":this.typeid=-1;"boolean"==typeof a&&(this.value=a);"number"==typeof a&&(this.value=0!=a);"string"==typeof a&&(this.value=/^true$/i.test(a));break;case "int":this.typeid=0;this.step=1;"number"==typeof a&&(this.value=a|0);"string"==typeof a&&(this.value=parseInt(a));break;case "real":this.typeid=1;this.step="any";"number"==typeof a&&(this.value=a);"string"==typeof a&&(this.value=parseReal(a),isNaN(this.value)&&(this.value=parseComplex(a).re));
break;case "complex":this.typeid=2;this.step="any";"number"==typeof a&&(this.value=new Complex(a,0));"object"==typeof a&&(this.value=2==a.length?new Complex(a[0],a[1]):a);"string"==typeof a&&(this.value=parseComplex(a));break;case "real_function":this.typeid=4;this.value=a;this.functions=realfunctions;break;case "complex_function":this.typeid=4;this.value=a;this.functions=complexfunctions;break;case "bailout_function":this.typeid=4;this.value=a;this.functions=bailfunctions;break;case "list":this.typeid=
3;var b=listreg.exec(a);if(b){a=0;b=b[1].split("|");this.list={};for(var c=0;c<b.length;c++){var d=b[c].split("=");d[1]&&(a=parseInt(d[1]));this.list[d[0]]=a;a++}this.value=0}else this.value=a;break;case "rgba":this.typeid=5;0>a.indexOf("rgba")&&(a="rgba("+a+")");this.value=new Colour(a);break;case "expression":this.typeid=6;this.value=a;break;case "define":this.typeid=7;if(b=listreg.exec(a)){b=b[1].split("|");this.list=[];for(c=0;c<b.length;c++)this.list.push(b[c]);this.value=b[0]}else this.value=
a;break;case "range":this.typeid=8,b=a.split(","),this.value=0,this.step=.05,0<b.length&&(this.value=parseReal(b[0])),1<b.length&&(this.min=parseReal(b[1])),2<b.length&&(this.max=parseReal(b[2])),3<b.length&&(this.step=parseReal(b[3]))}};
Param.prototype.declare=function(a,b){var c=this.label?"//"+this.label+"\n":"",d="";a="@"+a;var f=this.type,d=!0,g=this.value;switch(this.typeid){case 3:f="int";case 0:65535<Math.abs(this.value)&&alert("Integer value out of range +/-65535");case -1:break;case 8:f="real";case 1:g=""+this.value;void 0==g.split(".")[1]&&0>g.indexOf("e")&&(g+=".0");break;case 2:g="C("+this.value.re+","+this.value.im+")";break;case 4:d=!1;g="real_function"==f&&rfreg.test(this.value)?"(args) _"+this.value+"((args))":"(args) "+
this.value+"(args)";break;case 5:g=this.value.rgbaGLSL();break;case 6:d=!1;g=" "+parseExpression(this.value);break;case 7:d=!1,g=" "+this.value}this.uniform?(d=f+" "+a,2==this.typeid?(d+=" = complex(params["+b.paramvars.length,b.paramvars.push(this.value.re),d+="],params["+b.paramvars.length+"]);\n",b.paramvars.push(this.value.im)):(d+=" = "+f+"(params["+b.paramvars.length+"]);\n",b.paramvars.push(this.value))):d=d?"const "+f+" "+a+" = "+g+";\n":"#define "+a+g+"\n";return c+d};
Param.prototype.setFromElement=function(){if(this.input)switch(this.typeid){case -1:this.value=this.input.checked;break;case 0:case 3:""==this.input.value&&(this.input.value=0);this.value=parseInt(this.input.value);break;case 1:case 8:this.value=parseReal(this.input.value);break;case 2:this.value.re=parseReal(this.input[0].value);this.value.im=parseReal(this.input[1].value);break;case 4:case 7:this.value=this.input.value.trim();break;case 6:this.value="TEXTAREA"==this.input.tagName?this.input.value.trim():
this.input.getValue();break;case 5:this.value=new Colour(this.input.style.backgroundColor)}};
Param.prototype.copyToElement=function(){if(this.input)switch(this.typeid){case -1:this.input.checked=this.value;break;case 0:case 1:case 3:case 4:case 7:case 8:this.input.value=this.value;break;case 2:this.input[0].value=this.value.re;this.input[1].value=this.value.im;break;case 6:"TEXTAREA"==this.input.tagName?this.input.value=this.value:this.input.setValue(this.value);break;case 5:this.input.style.backgroundColor=this.value.html()}};function ParameterSet(){}
ParameterSet.prototype.toString=function(){var a="";for(key in this)"object"==typeof this[key]&&(a+=key+"="+this[key].value+"\n");return a};ParameterSet.prototype.count=function(){var a=0;for(key in this)"object"==typeof this[key]&&a++;return a};ParameterSet.prototype.setFromForm=function(){for(key in this)"object"==typeof this[key]&&this[key].setFromElement()};
ParameterSet.prototype.toCode=function(a){var b="";savevars={};for(key in this)this[key].uniform?savevars[key]="@"+key:("real"==this[key].type&&(savevars[key]=this[key].value),"complex"==this[key].type&&(savevars[key]=0==this[key].value.im?this[key].value.re:this[key].value.toString()));for(key in this)"object"==typeof this[key]&&(b+=this[key].declare(key,a));return b};
ParameterSet.prototype.getField=function(a){a=document.getElementById(a);for(key in this)if("object"==typeof this[key]&&(this[key].input==a||"object"==typeof this[key].input&&(this[key].input[0]==a||this[key].input[1]==a)))return this[key];return null};ParameterSet.prototype.parseFormula=function(a){for(var b;b=paramreg.exec(a);)this[b[4]]=new Param(b[6],b[5],b[2]?b[2]:b[4],2==b[3].length)};
ParameterSet.prototype.restoreValues=function(a,b){if(a)for(key in this)if("object"==typeof this[key]){var c=this[key].value;a[key]&&(this[key].type==a[key].type?b[key]&&a[key].value==b[key].value||(this[key].value=a[key].value):debug("Parameter type changed: "+this[key].type+" != "+a[key].type+" -- "+key+", value discarded: "+a[key].value));b[key]?b[key].value=c:print("!No defaults entry for ["+key+"] to save value: "+c)}};
ParameterSet.prototype.createFields=function(a,b){switch(a){case "core":if(selectedTab!=document.getElementById("tab_params"))return;break;case "fractal":case "pre_transform":case "post_transform":if(selectedTab!=document.getElementById("tab_formula"))return;break;case "inside_colour":case "outside_colour":case "filter":if(selectedTab!=document.getElementById("tab_colour"))return}var c=document.getElementById(a+"_params"),d=document.createElement("div");d.className="parambox";var f="";if(sectionnames[a]){var g=
formulaKey(a,b);if(!formula_list[g]){alert("Formula does not exist!: "+a+" --\x3e "+b);return}var f=formula_list[g].label,l=document.createElement("span");l.className="parambox-label";l.innerHTML=sectionnames[a]+": <b>"+f+"</b>";d.appendChild(l)}c.appendChild(d);for(g in this)if("object"==typeof this[g]){l=document.createElement("div");l.className="row";c=this[g].label?this[g].label:g;f=document.createElement("label");f.appendChild(f.ownerDocument.createTextNode(c));c=document.createElement("span");
c.className="field";l.appendChild(f);l.appendChild(c);d.appendChild(l);this[g].input=null;var e,l=function(){fractal.applyChanges};switch(this[g].typeid){case -1:e=document.createElement("input");e.id=a+"_"+g;e.type="checkbox";e.checked=this[g].value;c.appendChild(e);f.setAttribute("for",a+"_"+g);break;case 0:case 1:l="setFormFieldStep(this); fractal.applyChanges();";case 8:e=document.createElement("input");e.id=a+"_"+g;e.value=this[g].value;c.appendChild(e);e.type="text";0==this[g].typeid&&(e.type=
"number");8==this[g].typeid&&(e.type="range",e.numval=document.createElement("span"),e.numval.innerHTML=parseReal(this[g].value).toFixed(2),e.setAttribute("onchange","this.numval.innerHTML = parseReal(this.value).toFixed(2); return true;"),c.appendChild(e.numval));this[g].min&&(e.min=this[g].min);this[g].max&&(e.max=this[g].max);this[g].step&&(e.step=this[g].step);break;case 2:e=[null,null];e[0]=document.createElement("input");e[0].type="text";e[0].id=a+"_"+g+"_0";e[0].step=this[g].step;e[0].value=
this[g].value.re;c.appendChild(e[0]);e[1]=document.createElement("input");e[1].type="text";e[1].id=a+"_"+g+"_1";e[1].step=this[g].step;e[1].value=this[g].value.im;c.appendChild(e[1]);break;case 3:e=document.createElement("select");for(k in this[g].list)e.options[e.options.length]=new Option(k,this[g].list[k]);e.value=this[g].value;c.appendChild(e);break;case 4:e=document.createElement("select");for(f=0;f<this[g].functions.length;f++)e.options[e.options.length]=new Option(this[g].functions[f],this[g].functions[f]);
e.value=this[g].value;c.appendChild(e);break;case 5:e=document.createElement("div");e.className="colourbg checkerboard";f=document.createElement("div");f.className="colour";f.style.backgroundColor=this[g].value.html();e.appendChild(f);c.appendChild(e);e=f;break;case 6:"function"==typeof CodeMirror?(e=CodeMirror(c,{value:this[g].value,mode:"x-shader/x-fragment",theme:"fracturedlight",matchBrackets:!0,lineWrapping:!0,extraKeys:{Tab:!1}}),e.on("blur",l),e.on("blur",handleFormChange)):(e=document.createElement("textarea"),
e.value=this[g].value,e.setAttribute("spellcheck",!1),c.appendChild(e));break;case 7:e=document.createElement("select");for(k in this[g].list)e.options[e.options.length]=new Option(this[g].list[k]);e.value=this[g].value;c.appendChild(e)}2==this[g].typeid?(e[0].setAttribute("onchange",l),e[1].setAttribute("onchange",l)):e.setAttribute&&e.setAttribute("onchange",l);this[g].input=e}g=document.createElement("div");g.className="clear gap";d.appendChild(g)};var selected={};
function FormulaEntry(a,b,c,d){void 0==d&&(d=labelToName(b));for(var f=0,g=d;void 0!=formula_list[a+"/"+d];)f++,d=g+"_("+f+")";d!=g&&(b=b+" ("+f+")");c||(c="core"==a?formula_list["core/default"].source:"fractal"==a?formula_list["fractal/mandelbrot"].source:"transform"==a?formula_list["transform/functions"].source:formula_list["colour/default"].source);this.type=a;this.name=d;this.label=b;this.source=c;a=a+"/"+d;formula_list[a]=this;addSelectEntry(formula_list[a])}
FormulaEntry.prototype.toString=function(){return"["+this.type+"/"+this.name+"] = "+this.source};FormulaEntry.prototype.equals=function(a){function b(a){a=a.replace(/\/\*([\s\S]*?)\*\/|(\/\/.*)/g,"");a=a.replace(/(\r\n|\n|\r)/gm,"");a=a.replace(/complex\(/g,"C(");return a=a.replace(/real\(/g,"R(")}return b(this.source)==b(a)};
function importFormulaList(a){formula_list={};document.getElementById("core_formula").options.length=0;document.getElementById("fractal_formula").options.length=0;document.getElementById("pre_transform_formula").options.length=0;document.getElementById("post_transform_formula").options.length=0;document.getElementById("outside_colour_formula").options.length=0;document.getElementById("inside_colour_formula").options.length=0;document.getElementById("filter_formula").options.length=0;addToSelect("pre_transform",
"none","");addToSelect("post_transform","none","");addToSelect("outside_colour","none","");addToSelect("inside_colour","none","");addToSelect("filter","none","");new FormulaEntry("colour","As Above","\ncalc:\nif (i==limit-1) escaped = true;\n","same");try{var b=JSON.parse(a);if(!b["core/default"]){var c=JSON.parse(readURL("/formulae_"+state.version+".json",!1));b["core/default"]=c["core/default"]}for(key in b)"same"!=b[key].name&&new FormulaEntry(b[key].type,b[key].label,b[key].source,b[key].name)}catch(d){alert("ImportFormulaList error: "+
d),formula_list=null}document.getElementById("core_formula").value=selected.core||document.getElementById("core_formula").options[0].value;document.getElementById("fractal_formula").value=selected.fractal||document.getElementById("fractal_formula").options[0].value;document.getElementById("pre_transform_formula").value=selected.pre_transform||"none";document.getElementById("post_transform_formula").value=selected.post_transform||"none";document.getElementById("outside_colour_formula").value=selected.outside_colour||
document.getElementById("outside_colour_formula").options[1].value;document.getElementById("inside_colour_formula").value=selected.inside_colour||"none";document.getElementById("filter_formula").value=selected.filter||"none"}
function addSelectEntry(a){-1<a.type.indexOf("colour")?("same"!=a.name&&(a.field=addToSelect("outside_colour",a.name,a.label)),a.field=addToSelect("inside_colour",a.name,a.label)):-1<a.type.indexOf("transform")?(a.field=addToSelect("pre_transform",a.name,a.label),a.field=addToSelect("post_transform",a.name,a.label)):a.field=addToSelect(a.type,a.name,a.label)}function addToSelect(a,b,c){select=document.getElementById(a+"_formula");if(!select)return null;a=new Option(c,b);select.add(a);return a}
function saveSelections(){var a="core fractal pre_transform post_transform outside_colour inside_colour filter".split(" ");selected={};for(s in a){var b=document.getElementById(a[s]+"_formula");0>b.selectedIndex&&(b.selectedIndex=0);selected[a[s]]=b.options[b.selectedIndex].value}}function categoryToType(a){var b=a;-1<a.indexOf("colour")&&(b="colour");-1<a.indexOf("transform")&&(b="transform");return b}function labelToName(a){return a.replace(/[^\w()]+/g,"_").toLowerCase()}
function formulaFilename(a,b){return"formulae/"+labelToName(b)+"."+categoryToType(a)+".formula"}function formulaKey(a,b,c){a=categoryToType(a)+"/"+labelToName(b);return c&&!formula_list[a]?null:a}function nameToLabel(a){return a.replace(/\w\S*/g,function(a){return a.charAt(0).toUpperCase()+a.substr(1).toLowerCase()}).replace(/_/g," ")}
function filenameToName(a){var b=a.lastIndexOf("/")+1,c=a.indexOf("."),d=a.lastIndexOf(".");0>b&&(b=0);0>c&&(c=a.length);var f="";d>c&&(f=a.substr(c+1,d-c-1));return[a.substr(b,c),f]}
function FormulaSelection(a){this.category=a;this.params={};this.defaultparams={};this.lineoffsets={};(this.sel=document.getElementById(this.category+"_formula"))?this.reselect():(this.sel=document.createElement("select"),this.sel.style="display: none",this.sel.id=this.category+"_formula",document.body.appendChild(this.sel),addToSelect(a,"none",""),this.select("none"))}FormulaSelection.prototype.exists=function(a){this.sel.value=a;return this.sel.value==a};
FormulaSelection.prototype.reselect=function(a){var b="default";if(this.sel){void 0!=a&&(this.sel.selectedIndex=a);if(0>this.sel.selectedIndex){alert(this.category+" : Invalid selection! "+a);return}b=this.sel.options[this.sel.selectedIndex].value}this.select(b)};
FormulaSelection.prototype.select=function(a){a?this.selected=a:a=this.selected;var b=document.getElementById(this.category+"_params");b&&removeChildren(b);var c=this.params[a];this.params[a]=new ParameterSet;this.currentParams=this.params[a];var d=this.getSource();0<d.length&&(this.defaultparams[a]||(this.defaultparams[a]=new ParameterSet,this.defaultparams[a].parseFormula(d)),this.params[a].parseFormula(d),this.params[a].restoreValues(c,this.defaultparams[a]),b&&this.params[a].createFields(this.category,
a))};FormulaSelection.prototype.getkey=function(){return formulaKey(this.category,this.selected)};FormulaSelection.prototype.getSource=function(){if("none"==this.selected)return"";var a=this.getkey();if(!a)return"";if(formula_list[a]){var b=formula_list[a].source,b=b.replace("loge","ln");b!=formula_list[a].source&&(formula_list[a].source=b,alert("LOGE=>LN\n"+b));return formula_list[a].source}print("Formula Missing! No entry found for: "+a);return""};
FormulaSelection.prototype.getCodeSections=function(){var a=this.getSource(),b="data",c={main:"",init:"",reset:"",znext:"",escaped:"",converged:"",calc:"",result:"",transform:"",filter:""},d,f=0,g=/^([a-z]+):/gm;for(this.lineoffsets={};d=g.exec(a);)c[b]=a.slice(f,g.lastIndex-d[0].length-1),this.lineoffsets[b]=a.slice(0,f).split("\n").length+1,f=g.lastIndex,b=d[1];c[b]=a.slice(f);this.lineoffsets[b]=a.slice(0,f).split("\n").length+1;"fractal"==this.category&&(0==c.znext.length&&(c.znext=this.currentParams.znext?
"\n  z = @znext;\n":"\n  z = sqr(z)+c;\n"),a=!0,0==c.converged.length&&(this.currentParams.converged?c.converged+="\nconverged = (@converged);\n":this.currentParams.converge?c.converged+="\nconverged = (@bailtest(z) < @converge);\n":a=!1),0==c.escaped.length&&(this.currentParams.escaped?c.escaped+="\nescaped = (@escaped);\n":this.currentParams.escape?c.escaped+="\nescaped = (@bailtest(z) > @escape);\n":a||(c.escaped+="\nescaped = (@bailtest(z) > escape);\n")),this.currentParams.escape||(c.data+="\n#define escape 4.0\n"),
this.currentParams.bailtest||(c.data+="\n#define @bailtest norm\n"));return c};
FormulaSelection.prototype.getParsedFormula=function(a){for(var b=this.getCodeSections(),c=b.data,d,f=-1,g=0;d=paramreg.exec(c);)0>f&&(f=paramreg.lastIndex-d[0].length),g=paramreg.lastIndex;a=this.currentParams.toCode(a);"fractal"==this.category&&(fractal_savevars=savevars);f=0<=f?c.slice(0,f):"";c=c.slice(g,c.length);c=f+a.slice(0,a.length-1)+c;b.data=c.replace(/:([a-zA-Z_])/g,"$1");for(key in b)b[key]=this.parseExpressions(b[key]),b[key]=b[key].replace(/@([a-zA-Z_])/g,this.category+"_$1");return b};
FormulaSelection.prototype.parseExpressions=function(a){for(var b=/\\([\s\S]*?)\\/gm,c;c=b.exec(a);){var d=a.slice(0,b.lastIndex-c[0].length),f=parseExpression(c[1]);a=d+f+a.slice(b.lastIndex,a.length);b.lastIndex+=f-c[0].length}return a};var state,sources,fractal,colours,fractals,palettes,rztimeout,googleSignIn=!1;
function onSignIn(a){var b=a.getBasicProfile();console.log("ID: "+b.getId());console.log("Name: "+b.getName());console.log("Image URL: "+b.getImageUrl());console.log("Email: "+b.getEmail());(googleSignIn=a.getAuthResponse())?state&&sessionGet():alert("Login failed!")}function onFailure(a){console.log("Fail: "+a);print("Offline!");state.offline=!0}function signOut(){gapi.auth2.getAuthInstance().signOut().then(function(){console.log("User signed out.");window.location.reload()})}
function loadDriveFiles(a){if(a&&0!=a.length&&null!=a[0])try{a.sort(function(a,b){return a.title>b.title?-1:1});var b=document.getElementById("sessions"),c=document.getElementById("formulae-private");if(b&&c){removeChildren(b);removeChildren(c);for(var d=0;d<a.length;d++){console.log(a[d].title);var f=a[d].downloadUrl,f=f.replace(/content.googleapis/g,"www.googleapis"),g=a[d].title.substr(0,a[d].title.lastIndexOf("."));if("session"==a[d].fileExtension){var l=addMenuItem(b,g,"menu(); loadDriveSession('"+
f+"', '"+a[d].id+"')",null,!0);state.session==a[d].id&&selectMenuItem(l,"deleteSelectedState();")}else"formulae"==a[d].fileExtension&&(l=addMenuItem(c,g,"menu(); loadDriveFormulaSet('"+f+"', '"+a[d].id+"', this)"),state.formulae==a[d].id&&selectMenuItem(l,"deleteSelectedFormulae();"))}checkMenuHasItems(b);checkMenuHasItems(c)}}catch(e){alert("LoadFilesList: Error! "+e)}}
function loadDriveSession(a,b){confirm("Loading new session. This will overwrite everything!")&&(state.session=b,state.saveStatus(),ajaxReadFile(a,function(a){console.log(a);state.read(a)},!1,updateProgress,{Authorization:"Bearer "+googleSignIn.access_token}),progress("Downloading session from Google Drive..."))}
function loadDriveFormulaSet(a,b,c){confirm("Loading new formula set. This will overwrite currently loaded formulae!")&&(deselectAllMenuItems(document.getElementById("formulae-private"),!0),deselectAllMenuItems(document.getElementById("formulae-public"),!0),state.formulae=b,selectMenuItem(c,"deleteSelectedFormulae();"),state.saveStatus(),ajaxReadFile(a,importFormulae,!1,updateProgress,{Authorization:"Bearer "+googleSignIn.access_token}))}
function uploadDriveFile(a,b,c){console.log("Uploading: "+b);var d="POST",f="";b||(d="PUT",f="/"+state.session);var g={mimeType:"application/octet-stream",parents:[{id:"appfolder"}]};b&&(g.title=b);a=btoa(a);g="\r\n---------314159265358979323846\r\nContent-Type: application/json\r\n\r\n"+JSON.stringify(g)+"\r\n---------314159265358979323846\r\nContent-Type: application/octet-stream\r\nContent-Transfer-Encoding: base64\r\n\r\n"+a+"\r\n---------314159265358979323846--";gapi.client.request({path:"/upload/drive/v2/files"+
f,method:d,params:{uploadType:"multipart"},headers:{"Content-Type":'multipart/mixed; boundary="-------314159265358979323846"'},body:g}).execute(c)}function deleteDriveFile(a,b){gapi.client.drive.files["delete"]({fileId:a}).execute(b)}
function listFilesInApplicationDataFolder(a){if(!state.offline){console.log("LISTFILESINAPPDATAFOLDER");var b=function(c,f){c.execute(function(g){f=f.concat(g.items);(g=g.nextPageToken)?(c=gapi.client.drive.files.list({pageToken:g}),b(c,f)):a(f)})},c=gapi.client.drive.files.list({q:"'appfolder' in parents"});b(c,[])}}var activeMenu=null,activeSubMenu=null;
function menu(a,b){if(a)for(var c=a.parentNode.childNodes,d=0;d<c.length;d++){if("UL"==c[d].tagName){c=c[d].style;!b&&activeMenu&&activeMenu!=c&&(activeMenu.display="none");activeSubMenu&&activeSubMenu!=c&&(activeSubMenu.display="none");"block"!=c.display?(c.display="block",1==b?activeSubMenu=c:activeMenu=c):(c.display="none",1==b?activeSubMenu=null:activeMenu=null);break}}else activeMenu&&(activeMenu.display="none"),activeSubMenu&&(activeSubMenu.display="none"),document.getElementById("nav").style.display=
""}function mainmenu(){"block"!=document.getElementById("nav").style.display?document.getElementById("nav").style.display="block":(document.getElementById("nav").style.display="none",menu())}var loadAction;
function appInit(){try{state=new State("0.92")}catch(a){popup(a);return}0==window.location.href.indexOf("file://")&&(state.offline=!0);0<=window.location.href.indexOf("localhost:")&&(state.offline=!0);navigator.onLine||(state.offline=!0);var b=getQuery();window.history.replaceState("","",state.baseurl);loadAction=parseQuery(b);colours=new GradientEditor(document.getElementById("palette"),function(){fractal&&fractal.applyChanges()},!0);fractal=new Fractal("main",colours,!0,!0);state.offline||(ajaxReadFile("ss/formula_get.php",
loadFormulaeList,!1),sessionGet());state.load(appInitState)}
function appInitState(){fractal.init(state);document.onkeydown=handleKey;window.onresize=autoResize;window.onfullscreenchange=toggleFullscreen;window.onbeforeunload=beforeUnload;window.onpopstate=historyStateChange;var a=["param_inputs","fractal_inputs","colour_inputs"],b;for(b in a){var c=document.getElementById(a[b]);c.addEventListener("onwheel"in document?"wheel":"mousewheel",handleFormMouseWheel,!1);c.onchange=handleFormChange;c.onkeyup=handleFormKeyUp}setAntiAliasMenu();a=state.lastFractal();
loadAction&&loadAction.length&&0>loadAction.indexOf(".html")&&(30<loadAction.length?restoreFractal(loadAction):loadUrl(loadAction));showPanel("info");0==state.mode&&showGallery(location.hash);loadScript("/codemirror_0.92.js","");showCard("new_version_0.92");a&&showCard("previous_fractal");showCard("local_storage");showCard("render_mode");document.getElementById("webgl").disabled?showCard("no_webgl"):showCard("webgl_detected");showCard("mouse_reference");showCard("user_guide");showCard("contact_form");
showCard("parameters_help");showCard("formula_help");showCard("colour_help")}
function getQuery(){var a=decodeURI(window.location.href),b=a.indexOf("#");0<b&&(a=a.substring(0,b));b="";if(0<a.indexOf("?"))a=a.split("?"),b=a[1],"/"==b.charAt(b.length-1)&&(b=b.substr(0,b.length-1)),state.baseurl=a[0];else if(0==a.indexOf("file:///"))state.baseurl=a;else{var c=a.lastIndexOf("/"),b=a.substr(c+1);state.baseurl=a.substr(0,c)}b||!location.hash||document.getElementById(location.hash)||(b=location.hash.substr(1));return b}
function parseQuery(a,b){var c;if(a)for(var d=a.split("&"),f=0;f<d.length;f++)if(0<=d[f].indexOf("debug"))state.debugOn(),state.saveStatus();else if(0<=d[f].indexOf("server"))if(1<d[f].length){var g=d[f].substr(d[f].indexOf("=")+1);state.server="http://"+g+":8080";state.control=!0;state.controlMode(!0)}else state.server="http://"+window.location.hostname+":8080";else if(0<=d[f].indexOf("reset"))state.resetFormulae();else if(20<d[f].length)try{c=window.atob(d[f])}catch(l){print(l)}else!state.offline&&
3<d[f].length&&(c=d[f]);debug("Base URL: "+state.baseurl);debug("Query options: "+a);return c}function historyStateChange(a){a.state?(a=window.atob(a.state),debug("Restoring State: "+a.length),a&&restoreFractal(a)):(debug("Restore State... "+location.hash),0<="#examples #shared #myshared #myuploads #images #myimages".split(" ").indexOf(location.hash)?showGallery(location.hash):location.hash?loadUrl(location.hash.substr(1)):showGallery())}
function snapshot(){var a=new Blob([document.documentElement.outerHTML],{type:"text/plain"});window.open(window.URL.createObjectURL(a))}function resetReload(){history.pushState("",document.title,location.pathname+"?reset");location.reload(!0)}function loadUrl(a){state.offline||0<=a.indexOf(".html")||(state.locator=a,fractal.clear(),progress("Loading fractal..."),ajaxReadFile("ss/fractal_get.php?id="+state.locator,restoreFractal,!1))}
function loadScript(a,b){var c=document.getElementsByTagName("head")[0],d=document.createElement("script");d.type="text/javascript";d.src=a;d.setAttribute("onload",b);c.appendChild(d)}function handleKey(a){switch(a.keyCode){case 13:handleFormEnter(a);break;case 27:case 192:fractal.togglePreview()}}
function sendEmail(){var a=new FormData;a.append("email",document.getElementById("email").value);a.append("subject","[http://fract.ured.me contact form]");a.append("message",document.getElementById("message_body").value);progress("Sending email...");ajaxPost("ss/email.php",a,progressDone,updateProgress)}
function loadHelp(){ajaxReadFile("docs.html",function(a){var b=document.createElement("div");b.innerHTML=a;a=b.getElementsByTagName("div");0<a.length&&(document.getElementById("help").innerHTML=a[0].innerHTML)})}function switchGallery(a){1==a||0!=a&&0!=state.mode?showGallery():(hideGallery(),fractal.applyChanges())}
function showGallery(a){a?state.offset=0:a=state.gallery?state.gallery:"#examples";state.gallery&&(document.getElementById(state.gallery).className="",document.getElementById("about"+state.gallery).style.display="none");document.getElementById(a).className="selected";document.getElementById("about"+a).style.display="block";state.gallery=a;state.mode=0;loadGallery()}
function loadGallery(a){document.getElementById("gallery").style.display="block";document.documentElement.style.overflow="hidden";setAll("none","render");void 0==a&&(a=state.offset);var b=document.getElementById("gallery").clientWidth,c=document.getElementById("gallery").clientHeight;state.offline||(type=state.gallery.substr(1),ajaxReadFile("ss/images.php?type="+type+"&offset="+a+"&width="+b+"&height="+c,fillGallery,!1),state.offset=a)}
function fillGallery(a){document.getElementById("gallery-display").innerHTML=a}function hideGallery(){console.log("STATE LOGGED IN : "+state.loggedin);document.getElementById("gallery").style.display="none";setAll("block","render");setAll(state.loggedin?"block":"none","loggedin");state.mode=1;document.inputs.elements.autosize.checked||(document.documentElement.style.overflow="auto")}
function showCard(a){if(state.cards[a]){var b=document.getElementById("manage_info");b.style.display="block";var c=document.createElement("input");c.id=key+"_enable";c.type="button";c.setAttribute("onclick",'toggleCard("'+a+'"); this.parentNode.removeChild(this);');c.style.display="block";c.value=a.replace(/[_#]/g," ");c.value=c.value.replace(/\w\S*/g,function(a){return a.charAt(0).toUpperCase()+a.substr(1).toLowerCase()});b.appendChild(c)}else toggleCard(a,!0)}
function toggleCard(a,b){var c;(c="string"==typeof a?document.getElementById(a):a.parentNode)?(c.style.display=c.style.display&&"none"!=c.style.display?"none":"block",state.cards[c.id]="none"==c.style.display,state.cards[c.id]&&showCard(c.id),b||state.saveStatus()):alert("Element "+a+" not found ")}
function sessionGet(a){state.offline||(gapi.client.load("drive","v2",function(){console.log("Drive Client Loaded");if(googleSignIn){document.getElementById("session_user_menu");var a=document.getElementById("session_login_menu");state.loggedin=!0;a.style.display="none";setAll("block","loggedin");setAll("none","loggedout");listFilesInApplicationDataFolder(loadDriveFiles)}}),console.log("SESSIONGET: DECPRECATED!"))}
function restoreFractal(a){var b=a.split("\n");a=b[0];b.splice(0,1);b=b.join("\n");state.output=!1;"[Palette]"==a?(state.lastFractal(),colours.read(b)):(state.active=b,state.fractal=a,state.lastFractal());fractal.applyChanges();state.output=!0;location.hash&&fractal.saveState(!0);progress();hideGallery()}function setAntiAlias(a){a||(a=prompt("Enter quality (1-8) Higher values may be very slow!"));a&&0<a&&8>=a&&(state.antialias=a,state.saveStatus(),setAntiAliasMenu(),fractal.draw())}
function setAntiAliasMenu(){state.antialias||(state.antialias=1);document.getElementById("aa1").className=1==state.antialias?"selected_item":"";document.getElementById("aa2").className=2==state.antialias?"selected_item":"";document.getElementById("aa3").className=3==state.antialias?"selected_item":"";document.getElementById("aa4").className=3<state.antialias?"selected_item":""}function setDelayTimer(){var a=prompt("Enter timer delay in milliseconds",state.timers);null!=a&&(state.timers=a)}
function addMenuItem(a,b,c,d,f){var g=document.createElement("li"),l=document.createElement("span");l.setAttribute("onclick",c);l.appendChild(l.ownerDocument.createTextNode(b));d&&l.appendChild(d);g.appendChild(l);f?a.insertBefore(g,a.firstChild):a.appendChild(g);return l}function addMenuDelete(a,b){var c=document.createElement("input");c.type="button";c.value=" X ";c.className="right";c.setAttribute("onclick",b+"; event.stopPropagation();");a.appendChild(c)}
function selectMenuItem(a,b){b&&addMenuDelete(a,b);a.parentNode.className="selected_item"}function deselectAllMenuItems(a,b){if(a)for(var c=0;c<a.childNodes.length;c++)deselectMenuItem(a.childNodes[c].firstChild,b)}function deselectMenuItem(a,b){if(a){if(b)for(var c=a.childNodes,d=0;d<c.length;d++)"button"==c[d].type&&a.removeChild(c[d]);a.parentNode.className=""}}
function checkMenuHasItems(a){if(!a.hasChildNodes()){var b=document.createElement("li");b.appendChild(b.ownerDocument.createTextNode("(empty)"));a.appendChild(b)}}function setAll(a,b){for(var c=document.getElementsByClassName(b),d=0;d<c.length;d++)c[d].style.display=a}function fractalMenuThumb(a){if(fractals[a].thumbnail){var b=new Image;b.src=fractals[a].thumbnail;b.className="thumb";return b}return null}
function fractalMenuUpdate(a){var b=fractalMenuThumb(a);a=document.getElementById(fractals[a].id);b&&1<a.childNodes.length&&a.replaceChild(b,a.childNodes[1])}var next_id=0;function fractalMenuAdd(a){var b=document.getElementById("fractals"),c=fractalMenuThumb(a),d=a.replace("'","\\'"),b=addMenuItem(b,a.substr(0,18),"selectedFractal('"+d+"')",c,!0);state.fractal==a&&selectMenuItem(b,"deleteFractal('"+d+"');");b.id="fractalmenu_"+next_id;fractals[a].id=b.id;next_id++}
function fractalMenuSelect(a){state.fractal&&fractals[state.fractal]&&deselectMenuItem(document.getElementById(fractals[state.fractal].id),!0);state.fractal=a;state.saveStatus();a&&selectMenuItem(document.getElementById(fractals[a].id),"deleteFractal('"+a+"');")}function fractalMenuDelete(a){document.getElementById("fractals").removeChild(document.getElementById(fractals[a].id).parentNode)}
function deleteFractal(a){if((a=a.replace("\\'","'"))&&confirm('Really delete the fractal: "'+a+'"'))try{fractalMenuDelete(a),fractalMenuSelect(),delete fractals[a]}catch(b){alert("Storage delete error! "+b)}}
function performTask(a,b,c){function d(){for(var e=Math.min(f+b,a),h=f;h<e;h++)c(g[h]);f+=b;setProgress(f/a*100);f<a?setTimeout(d,10):(progress(),e=(new Date).getTime()-state.timer,state.output=!0,print("Generate thumbnails took: "+e/1E3+" seconds"),populateFractals(),state.lastFractal(),hideGallery(),fractal.applyChanges())}var f=0,g=[],l;for(l in fractals)g[f]=fractals[l],f++;f=0;progress("Generating thumbnails...");d()}
function regenerateThumbs(){hideGallery();state.save();state.output=!1;var a=Object.keys(fractals).length;state.timer=(new Date).getTime();var b=Math.ceil(a/25);performTask(a,b,function(a){fractal.load(a.source,!1,!0);document.getElementById("width").value=document.getElementById("height").value=32;document.inputs.elements.autosize.checked=!1;fractal.applyChanges(4,!0);var b=document.getElementById("main-fractal-canvas").toDataURL("image/jpeg",.75);a.thumbnail=b})}
function populateFractals(){next_id=0;var a=document.getElementById("fractals");if(a){removeChildren(a);for(var b in fractals)fractalMenuAdd(b)}}function selectedFractal(a){a=a.replace("\\'","'");hideGallery();fractalMenuSelect(a);fractal.name=a;fractal.load(fractals[a].source,!0);fractals[a].thumbnail||(fractals[a].thumbnail=thumbnail())}
function newFractal(){hideGallery();fractal.name="unnamed";fractal.resetDefaults();fractal.formulaDefaults();fractal.copyToForm();fractalMenuSelect();fractal.applyChanges()}
function storeFractal(){if(state.fractal){var a=state.fractal;if(a==fractal.name&&fractals[a]&&confirm('Overwrite "'+a+'"?')){try{fractals[a].source=fractal.toStringNoFormulae(),fractals[a].thumbnail=thumbnail(),fractalMenuUpdate(a)}catch(b){alert("error! "+b)}return}}(a=fractal.name)||(a="unnamed");for(var c=0,d=a;fractals[d];)d=a+ ++c;if(a==d||confirm('Save as "'+d+'"?')){a=fractal.name=d;try{fractals[a]=new FractalEntry(fractal.toStringNoFormulae()),fractalMenuAdd(a),fractalMenuSelect(a)}catch(f){alert("error! "+
f)}}}function FractalEntry(a,b){this.source=a;this.thumbnail=b?b:thumbnail()}function PaletteEntry(a,b){this.data=a;this.thumb=b}function savePalette(){source=colours.palette+"";palettes.push(new PaletteEntry(source,paletteThumbnail()));populatePalettes()}
function populatePalettes(a){a&&(palettes=a);if(a=document.getElementById("palettes")){removeChildren(a);for(var b=0;b<palettes.length;b++){palettes[b].thumb||(colours.read(palettes[b].data),colours.update(!0),palettes[b].thumb=paletteThumbnail());var c=new Image;c.src=palettes[b].thumb;c=addMenuItem(a,"","loadPalette("+b+"); fractal.applyChanges();",c,!1);addMenuDelete(c,"deletePalette("+b+");")}checkMenuHasItems(a)}}
function loadPalette(a){palettes&&palettes[a]?colours.read(palettes[a].data):colours.read("Background=rgba(0,0,0,0)\n0.0=rgba(0,0,0,1)\n0.5=rgba(255,255,255,1)\n1.0=rgba(0,0,0,1)\n")}function deletePalette(a){palettes.splice(a,1);populatePalettes()}function packPalette(){var a=window.btoa("[Palette]\n"+colours.palette.toString());packURL(a)}
function populateScripts(){var a=document.getElementById("scripts");if(a){removeChildren(a);for(var b in localStorage)if(0==b.indexOf("scripts/")){var c=addMenuItem(a,b.substr(8),"menu(); editScript('"+b+"');");addMenuDelete(c,"delete localStorage['"+b+"']; populateScripts();")}checkMenuHasItems(a)}}function editScript(a){if(!a){a=prompt("Enter script name:");if(!a)return;0>a.indexOf(".js")&&(a+=".js");a="scripts/"+a;localStorage[a]="";populateScripts()}openEditor(a)}
function thumbnail(a,b,c){void 0==a&&(a="jpeg");void 0==c&&"jpeg"==a&&(c=75);void 0==b&&(b=32);var d=document.getElementById("main-fractal-canvas");if(fractal.renderer!=SERVER){var f=fractal.height,g=fractal.width;fractal.width=fractal.height=b;fractal.draw(4,!0);b=d.toDataURL("image/"+a,c);fractal.width=g;fractal.height=f;fractal.draw()}else f=document.getElementById("thumb"),f.style.visibility="visible",g=f.getContext("2d"),f.width=f.height=b,d.width>d.height?f.height=d.height/d.width*b:d.height>
d.width&&(f.width=d.width/d.height*b),g.drawImage(d,0,0,f.width,f.height),b=f.toDataURL("image/jpeg"),f.style.visibility="hidden";return b}
function thumbnailQuick(a,b,c,d){void 0==a&&(a="jpeg");void 0==d&&"jpeg"==a&&(d=75);var f=document.getElementById("main-fractal-canvas");if(1>f.clientWidth&&1>f.clientHeight)return"";b||(b=32);c||(c=b/f.clientWidth*f.clientHeight);var g=document.createElement("canvas");g.width=b;g.height=c;g.style.visibility="visible";g.getContext("2d").drawImage(f,0,0,g.width,g.height);return g.toDataURL("image/"+a,d)}
function paletteThumbnail(){var a=document.createElement("canvas");a.width=150;a.height=1;colours.get(a);return a.toDataURL("image/png")}function uploadState(){var a=state.toString();if(0!=state.session&&confirm("Save changes to this session on server?"))uploadDriveFile(a);else{var b=prompt("Enter description for new session");b&&0!=b.length&&uploadDriveFile(a,b+".session",function(a){state.session=a.id;listFilesInApplicationDataFolder(loadDriveFiles);console.log(a)})}}
function sessionSaved(a){state.session=a;state.saveStatus();listFilesInApplicationDataFolder(loadDriveFiles);progress()}
function uploadFractalFile(a){var b=new FormData;b.append("type",0);state.locator&&confirm("Overwrite existing fractal on server? (Only works if you created the original)")&&b.append("locator",state.locator);void 0==a&&(a=confirm("Share this fractal publicly after uploading?"));b.append("public",Number(a));b.append("description",fractal.name);b.append("thumbnail",thumbnail("jpeg",150).substring(23));b.append("source",fractal.toString());progress("Uploading fractal to server...");ajaxPost("ss/fractal_save.php",
b,fractalUploaded,updateProgress)}function fractalUploaded(a){0>a.indexOf("http")?(alert(a),progress()):progressDone(a,a)}function packFractal(){var a=window.btoa(fractal.name+"\n"+fractal.toString());packURL(a)}function packURL(a){var b=state.baseurl+"?"+a;a=document.createElement("a");a.setAttribute("href",b);b=document.createTextNode("here it is");a.appendChild(b);popup("Copy this link:<br><br>");document.getElementById("popupmessage").appendChild(a)}
function uploadFormulaSet(a){var b=new FormData;b.append("public",a);if(0<state.formulae&&confirm("Save changes to this formula set on server?"))b.append("formulae",state.formulae);else{a=prompt("Enter name for new formula set");if(null==a)return;b.append("name",a)}b.append("data",JSON.stringify(formula_list));progress("Uploading formulae to server...");ajaxPost("ss/formula_save.php",b,formulaeSaved,updateProgress)}
function formulaeSaved(a){var b=parseInt(a);0<b?(state.formulae=b,state.saveStatus()):alert("Formula save error: "+a);loadFormulaeList(readURL("ss/formula_get.php"));progress()}function exportStateFile(){location.href="data:text/fractal-workspace;base64,"+window.btoa(state.toString())}function exportFractalFile(){source=fractal.toString();exportFile(fractal.name+".fractal","text/fractal-source",source)}
function exportFormulaFile(a,b,c){0>a.indexOf(".")&&(a=filenameToName(a)[0]+"."+categoryToType(b)+".formula");exportFile(a,"text/fractal-formula",c)}function exportFormulaSet(){exportFile("fractured.formulae","text/fractal-formulae",JSON.stringify(formula_list))}function exportPaletteFile(){source=colours.palette+"";exportFile(fractal.name+".palette","text/palette",source)}
function exportImage(a,b){try{if(window.URL){var c=imageToBlob(a,b);if(window.navigator&&window.navigator.msSaveOrOpenBlob)window.navigator.msSaveOrOpenBlob(c);else{var d=encodeURI(window.URL.createObjectURL(c));window.open(d)}}}catch(f){window.open(document.getElementById("main-fractal-canvas").toDataURL(a,b))}}
function exportFile(a,b,c){state.offline?location.href="data:"+b+";base64,"+window.btoa(c):(document.getElementById("export-filename").setAttribute("value",a),document.getElementById("export-content").setAttribute("value",b),a=document.createElement("input"),a.setAttribute("type","hidden"),a.setAttribute("name","data"),a.setAttribute("value",c),c=document.forms.exporter,c.appendChild(a),c.submit(),c.removeChild(a))}
function imageBase64(a,b){var c=document.getElementById("main-fractal-canvas").toDataURL(a,b),d=c.indexOf(";base64,")+8;return c.substring(d)}function convertToBinary(a){a=window.atob(a);var b=a.length,c=new Uint8Array(new ArrayBuffer(b));for(i=0;i<b;i++)c[i]=a.charCodeAt(i);return c}function imageToBlob(a,b){var c=convertToBinary(imageBase64(a,b));return new Blob([c],{type:a})}
function uploadImgur(){document.getElementById("main-fractal-canvas");var a=imageToBlob("image/jpeg",.95),b=new FormData;b.append("image",a);b.append("title",fractal.name);b.append("description","Created using Fractured Studio http://fract.ured.me");b.append("name",fractal.name+".jpg");b.append("key","70f934afb26ec9a9b9dc50ac1df2b40f");progress("Uploading image to Imgur...");ajaxPost("https://api.imgur.com/3/image",b,function(a){var b;try{b=JSON.parse(a)}catch(f){alert("Parse response error: "+f+
" : "+a);return}if(b.success){var g=b.data.link;progressDone(g,g);g=new FormData;g.append("url","http://i.imgur.com/"+b.data.id+".jpg");g.append("description",fractal.name);g.append("thumbnail","http://i.imgur.com/"+b.data.id+"s.jpg");g.append("info",a);ajaxPost("ss/image_save.php",g)}else alert("Error: "+a)},updateProgress,{Authorization:"Client-ID b29e1ddddcb30a7"})}
function loadFormulaeList(a){if(!state.offline)try{var b=document.getElementById("formulae-public");if(b){0==state.loggedin&&(ondelete=null);removeChildren(b);var c=JSON.parse(a);for(a=0;a<c.length;a++){var d=c[a].date+"\n"+c[a].name,f="menu(); loadFormulaSet("+c[a].id+", this)",g;"1"==c[a]["public"]&&(g=addMenuItem(b,d,f));state.formulae==c[a].id&&selectMenuItem(g,"deleteSelectedFormulae();")}checkMenuHasItems(b)}}catch(l){alert("LoadFormulaeList: Error! "+l)}}
function loadFormulaSet(a,b){confirm("Loading new formula set. This will overwrite currently loaded formulae!")&&(deselectAllMenuItems(document.getElementById("formulae-public"),!1),deselectAllMenuItems(document.getElementById("formulae-private"),!0),state.formulae=a,selectMenuItem(b),state.saveStatus(),progress("Downloading formula set..."),importFormulae(readURL("ss/formula_get.php?id="+a,!0,updateProgress)),progress())}
function importFormulae(a){try{importFormulaList(a),fractal.copyToForm(),fractal.reselectAll()}catch(b){alert("ImportFormulae: Error! "+b)}}function deleteSelectedFormulae(){state.formulae&&confirm("Delete this formula set from the server?")&&(readURL("ss/formula_delete.php?id="+state.formulae),loadFormulaeList(readURL("ss/formula_get.php")),state.formulae=0,state.saveStatus())}
function loadSession(a){confirm("Loading new session. This will overwrite everything!")&&(state.session=a,state.saveStatus(),ajaxReadFile("ss/session_get.php?id="+a,function(a){state.read(a)},!1,updateProgress),progress("Downloading session from server..."))}function deleteSelectedState(){state.session&&confirm("Delete this session from the server?")&&(deleteDriveFile(state.session,function(a){listFilesInApplicationDataFolder(loadDriveFiles)}),state.session=0,state.saveStatus())}
var panels=["panel_params","panel_formula","panel_colour","panel_info","panel_log"],selectedTab=null;
function showPanel(a){var b=document.getElementById("tab_"+a);a="panel_"+a;selectedTab||(selectedTab=document.getElementById("tab_params"));selectedTab.className="unselected";selectedTab=b;selectedTab.className="selected";for(i=0;i<panels.length;i++)document.getElementById(panels[i]).style.display=a==panels[i]?"block":"none";"panel_params"==a&&fractal.choices.core.reselect();"panel_formula"==a&&(fractal.choices.fractal.reselect(),fractal.choices.pre_transform.reselect(),fractal.choices.post_transform.reselect());
"panel_colour"==a&&(fractal.choices.outside_colour.reselect(),fractal.choices.inside_colour.reselect(),fractal.choices.filter.reselect());return!1}
function toggleParams(a){var b=document.getElementById("left"),c=document.getElementById("main");a?(b.style.display="block",500>window.innerWidth||(c.style.left=b.clientWidth+"px"),document.getElementById("hidetools").style.display="block",document.getElementById("showtools").style.display="none"):(b.style.display="none",c.style.left="0px",document.getElementById("hidetools").style.display="none",document.getElementById("showtools").style.display="block");autoResize(document.inputs.elements.autosize.checked)}
function toggleFullscreen(a){var b=document.getElementById("main"),c="none"!=document.getElementById("left").style.display;window.requestFullScreen&&("boolean"==typeof a&&1==a?(requestFullScreen("main"),b.style.top="-1px",b.style.left="0px",document.inputs.elements.autosize.checked||(b.style.overflow="auto")):document.fullScreenEnabled||(b.style.overflow="visible",b.style.top="27px",b.style.left=c?document.getElementById("left").clientWidth+"px":"1px"))}
function popup(a){var b=document.getElementById("popup");if(b)a?("block"==b.style.display?document.getElementById("popupmessage").innerHTML+="<hr>"+a:document.getElementById("popupmessage").innerHTML=a,b.style.marginTop="-"+Math.floor(document.getElementById("popup").clientHeight/2)+"px",b.style.display="block"):b.style.display="none";else{b=document.createElement("div");b.className="popup";var c=document.createElement("div");c.className="popclose";c.appendChild(c.ownerDocument.createTextNode("X"));
c.setAttribute("onclick","this.parentNode.parentNode.removeChild(this.parentNode);");b.appendChild(c);var d=document.createElement("div");d.appendChild(c.ownerDocument.createTextNode(a));b.appendChild(d);document.body.appendChild(b)}}
function progress(a){var b=document.getElementById("progress");void 0==a?b.style.display="none":(document.getElementById("progressmessage").innerHTML=a,document.getElementById("progressstatus").innerHTML="",document.getElementById("progressbar").style.width=0,b.style.display="block")}
function progressDone(a,b){document.getElementById("progressstatus").innerHTML="";var c=document.getElementById("progressmessage");c.innerHTML="";if(b){var d=document.createElement("a");d.setAttribute("href",b);var f=document.createTextNode(a);d.appendChild(f);c.appendChild(d)}else c.appendChild(c.ownerDocument.createTextNode(a));document.getElementById("progressbar").style.width="0px"}
function login(a){a&&document.getElementById("openid").setAttribute("value",a);document.forms.login_form.submit()}function logout(){confirm("Clear current session after logout?")&&state.reset(!0);readURL("ss/logout.php");window.location.reload(!1)}function doResize(){var a=document.getElementById("left"),b=document.getElementById("main");500<=window.innerWidth&&"block"==a.style.display&&(b.style.left=a.clientWidth+"px");0==state.mode?loadGallery():fractal.applyChanges()}
function autoResize(a){rztimeout&&clearTimeout(rztimeout);"boolean"==typeof a?(debug("Autosize "+a),void 0!=a&&(doResize(),document.inputs.elements.width.disabled=a,document.inputs.elements.height.disabled=a)):rztimeout=setTimeout(doResize,150)}function beforeUnload(a){state.save();return null}var editorWindow,editorFilename;
function openEditor(a){a&&(editorFilename=a,editorWindow=window.open(encodeURI("editor.html?file="+a),a,"toolbar=no,scrollbars=no,location=no,statusbar=no,menubar=no,resizable=1,width=600,height=700"))}function handleFormMouseDown(a){a=a||window.event;"colour"==a.target.className&&colours.edit(a.target);return!0}
function handleFormEnter(a){a=a||window.event;if("text"==a.target.type||"number"==a.target.type)if(a.shiftKey||a.altKey||a.ctrlKey){var b=a.target.id;/_[01]$/i.exec(a.target.id)&&(b=a.target.id.slice(0,a.target.id.length-1),document.getElementById(b+"0").value=fractal.canvas.mouse.coord.re,document.getElementById(b+"1").value=fractal.canvas.mouse.coord.im)}fractal.applyChanges();return!0}
function setFormFieldStep(a){if(a.value){var b=a.value.toLowerCase().indexOf("e"),c=a.value.indexOf("."),d=a.value.length;if(0<b){if(c=parseInt(a.value.substr(b+1)),0>c){a.step=Math.pow(10,c);debug(a.id+" step set to "+a.step);return}}else if(0<d&&0<=c){b=d-c-1;debug(a.value+" LEN "+d+" DPT "+c+" LSD "+b);a.step=Math.pow(10,-b);return}a.step=1;debug(a.id+" step set to "+a.step)}}function handleFormKeyUp(a){"number"==a.target.type&&setFormFieldStep(a.target)}
function handleFormChange(a){fractal.applyChanges();return!0}
function handleFormMouseWheel(a){a=a||window.event;if("text"==a.target.type||"number"==a.target.type||"range"==a.target.type){var b=a.target;b.timer&&clearTimeout(b.timer);a.spin=0<(a.deltaY?-a.deltaY:a.wheelDelta)?1:-1;b.style.cursor="wait";if("range"==a.target.type)b.value=parseReal(b.value)+parseReal(b.step)*a.spin,b.onchange();else{var c,d=b.value.indexOf("."),f=b.value.toLowerCase().indexOf("e");0<f?(c=b.value.substr(0,f),f=parseInt(b.value.substr(f+1)),b.value=c):f=null;c=b.getBoundingClientRect();
var g=[a.clientX-c.left,a.clientY-c.top];c=b.value.length;for(var l=1;l<=b.value.length;l++){var e=b.value.substr(0,l),h=document.getElementById("fonttest");h.innerHTML=e;e=h.clientWidth+1;h=b.value.substr(l-1,1);if(g[0]<e&&/[0-9]/.test(h)){c=l;b.style.cursor="none";break}}g=0;0<=d&&(g=b.value.length-d-1);d=b.value.replace(/[1-9]/g,"0");d=a.spin*parseReal(d.substr(0,c-1)+"1"+d.substr(c));c=parseReal(b.value);0>c&&(d=-d);b.value=(d+c).toFixed(g);f&&(b.value=Math.floor(b.value)+"e"+f)}b.timer=setTimeout('fractal.applyChanges(); document.getElementById("'+
b.id+'").style.cursor = "text";',150);a.preventDefault&&a.preventDefault();return!1}return!0}function fileSelected(a){if(window.File&&window.FileReader)for(var b=0;b<a.length;b++){var c=a[b],d=new FileReader;d.onload=function(a){return function(b){importFile(b.target.result,a.name,a.lastModifiedDate)}}(c);d.readAsText(c)}else alert("The File APIs are not fully supported in this browser.")}
function importFile(a,b,c){if("{"==a.charAt(0))try{var d=JSON.parse(a);d?d["fractured.fractals"]?(debug("Import: SESSION"),state.read(d)):(debug("Import: FORMULA SET"),importFormulae(a)):alert("Invalid data")}catch(f){alert("ImportFile: JSON Parse Error! "+f)}else/\[Fractal\]/ig.exec(a)?(debug("Import: FRACTAL"),hideGallery(),fractal.name=b.substr(0,b.lastIndexOf("."))||b,-1<b.indexOf(".ini")?fractal.iniLoader(a):fractal.load(a,!0)):0==a.indexOf("Background=")?(debug("Import: PALETTE"),colours.read(a)):
-1<b.indexOf(".js")?(localStorage["scripts/"+b]=a,populateScripts()):(debug("Import: FORMULA"),fractal.importFormula(a,b))}function debug(a){state&&state.output&&state.debug&&print(a)}function print(a){if(state&&state.output){var b=document.getElementById("console");b.innerHTML+="<div class='message'>"+a+"</div>";document.getElementById("panel_log").scrollTop=b.clientHeight-document.getElementById("panel_log").clientHeight+document.getElementById("panel_log").offsetHeight}}
function consoleClear(){document.getElementById("console").innerHTML=""}"use strict";var WEBGL=0,WEBCL=1,WEBCL64=2,SERVER=-1,newline=/\r\n?|\n/,sectionnames={core:"Core",fractal:"Fractal",pre_transform:"Pre-transform",post_transform:"Post-transform",outside_colour:"Outside Colour",inside_colour:"Inside Colour",filter:"Filter"},formulaTypes=["core","fractal","transform","colour"],savevars={},fractal_savevars={};function Timer(a){this.time=(new Date).getTime();this.oncomplete=a}
Timer.prototype.print=function(a){this.elapsed=(new Date).getTime()-this.time;print(a+" took: "+this.elapsed/1E3+" seconds");if(this.oncomplete)this.oncomplete()};function Server(a){this.url=a;this.http=new XMLHttpRequest;this.http.onprogress=function(a){setProgress(a.loaded/a.total*100)};this.data="";this.timer=null}
Server.prototype.draw=function(a,b){this.data=a;if(b){this.timer&&clearTimeout(this.timer);var c=this;this.timer=setTimeout(function(){c.post("/post",!0)},100)}else state.recording||this.post("/update")};
Server.prototype.post=function(a,b){var c=this.http;b?progress("Rendering & downloading fractal image..."):c=new XMLHttpRequest;c.onload=function(){if(200==c.status){if(b){setProgress(100);var a=document.getElementById("main-fractal-canvas");a.getContext("2d");var f=new Image;f.onload=function(b){window.URL.revokeObjectURL(f.src);a.getContext("2d").drawImage(f,0,0);progress()};f.src=window.URL.createObjectURL(c.response)}}else print("Ajax Post Error: returned status code "+c.status+" "+c.statusText)};
c.open("POST",this.url+a,!0);b&&(c.responseType="blob");c.send(this.data)};function Aspect(a,b,c,d){Complex.call(this,a,b);this.rotate=c;this.zoom=d}Aspect.prototype=new Complex;Aspect.prototype.constructor=Aspect;Aspect.prototype.print=function(){return this.re+","+this.im+","+this.rotate+","+this.zoom};Aspect.prototype.toString=function(){return"origin=("+this.re+","+this.im+")\nzoom="+this.zoom+"\nrotate="+this.rotate+"\n"};
Aspect.prototype.clone=function(){return new Aspect(this.re,this.im,this.rotate,this.zoom)};Aspect.prototype.pixelSize=function(a){return 2/(this.zoom*a.width)};Aspect.prototype.convert=function(a,b,c){var d=.5*c.width,f=.5*c.height,g=c.width<c.height?c.width:c.height;a=c.width/g*(a-d)/(d*this.zoom);c=c.height/g*(b-f)/(f*this.zoom);f=-this.rotate*Math.PI/180;b=mat4.create();mat4.identity(b);mat4.rotate(b,f,[0,0,1]);a=vec3.create([a,c,0]);mat4.multiplyVec3(b,a);return new Complex(a[0],a[1])};
function LineOffset(a,b,c){this.category=a;this.section=b;this.value=c}
function Fractal(a,b,c,d){a&&"string"==typeof a&&(a=document.getElementById(a));this.element=a||document.body;this.paramvars=[];this.preview=null;this.name="";this.ui=c;d&&(this.select=document.createElement("div"),this.select.id="select",this.select.className="select",this.element.appendChild(this.select));this.colours=b?b:{palette:new Palette(null,!0),read:function(a){this.palette=new Palette(a,!0)},get:function(a){this.palette.draw(a,!1)}};this.gradient=document.createElement("canvas");this.gradient.width=
2048;this.gradient.height=1}Fractal.prototype.init=function(a){a||(a={});this.state=a;this.setRenderer(this.state.renderer);this.resetDefaults();this.copyToForm()};Fractal.prototype.infoString=function(){var a="";window.WebGLRenderingContext&&(a+="W");this.webgl&&(a+="G");debug("INFO: "+a);return a};Fractal.prototype.switchMode=function(a){if(a!=SERVER||this.renderer!=SERVER)a==WEBGL&&this.webgl||(this.setRenderer(a),this.cache&&(this.servercache=this.cache=null,this.applyChanges()))};
Fractal.prototype.setRenderer=function(a){this.canvas=document.createElement("canvas");this.canvas.id=this.element.id+"-fractal-canvas";this.canvas.className="checkerboard";this.canvas.style.width=this.canvas.style.height="100%";this.canvas.mouse=new Mouse(this.canvas,this);this.canvas.mouse.setDefault();var b=document.getElementById(this.canvas.id);b&&this.element.removeChild(b);this.element.appendChild(this.canvas);this.renderer=a;void 0==this.renderer&&(this.renderer=WEBGL);if(!this.state.disabled&&
this.renderer==WEBGL)try{this.disabled&&(this.webgl=1),this.webgl=new WebGL(this.canvas,{premultipliedAlpha:!1,preserveDrawingBuffer:!0}),this.gl=this.webgl.gl,this.webgl.init2dBuffers()}catch(c){a=c,c.message&&(a=c.message),popup("WebGL support not available ("+a+")<br>Try <a href='http://get.webgl.org/troubleshooting'>http://get.webgl.org/troubleshooting</a> for more information."),this.webgl=null,this.renderer=SERVER}this.state.server&&(this.server=new Server(this.state.server));debug(this.state.server+
" SERVER: "+this.server);this.ui&&(document.getElementById("server").disabled=!1,document.getElementById("webgl").disabled=!1,window.WebGLRenderingContext&&null!==this.webgl||(document.getElementById("webgl").disabled=!0),this.state.server||(document.getElementById("server").disabled=!0),document.getElementById("server").className="",document.getElementById("webgl").className="",this.renderer==SERVER?document.getElementById("server").className="activemode":document.getElementById("webgl").className=
"activemode",print("Mode set to "+["Server","WebGL"][this.renderer+1]),this.state.renderer=this.renderer,this.state.saveStatus())};Fractal.prototype.precision=function(a){return a.toFixed(8)};Fractal.prototype.restore=function(a,b,c,d,f,g){this.position=new Aspect(a,b,c,d);this.selected=f;this.julia=g;this.copyToForm();this.draw()};Fractal.prototype.setOrigin=function(a){this.position.re+=a.re;this.position.im+=a.im};Fractal.prototype.applyZoom=function(a){this.position.zoom*=a};
Fractal.prototype.selectPoint=function(a){a&&!this.julia?(this.julia=!0,this.selected.re=this.position.re+a.re,this.selected.im=this.position.im+a.im,this.ui&&(document.getElementById("xSelect").value=this.selected.re,document.getElementById("ySelect").value=this.selected.im)):this.julia=!1;a=this.position.clone();this.position=this.savePos.clone();this.savePos=a};
Fractal.prototype.resetDefaults=function(){this.height=this.width=0;this.position=new Aspect(0,0,0,.5);this.savePos=new Aspect(0,0,0,.5);this.selected=new Complex(0,0);this.julia=!1;this.iterations=100;this.choices={core:null,fractal:null,pre_transform:null,post_transform:null,outside_colour:null,inside_colour:null,filter:null};for(category in this.choices)this.choices[category]=new FormulaSelection(category)};
Fractal.prototype.formulaDefaults=function(){if(this.ui){for(category in this.choices)this.choices[category].reselect(0);this.choices.outside_colour.reselect(1)}};Fractal.prototype.editFormula=function(a){"none"!=this.choices[a].selected&&openEditor(this.choices[a].getkey()+"#"+a)};
Fractal.prototype.newFormula=function(a){var b=categoryToType(a),c=prompt("Please enter name for new "+b+" formula","");if(c){var d=this.choices[a].getkey(),f=null;formula_list[d]&&(f=formula_list[d].source);if(b=new FormulaEntry(b,c,f))this.choices[a].select(b.name),document.getElementById(a+"_formula").value=b.name,this.editFormula(a)}};
Fractal.prototype.importFormula=function(a,b){var c=filenameToName(b),d=c[0],c=c[1];if(!(0>formulaTypes.indexOf(c))){var f=c+"/"+d;if(formula_list[f]){if(formula_list[f].equals(a))return;if(confirm("Replace formula definition "+f+" with new definition from this file?")){formula_list[f].source=a;debug("Replacing formula code for: "+f);return}}new FormulaEntry(c,nameToLabel(d),a)}};
Fractal.prototype.deleteFormula=function(a){var b=document.getElementById(a+"_formula"),c=b.selectedIndex;if(a=formulaKey(a,b.options[c].value)){var d=formula_list[a].label;d&&confirm('Really delete the "'+d+'" formula?')&&(b.remove(c),delete formula_list[a],b.selectedIndex=c-1,saveSelections(),this.reselectAll())}};Fractal.prototype.reselectAll=function(){for(category in this.choices)this.choices[category].reselect()};
Fractal.prototype.toString=function(){return this.paramString()+this.formulaParamString()+this.formulaSourceString()+this.paletteString()+this.scriptString()};Fractal.prototype.toStringNoFormulae=function(){return this.paramString()+this.formulaParamString()+this.paletteString()+this.scriptString()};Fractal.prototype.toStringMinimal=function(){return this.paramString()+this.formulaParamString()};
Fractal.prototype.paramString=function(a){var b;b="[fractal]\n"+('name="'+this.name+'"\n');this.state.version&&(b+="version="+this.state.version+"\n");a?b+="width="+this.canvas.clientWidth+"\nheight="+this.canvas.clientHeight+"\n":this.width&&this.height&&(b+="width="+this.width+"\nheight="+this.height+"\n");b+=this.position+"selected="+this.selected+"\njulia="+this.julia+"\niterations="+this.iterations+"\n";if(!a)for(category in this.choices)b+=category+"="+this.choices[category].selected+"\n";!a&&
this.savePos&&(b+="\n[preview]\n"+this.savePos+"\n");return b};Fractal.prototype.formulaParamString=function(){var a="";for(category in this.choices)"none"!=this.choices[category].selected&&0<this.choices[category].currentParams.count()&&(a+="\n[params."+category+"]\n"+this.choices[category].currentParams);return a};
Fractal.prototype.formulaSourceString=function(){var a="";for(category in this.choices)"none"==this.choices[category].selected||"post_transform"==category&&this.choices.post_transform.selected==this.choices.pre_transform.selected||"inside_colour"==category&&this.choices.outside_colour.selected==this.choices.inside_colour.selected||(a+="\n[formula."+category+"]\n"+this.choices[category].getSource());return a};Fractal.prototype.paletteString=function(){return"\n[palette]\n"+this.colours.palette};
Fractal.prototype.scriptString=function(){var a=localStorage["scripts/"+this.name+".js"];return a?"\n\n[script]\n"+a:""};Fractal.prototype.loadPalette=function(a){a=a.split(newline);for(var b="",c="",d=0;d<a.length;d++){var f=a[d].trim();"["==f[0]?c=f.slice(1,f.length-1):"palette"==c.toLowerCase()&&(b+=a[d]+"\n")}this.colours.read(b)};
Fractal.prototype.load=function(a,b,c){a=a.replace(/:([a-zA-Z_])/g,"$1");if(this.state.debug&&b&&0>a.indexOf("version=")&&confirm("No version found in fractal source. Load fractal in compatibility mode?"))return this.loadOld(a,c);this.resetDefaults();this.formulaDefaults();a=a.split(newline);b="";for(var d=null,f=0;f<a.length;f++){var g=a[f].trim();if("["==g[0]){var l="";b=g.slice(1,g.length-1);if("palette"==b||"script"==b){for(var e=f+1;e<a.length&&"["!=a[e][0];e++)l+=a[e]+"\n";"palette"==b&&this.colours.read(l);
"script"==b&&(localStorage["scripts/"+this.name+".js"]=l,populateScripts());f=e-1}}else if(g){"params.base"==b&&(b="fractal");if("preview"==b){var h=g.split("=");if("origin"==h[0])this.savePos.set(h[1]);else if("zoom"==h[0]||"rotate"==h[0])this.savePos[h[0]]=parseReal(h[1])}if("fractal"==b)if(h=g.split("="),"version"==h[0])print("Loading Fractal params, version: "+h[1]);else if("width"==h[0]||"height"==h[0]||"iterations"==h[0])this[h[0]]=parseInt(h[1]);else if("zoom"==h[0]||"rotate"==h[0])this.position[h[0]]=
parseReal(h[1]);else if("origin"==h[0])this.position.set(h[1]);else if("selected"==h[0])this.selected.set(h[1]);else if("julia"==h[0])this[h[0]]=1==parseInt(h[1])||"true"==h[1];else if(h[0]in this.choices){var g=h[1],h=h[0],m=formulaKey(h,g,!1);if(m){l="";for(e=f+1;e<a.length&&("["==a[e][0]&&(l=a[e].slice(1,a[e].lastIndexOf("]"))),l!="formula."+h);e++);if(l=="formula."+h){l="";for(e+=1;e<a.length&&"["!=a[e][0];e++)l+=a[e]+"\n";if(0<l.length)if(!formula_list[m])debug("Imported new formula: "+m),l=
new FormulaEntry(categoryToType(h),nameToLabel(g),l);else if(!formula_list[m].equals(l)){e=!1;for(k in formula_list)if(formula_list[k].equals(l)){debug("Found duplicate formula definition, using name: "+formula_list[k].name+" (was: "+g+")");g=formula_list[k].name;e=!0;break}e||(l=new FormulaEntry(categoryToType(h),nameToLabel(g),l),g=l.name,debug("Imported new formula definition for existing formula: "+m+", saved as "+g))}}}this.choices[h].exists(g)||(m=g.lastIndexOf("_"),0<m&&(g=g.substr(0,m)));
this.choices[h].select(g)}else print("Unrecognised fractal parameter: "+g);else"params."==b.slice(0,7)&&(h=b.split(".")[1],!h in this.choices?print("INVALID CATEGORY: "+h):(m=this.choices[h].selected,d&&0>g.indexOf("=")&&0<g.length?d.value+="\n"+a[f]:(g=g.split("="),this.choices[h].currentParams[g[0]]?(d=this.choices[h].currentParams[g[0]],d.parse(g[1])):print("Undeclared: ("+m+") ["+g[0]+"]="+g[1]))))}}this.loadParams();c||this.applyChanges()};
Fractal.prototype.loadOld=function(a,b){print("Parsing old fractal style");this.resetDefaults();this.formulaDefaults();a=a.replace(/_primes/g,"_integers");a=a.replace(/exp_smooth/g,"exponential_smoothing");a=a.replace(/magnet(\d)/g,"magnet_$1");a=a.replace(/burningship/g,"burning_ship");a=a.replace(/zold/gm,"z_old");a=a.replace(/^power=/gm,"p=");a=a.replace(/^bailfunc=/gm,"bailtest=");a=0<a.indexOf("nova")?a.replace(/^bailout=/gm,"converge="):a.replace(/^bailout=/gm,"escape=");a=a.replace(/^bailoutc=/gm,
"converge=");for(var c={},d=a.split(newline),f="",g=null,l=0;l<d.length;l++){var e=d[l].trim();if("["==e[0]){var h="",f=e.slice(1,e.length-1);if("palette"==f){for(e=l+1;e<d.length&&"["!=d[e][0];e++)h+=d[e]+"\n";this.colours.read(h);l=e-1}}else if(e)if("params.base"==f&&(f=0==e.indexOf("iterations")?"fractal":"params.transform"),"fractal"==f)if(h=e.split("="),"width"==h[0]||"height"==h[0]||"iterations"==h[0])this[h[0]]=parseInt(h[1]);else if("zoom"==h[0]||"rotate"==h[0])this.position[h[0]]=parseReal(h[1]);
else if("origin"==h[0])this.position.set(h[1]);else if("selected"==h[0])this.selected.set(h[1]);else if("julia"==h[0])this[h[0]]=1==parseInt(h[1])||"true"==h[1];else if("perturb"!=h[0]||1!=parseInt(h[1])&&"true"!=h[1])if("inrepeat"==h[0])c.inrepeat=h[1];else if("outrepeat"==h[0])c.outrepeat=h[1];else if(h[0]in this.choices||"transform"==h[0]){"transform"==h[0]&&(h[0]="post_transform");for(e=l+1;e<d.length;e++){var m=d[e];d[e]=d[e].replace("params."+h[1],"params."+h[0]);d[e]=d[e].replace("formula."+
h[1],"formula."+h[0]);"inside_colour"==h[0]&&(d[e]=d[e].replace(h[1]+"_in_",""));"outside_colour"==h[0]&&(d[e]=d[e].replace(h[1]+"_out_",""));d[e]!=m&&debug(m+" ==> "+d[e])}e=h[1];h=h[0];if(!h in this.choices)print("INVALID CATEGORY: "+h);else{formulaKey(h,e,!1);if(!this.choices[h].exists(e)&&(m=e.lastIndexOf("_"),0<m&&(e=e.substr(0,m)),!this.choices[h].exists(e))){alert("Formula not found: "+e);return}this.choices[h].select(e)}}else print("Unrecognised parameter: "+e);else c.perturb="true";else if("params."==
f.slice(0,7))if(m=f.split("."),"transform"==m[1]&&(m[1]="post_transform"),h=m[1],!h in this.choices)print("INVALID CATEGORY: "+h);else{var n=this.choices[h].selected;g&&0>e.indexOf("=")&&0<e.length?g.value+="\n"+d[l]:(e=e.split("="),0==e[0].indexOf(m[1]+"_")&&(e[0]=e[0].replace(m[1]+"_","")),this.choices[h].currentParams[e[0]]?(g=this.choices[h].currentParams[e[0]],g.parse(e[1])):"vary"==e[0]?0<parseReal(e[1])&&(this.choices.post_transform.select("fractured"),c.vary=e[1]):"antialias"!=e[0]&&print("Undeclared: ("+
n+") ["+e[0]+"]="+e[1]))}}this.loadParams();d=!1;c.perturb&&(this.choices.post_transform.currentParams.perturb.parse(c.perturb),d=!0);c.vary&&(this.choices.post_transform.currentParams.vary.parse(c.vary),this.choices.post_transform.currentParams.miniter.value=this.iterations,d=!0,this.iterations*=2);c.inrepeat&&void 0!=this.choices.inside_colour.currentParams.repeat&&(this.choices.inside_colour.currentParams.repeat.parse(c.inrepeat),d=!0);c.outrepeat&&void 0!=this.choices.outside_colour.currentParams.repeat&&
(this.choices.outside_colour.currentParams.repeat.parse(c.outrepeat),d=!0);d&&this.loadParams();b||this.applyChanges()};
Fractal.prototype.iniLoader=function(a){function b(a){return"Mandelbrot"==a?"mandelbrot":"Nova"==a?"nova":"Nova BS"==a||"NovaBS"==a?"novabs":0==a.indexOf("Burning")?"burning_ship":"Magnet2"==a?"magnet_2":"Magnet3"==a?"magnet_3":0==a.indexOf("Magnet")?"magnet_1":"Cactus"==a?"cactus":"Phoenix"==a?"phoenix":"Stretched"==a?"stretch":"Gumball"==a?"gmm":"Quadra"==a?"quadra":"Default"==a?"default":0==a.indexOf("Smooth")?"smooth":0==a.indexOf("Exp")?"exponential_smoothing":"Triangle Inequality"==a?"triangle_inequality":
"Orbit Traps"==a?"orbit_traps":"Gaussian Integers"==a?"gaussian_integers":"none"}function c(a,b){var c=a+"_colour",e=b[c].currentParams;e.repeat&&(e.repeat.value=0==a.indexOf("in")?d.inrepeat:d.outrepeat);"smooth"==b[c].selected&&(e.type2.value=!1,"Smooth 2"==d[a]&&(e.type2.value=!0),e.power.value="2",e.bailout.value=d.bailout?d.bailout:"escape");"triangle_inequality"==b[c].selected&&(e.power.value="2",e.bailout.value=d.bailout?d.bailout:"escape");"exponential_smoothing"==b[c].selected&&(e.diverge.value=
!0,e.converge.value=!1,e.use_z_old.value=!1,"Exp. Smoothing - Xdiverge"==d[a]&&(e.use_z_old.value=!0),"Exp. Smoothing - converge"==d[a]&&(e.diverge.value=!1,e.converge.value=!0,e.use_z_old.value=!0),"Exp. Smoothing - Both"==d[a]&&(e.converge.value=!0,e.use_z_old.value=!0));if("gaussian_integers"==b[c].selected){switch(parseInt(d.param2.re)){case 0:e.rmode.parse("round");break;case 1:e.rmode.parse("trunc");break;case 2:e.rmode.parse("floor");break;case 3:e.rmode.parse("ceil")}e.colourby.parse(d.param2.im)}}
this.resetDefaults();this.formulaDefaults();var d={};this.choices.post_transform.select("fractured");a=a.split(newline);for(var f="",g="",l=0;l<a.length;l++){var e=a[l].trim();if(e)if("["==e[0])f=e;else if("[Palette]"==f)g+=e+"\n";else if("[Parameters]"==f||"[ExtraParams]"==f||"[Fractal]"==f)if(e=e.split("="),"Formula"==e[0]||"Type"==e[0]||"OperationType"==e[0])this.choices.fractal.select(b(e[1]));else if("JuliaFlag"==e[0])this.julia=parseInt(e[1])?!0:!1;else if("PerturbFlag"==e[0]||"zFlag"==e[0])d.perturb=
parseInt(e[1])?!0:!1;else if("Iterations"==e[0])this.iterations=parseInt(e[1])+1;else if("Xstart"==e[0])this.position.re=parseReal(e[1]);else if("Ystart"==e[0])this.position.im=parseReal(e[1]);else if("Width"==e[0])this.width=e[1];else if("Height"==e[0])this.height=e[1];else if("Zoom"==e[0])0==e[1]&&(this.position.zoom=.5);else if("UnitsPerPixel"==e[0]){var h=parseReal(e[1]),e=this.width*h,h=this.height*h,m=2/e,n=2/h;this.position.zoom=m>n?m:n;this.position.re+=.5*e;this.position.im+=.5*h}else"AntiAlias"!=
e[0]&&("Rotation"==e[0]?this.position.rotate=e[1]:"CXstart"==e[0]?this.selected.re=parseReal(e[1]):"CYstart"==e[0]?this.selected.im=parseReal(e[1]):"Smooth"==e[0]?d.smooth=e[1]:"PaletteRepeat"==e[0]?(d.inrepeat=parseReal(e[1]),d.outrepeat=parseReal(e[1])):"PaletteRepeatIn"==e[0]?d.inrepeat=parseReal(e[1]):"Outside"==e[0]?(d.outside=e[1],this.choices.outside_colour.select(b(e[1]))):"Inside"==e[0]?(d.inside=e[1],this.choices.inside_colour.select(b(e[1]))):"VariableIterations"==e[0]?0<parseReal(e[1])&&
(this.choices.post_transform.select("fractured"),this.choices.post_transform.currentParams.vary.parse(e[1]),this.choices.post_transform.currentParams.miniter.value=this.iterations,this.iterations=Math.floor(2.414*this.iterations)):"Bailout"==e[0]?d.bailout=parseReal(e[1]):"Power"==e[0]?d.power=parseReal(e[1]):"Power2"==e[0]?d.power2=parseReal(e[1]):"function1"==e[0]?d.re_fn=parseInt(e[1]):"function2"==e[0]?d.im_fn=parseInt(e[1]):"op"==e[0]?d.inductop=parseInt(e[1]):"fnreal"==e[0]?d.induct=e[1]:"fnimag"==
e[0]?d.induct=new Complex(d.induct,e[1]):"real1"==e[0]||"param1"==e[0]?d.param1=e[1]:"imag1"==e[0]||"param2"==e[0]?d.param1=new Complex(d.param1,e[1]):"real2"==e[0]||"param3"==e[0]?d.param2=e[1]:"imag2"==e[0]||"param4"==e[0]?d.param2=new Complex(d.param2,e[1]):"real3"==e[0]||"param5"==e[0]?d.param3=e[1]:"imag3"==e[0]||"param6"==e[0]?d.param3=new Complex(d.param3,e[1]):"real4"==e[0]?d.param4=e[1]:"imag4"==e[0]?d.param4=new Complex(d.param4,e[1]):"Init"==e[0]?d.init=e[1]:"Inv"==e[0]?d.invert=e[1]:"Version"==
e[0]?d.version=e[1]:alert("Unknown param: "+e[0]+" == "+e[1]))}this.colours.read(g);this.state.legacy&&(this.colours.palette.background.alpha=1);d.smooth&&(1==parseInt(d.smooth)?this.choices.outside_colour.select("smooth"):this.choices.outside_colour.select("default"));d.bailout&&0>this.choices.fractal.selected.indexOf("nova")&&this.choices.fractal.currentParams.escape.parse(d.bailout);void 0!=d.power&&this.choices.fractal.currentParams.p.parse(d.power);0>=this.choices.fractal.currentParams.p.value&&
(alert("NOTE: power <= 0"),this.choices.fractal.currentParams.p.value=1);"magnet_1"==this.choices.fractal.selected&&d.power2&&this.choices.fractal.currentParams.q.parse(d.power2);"magnet_3"==this.choices.fractal.selected&&(this.choices.fractal.currentParams.A.parse([d.param1.re,d.param1.im]),this.choices.fractal.currentParams.B.parse([d.param3.re,d.param3.im]),this.choices.fractal.currentParams.C.parse([d.param2.re,d.param2.im]),this.choices.fractal.currentParams.D.parse([d.param3.re,d.param3.im]));
"nova"==this.choices.fractal.selected&&(a=d.param2?d.param2:d.param1)&&(this.choices.fractal.currentParams.relax.parse([a.re,a.im]),this.choices.fractal.currentParams.converge.parse("0.00001"));"novabs"==this.choices.fractal.selected&&(a=d.param2?d.param2:d.param1)&&(this.choices.fractal.currentParams.relax.parse([a.re,a.im]),this.choices.fractal.currentParams.converge.parse("0.00001"));"gmm"==this.choices.fractal.selected&&(this.choices.fractal.currentParams.A.parse([d.param1.re,d.param1.im]),this.choices.fractal.currentParams.B.parse([d.param2.re,
d.param2.im]),this.choices.fractal.currentParams.C.parse([d.param3.re,d.param3.im]),this.choices.fractal.currentParams.D.parse([d.param4.re,d.param4.im]));"quadra"==this.choices.fractal.selected&&(this.choices.fractal.currentParams.a.parse([d.param1.re,d.param1.im]),this.choices.fractal.currentParams.b.parse([d.param2.re,d.param2.im]));"phoenix"==this.choices.fractal.selected&&(d.power2&&this.choices.fractal.currentParams.q.parse([d.power2,0]),this.choices.fractal.currentParams.distort.parse([d.param1.re,
d.param1.im]));d.inductop||(d.inductop="0");if(0<d.re_fn||0<d.im_fn||0<d.inductop||d.perturb)a=" abs sin cos tan asin acos atan trunc log log10 sqrt flip inv abs".split(" "),this.choices.post_transform.currentParams.perturb.parse(d.perturb),d.re_fn&&this.choices.post_transform.currentParams.re_fn.parse(a[d.re_fn]),d.im_fn&&this.choices.post_transform.currentParams.im_fn.parse(a[d.im_fn]),d.induct?this.choices.post_transform.currentParams.induct.parse([d.induct.re,d.induct.im]):d.param1&&this.choices.post_transform.currentParams.induct.parse([d.param1.re,
d.param1.im]),this.choices.post_transform.currentParams.induct_on.value=d.inductop,10<=this.choices.post_transform.currentParams.induct_on.value&&(this.choices.post_transform.currentParams.induct_on.value-=10,this.choices.post_transform.currentParams.induct.value.re*=2,this.choices.post_transform.currentParams.induct.value.im*=2),1==this.choices.post_transform.currentParams.induct_on.value&&(this.choices.post_transform.currentParams.induct_on.value=2),1<this.choices.post_transform.currentParams.induct_on.value&&
(this.choices.post_transform.currentParams.induct_on.value=1);c("outside",this.choices);c("inside",this.choices);this.loadParams();this.applyChanges()};Fractal.prototype.loadParams=function(){if(this.ui){for(category in this.choices)this.choices[category].select();this.copyToForm()}};Fractal.prototype.resetZoom=function(){this.position=new Aspect(0,0,0,.5);this.copyToForm();this.draw()};
Fractal.prototype.sizeCanvas=function(){var a=this.width,b=this.height;a&&b?(document.documentElement.style.overflow="auto",this.canvas.style.width=a+"px",this.canvas.style.height=b+"px"):(document.documentElement.style.overflow="hidden",this.canvas.style.width="100%",this.canvas.style.height="100%",a=this.canvas.clientWidth,b=this.canvas.clientHeight,this.ui&&(document.getElementById("width").value=a,document.getElementById("height").value=b));if(32>a||32>b)debug("sizeCanvas: skipped, width/height too small: "+
a+" x "+b);else if(a!=this.canvas.width||b!=this.canvas.height)debug("Resize "+a+"x"+b),this.canvas.width=a,this.canvas.height=b,this.webgl&&(this.webgl.viewport.width=a,this.webgl.viewport.height=b)};Fractal.prototype.updatePalette=function(){this.webgl&&(this.colours.get(this.gradient,!0),this.webgl&&this.webgl.updateTexture(this.webgl.gradientTexture,this.gradient))};
Fractal.prototype.applyChanges=function(a,b){this.updatePalette();if(this.ui)for(category in document.inputs.elements.autosize.checked?this.height=this.width=0:(this.width=parseInt(document.getElementById("width").value),this.height=parseInt(document.getElementById("height").value)),this.iterations=parseReal(document.getElementById("iterations").value),this.julia=document.inputs.elements.julia.checked?1:0,this.position=new Aspect(parseReal(document.getElementById("xOrigin").value),parseReal(document.getElementById("yOrigin").value),
parseReal(document.getElementById("rotate").value),parseReal(document.getElementById("zoom").value)),this.selected=new Complex(parseReal(document.getElementById("xSelect").value),parseReal(document.getElementById("ySelect").value)),0>this.position.rotate&&(this.position.rotate+=360),this.position.rotate%=360,document.inputs.elements.rotate.value=this.position.rotate,this.choices)this.choices[category].currentParams.setFromForm();var c=this.toString();this.paramcache!=c&&(this.generated=new Generator(this,
b),this.draw(a,b),this.paramcache=c)};
Fractal.prototype.copyToForm=function(){if(this.ui){document.inputs.elements.name.value=this.name;document.inputs.elements.width.value=this.width;document.inputs.elements.height.value=this.height;document.inputs.elements.xOrigin.value=this.position.re;document.inputs.elements.yOrigin.value=this.position.im;document.inputs.elements.xSelect.value=this.selected.re;document.inputs.elements.ySelect.value=this.selected.im;document.inputs.elements.zoom.value=this.position.zoom;document.inputs.elements.rotate.value=
this.position.rotate;document.inputs.elements.julia.checked=this.julia;document.inputs.elements.iterations.value=this.iterations;for(category in this.choices)document.getElementById(category+"_formula").value=this.choices[category].selected;var a=0==this.width||0==this.height;document.inputs.elements.autosize.checked=a;document.inputs.elements.width.disabled=a;document.inputs.elements.height.disabled=a}};
function Generator(a,b){this.fractal=a;this.webcl=a.renderer>=WEBCL;this.webgl=a.webgl?!0:!1;console.log("FRACTAL RENDERER = "+a.renderer+" webcl "+this.webcl);this.notime=b;this.source="";this.generate()}
Generator.prototype.generate=function(){this.generateCore();var a="",a=this.webcl?sources["include/opencl-template.cl"]:sources["include/glsl-template.frag"],a=a.replace(/---LIBRARY---/,sources["include/complex.library"]),a=a.replace(/---FUNCTIONS---/,this.selections.core.functions||"");this.headerlen=a.substr(0,a.indexOf("---CODE---")).split(newline).length;a=a.replace(/---CODE---/,this.source);this.webcl&&(a=a.replace(/complex\(/g,"C("),a=a.replace(/real\(/g,"(real)("),a=a.replace(/float\(/g,"(float)("),
a=a.replace(/int\(/g,"(int)("),a=a.replace(/bool\(/g,"(bool)("),a=a.replace(/rgba\(/g,"(rgba)("));this.compile(a)};
Generator.prototype.generateCore=function(){this.source="#define MAXITER "+100*Math.ceil(this.fractal.iterations/100)+"\n";this.selections={};this.fractal.paramvars=[];for(category in this.fractal.choices)this.selections[category]=this.fractal.choices[category].getParsedFormula(this.fractal);this.offsets=[];this.source+="---DATA---\n---CORE---\n";this.templateInsert("DATA","data",["core"],0);this.templateInsert("CORE","main",["core"],0);var a="pre_transform fractal post_transform inside_colour outside_colour filter".split(" ");
this.templateInsert("DATA","data",a,2);for(this.templateInsert("INIT","init",a,0);this.templateInsert("RESET","reset",a,0););for(;this.templateInsert("PRE_TRANSFORM","transform",["pre_transform"],4););for(;this.templateInsert("ZNEXT","znext",["fractal"],2););for(;this.templateInsert("POST_TRANSFORM","transform",["post_transform"],4););for(;this.templateInsert("ESCAPED","escaped",["fractal"],2););for(;this.templateInsert("CONVERGED","converged",["fractal"],2););for(;this.templateInsert("OUTSIDE_CALC",
"calc",["outside_colour"],4););for(;this.templateInsert("INSIDE_CALC","calc",["inside_colour"],4););for(;this.templateInsert("OUTSIDE_COLOUR","result",["outside_colour"],2););for(;this.templateInsert("INSIDE_COLOUR","result",["inside_colour"],2););for(;this.templateInsert("FILTER","filter",["filter"],0););this.offsets.push(new LineOffset("(end)","(end)",this.source.split(newline).length));this.source=this.source.replace(/([^a-zA-Z0-9_\)])\(([-+]?((\d*\.)?\d+|[a-zA-Z_][a-zA-Z0-9_]*))\s*,\s*([-+]?((\d*\.)?\d+|[a-zA-Z_][a-zA-Z0-9_]*))\)/g,
"$1C($2,$5)");this.source=this.source.replace(/ident/g,"")};
Generator.prototype.templateInsert=function(a,b,c,d){var f="//***"+a+"***\n";a=new RegExp("---"+a+"---");d="          ".substr(0,d);var g=a.exec(this.source);if(!g)return!1;g=this.source.slice(0,g.index).split(newline).length;for(s in c){var l=this.selections[c[s]][b];if(l){for(var e=l.split(newline),l="",h=0;h<e.length;h++)l+=d+e[h]+"\n";this.offsets.push(new LineOffset(c[s],b,g+f.split(newline).length-1));f+=l+"\n"}}this.source=this.source.replace(a,f);return!0};
Generator.prototype.compile=function(a){if(this.fractal.cache!=a){this.fractal.cache=sources["generated.source"]=a;var b=new Timer,c=/0:(\d+)/;try{this.webcl?c=/[^-](\d+):/:this.webgl&&this.fractal.updateShader(a),this.notime||b.print("Compile")}catch(d){this.parseErrors(d,c)}}else debug("Shader build skipped, no changes")};
Generator.prototype.parseErrors=function(a,b){popup();var c=b.exec(a),d=!1;if(c){var c=parseInt(c[1])-this.headerlen+1,f=null;for(i in this.offsets){if(f&&c>=this.offsets[f].value&&c<this.offsets[i].value){var g=this.offsets[f].section,c=c-(this.offsets[f].value+1),c=c+this.fractal.choices[this.offsets[f].category].lineoffsets[g],l=formulaKey(this.offsets[f].category,this.fractal.choices[this.offsets[f].category].selected);l&&(popup("<b>Error</b>: line number: <b>"+(isNaN(c)?"??":c)+"</b><br>Section: <i>"+
g+"</i><br>"+sectionnames[this.offsets[f].category]+" formula: "+(l?formula_list[l].label:"?")+"<hr><code style='font-family: monospace;'>"+a.substr(0,511)+"</code>"),d=!0);break}f=i}}d||popup("<b>Error</b>:<hr><code style='font-family: monospace;'>"+JSON.stringify(a).substr(0,511)+"</code>")};
Fractal.prototype.updateShader=function(a){this.program=new WebGLProgram(this.gl,sources["include/shader2d.vert"],a);this.program.setup(["aVertexPosition"],"palette offset iterations julia origin selected_ dims pixelsize background params".split(" "));this.state.debug&&(a=this.gl.getExtension("WEBGL_debug_shaders"))&&(sources["generated.hlsl"]=a.getTranslatedShaderSource(this.program.fshader))};
Fractal.prototype.timeAction=function(a){function b(){var d=(new Date).getTime()-c;50>d?window.requestAnimationFrame(b):print(a+" took: "+d/1E3+" seconds")}if(window.requestAnimationFrame){var c=(new Date).getTime();window.requestAnimationFrame(b)}};function ondrawn(){if(fractal.ondraw)fractal.ondraw();var a=thumbnailQuick("jpeg",80,0,85);a&&(fractal.thumb=a);hideGallery()}Fractal.prototype.draw=function(a,b){var c=null;this.ui&&!b&&0<this.state.timers&&(c=new Timer(ondrawn));this.drawCore(a,c);this.saveState()};
Fractal.prototype.drawCore=function(a,b){a||(a=this.state.antialias);this.sizeCanvas();!this.state.disabled&&this.webgl&&(this.webgl.time=b,this.renderWebGL(a));(this.renderer==SERVER||this.state.control)&&this.server&&this.serverRender(a)};
Fractal.prototype.saveState=function(a){if(this.state.output){var b=this.name+"\n"+this.toStringNoFormulae();a||!history.state?(debug("Replaced State: "+b.length+" # "+history.length),console.log("Replaced State: "+b.length+" # "+history.length),window.history.replaceState(window.btoa(b),"",this.state.baseurl)):(debug("Saved State: "+b.length+" # "+history.length),console.log("Saved State: "+b.length+" # "+history.length),window.history.pushState(window.btoa(b),""));this.state.active=this.toString();
localStorage["fractured.active"]=this.state.active}};Fractal.prototype.serverRender=function(a){a||(a=this.state.antialias);a=this.paramString(!0)+"antialias="+a+"\n";this.paramvars.length&&(a+="variables="+JSON.stringify(this.paramvars));a+=this.paletteString()+"\n[shader]\n"+this.cache;this.servercache!=a&&(this.server.draw(a,!this.state.disabled&&this.renderer==SERVER),this.servercache=a)};
Fractal.prototype.clear=function(){this.sizeCanvas();this.webgl?this.gl.clear(this.gl.COLOR_BUFFER_BIT|this.gl.DEPTH_BUFFER_BIT):this.canvas.width=this.canvas.width};
Fractal.prototype.renderViewport=function(a,b,c,d){var f=this.colours.palette.background.alpha;this.colours.palette.background.alpha=1;this.webgl&&(this.webgl.time=null,this.gl.clear(this.gl.COLOR_BUFFER_BIT|this.gl.DEPTH_BUFFER_BIT),this.webgl.viewport=new Viewport(a,b,c,d),this.gl.enable(this.gl.SCISSOR_TEST),this.gl.scissor(a,b,c,d),this.renderWebGL(this.state.antialias),this.webgl.viewport=new Viewport(0,0,this.canvas.width,this.canvas.height),this.gl.disable(this.gl.SCISSOR_TEST));this.colours.palette.background.alpha=
f};
Fractal.prototype.renderWebGL=function(a){this.program&&this.program.uniforms&&(this.webgl.use(this.program),this.gl.uniform1i(this.program.uniforms.iterations,this.iterations),this.gl.uniform1i(this.program.uniforms.julia,this.julia),this.gl.uniform4fv(this.program.uniforms.background,this.colours.palette.background.rgbaGL()),this.gl.uniform2f(this.program.uniforms.origin,this.position.re,this.position.im),this.gl.uniform2f(this.program.uniforms.selected_,this.selected.re,this.selected.im),this.gl.uniform2f(this.program.uniforms.dims,this.webgl.viewport.width,
this.webgl.viewport.height),this.gl.uniform1f(this.program.uniforms.pixelsize,this.position.pixelSize(this.webgl.viewport)),this.gl.uniform1fv(this.program.uniforms.params,new Float32Array(this.paramvars)),this.gl.activeTexture(this.gl.TEXTURE0),this.gl.bindTexture(this.gl.TEXTURE_2D,this.webgl.gradientTexture),this.gl.uniform1i(this.program.uniforms.palette,0),this.webgl.modelView.identity(),this.webgl.modelView.translate([this.position.re,this.position.im,0]),this.webgl.modelView.rotate(this.position.rotate,
[0,0,-1]),this.webgl.modelView.scale([1/this.position.zoom,-1/this.position.zoom,1]),this.webgl.viewport.width>this.webgl.viewport.height?this.webgl.modelView.scale([this.webgl.viewport.width/this.webgl.viewport.height,1,1]):this.webgl.viewport.height>this.webgl.viewport.width&&this.webgl.modelView.scale([1,this.webgl.viewport.height/this.webgl.viewport.width,1]),this.gl.clearColor(0,0,0,0),this.timer&&(clearTimeout(this.timer),this.timer=null),this.webgl.initDraw2d(),this.gl.clear(this.gl.COLOR_BUFFER_BIT|
this.gl.DEPTH_BUFFER_BIT),this.gl.enable(this.gl.BLEND),1<a?(this.gl.blendFunc(this.gl.CONSTANT_ALPHA,this.gl.ONE_MINUS_CONSTANT_ALPHA),this.k=this.j=this.blendinc=0,this.antialias=a,this.renderPassWebGL()):(this.gl.blendFunc(this.gl.SRC_ALPHA,this.gl.ONE_MINUS_SRC_ALPHA),this.gl.drawArrays(this.gl.TRIANGLE_STRIP,0,this.webgl.vertexPositionBuffer.numItems),this.time&&this.time.print("Draw")))};
Fractal.prototype.renderPassWebGL=function(){var a=1-this.blendinc,a=Math.pow(a,1.5);this.gl.blendColor(0,0,0,a);this.blendinc+=1/(this.antialias*this.antialias);this.gl.uniform2f(this.webgl.program.uniforms.offset,2/(this.position.zoom*this.webgl.viewport.width)*(this.j/this.antialias-.5),2/(this.position.zoom*this.webgl.viewport.height)*(this.k/this.antialias-.5));this.gl.drawArrays(this.gl.TRIANGLE_STRIP,0,this.webgl.vertexPositionBuffer.numItems);this.k++;this.k>=this.antialias&&(this.k=0,this.j++);
if(this.j<this.antialias)if(this.time){var b=this;this.timer=setTimeout(function(){b.renderPassWebGL()},10)}else this.renderPassWebGL();else this.timer=null,this.time&&this.time.print("Draw")};Fractal.prototype.stop=function(){this.webgl&&this.webgl.timer&&(clearTimeout(this.webgl.timer),this.webgl.timer=null)};
Fractal.prototype.click=function(a,b){if(this.state.control&&this.state.disabled&&this.preview)return this.move(a,b);var c=this.position.convert(b.x,b.y,b.element);if(this.select&&"block"==this.select.style.display&&5<this.select.w&&5<this.select.h)c=this.position.convert(this.select.x+this.select.w/2,this.select.y+this.select.h/2,b.element),this.setOrigin(c),this.applyZoom(b.element.width/this.select.w);else if(0==a.button)a.ctrlKey?this.selectPoint(c):this.setOrigin(c);else if(0<a.button||a.ctrlKey){if(2!=
a.button||b.dragged)return!0;this.selectPoint(c)}this.select&&(this.select.style.display="none");this.copyToForm();this.draw();return!0};Fractal.prototype.down=function(a,b){this.server&&this.state.control&&this.server.post("/clear");this.stop();this.state.control&&this.state.disabled||this.clearPreview();return!0};Fractal.prototype.up=function(a,b){return!0};
Fractal.prototype.move=function(a,b){b.point=new Aspect(0,0,0,0);if(!this.state||0==this.state.mode)return!0;if(0<=b.x&&0<=b.y&&b.x<=b.element.width&&b.y<=b.element.height&&(b.point=this.position.convert(b.x,b.y,b.element),b.coord=new Complex(b.point.re+this.position.re,b.point.im+this.position.im),this.ui&&(document.getElementById("coords").innerHTML="&nbsp;re: "+this.precision(b.coord.re)+" im: "+this.precision(b.coord.im)),this.preview&&!this.julia)){this.selected=b.coord;this.drawPreview();return}if(!b.isdown)return!0;
if(0<b.button&&this.ui)return document.fullScreenEnabled?(this.element.scrollLeft-=b.deltaX,this.element.scrollTop-=b.deltaY):window.scrollBy(-b.deltaX,-b.deltaY),!0;if(this.select){this.select.style.display="block";this.select.w=Math.abs(b.deltaX);this.select.h=b.element.height/(b.element.width/this.select.w);this.select.x=0>b.deltaX?b.x:b.x-this.select.w;var c=this.element.getBoundingClientRect(),c=[c.left,c.top];this.select.y=0>b.deltaY?b.lastY-this.select.h-c[1]:b.lastY-c[1];this.select.style.left=
this.select.x+"px";this.select.style.top=this.select.y+"px";this.select.style.width=this.select.w+"px";this.select.style.height=this.select.h+"px";this.ui&&(document.getElementById("coords").innerHTML=this.select.style.width+","+this.select.style.height)}};
Fractal.prototype.wheel=function(a,b){this.stop();if(!this.preview&&a.shiftKey){document.getElementById("iterations").value=parseInt(document.getElementById("iterations").value)+a.spin;this.spintimer&&clearTimeout(this.spintimer);document.body.style.cursor="wait";var c=this;this.spintimer=setTimeout(function(){c.applyChanges();document.body.style.cursor="default"},this.state.timers)}else{var d;d=1.1;a.altKey&&(d=1.01);d=0>a.spin?1/(-a.spin*d):a.spin*d;this.preview?(this.savePos.zoom*=d,this.drawPreview()):
this.preview||1>=this.state.timers||!this.select?(this.applyZoom(d),this.copyToForm(),this.draw()):this.select&&(this.select.timer&&clearTimeout(this.select.timer),this.select.zoom||(this.select.zoom=1),this.select.mouse||(this.select.mouse=b,this.select.addEventListener("onwheel"in document?"wheel":"mousewheel",handleMouseWheel,!1)),this.select.zoom*=d,d=this.select.zoom,1<d?(d=1/d,this.select.w=this.canvas.offsetWidth*d,this.select.h=this.canvas.offsetHeight*d,this.select.x=.5*(this.canvas.offsetWidth-
this.select.w),this.select.y=.5*(this.canvas.offsetHeight-this.select.h)):(this.select.style.background="transparent",this.select.style.borderColor="#EECC11",this.select.x=this.select.y=0,this.select.w=this.canvas.offsetWidth*d,this.select.h=this.canvas.offsetHeight*d,this.select.style.borderLeftWidth=Math.round(.5*(this.canvas.offsetWidth-this.select.w))+"px",this.select.style.borderRightWidth=this.select.style.borderLeftWidth,this.select.style.borderTopWidth=Math.round(.5*(this.canvas.offsetHeight-
this.select.h))+"px",this.select.style.borderBottomWidth=this.select.style.borderTopWidth),this.select.style.left=this.select.x+"px",this.select.style.top=this.select.y+"px",this.select.style.width=this.select.w+"px",this.select.style.height=this.select.h+"px",this.select.style.display="block",document.body.style.cursor="wait",c=this,this.select.timer=setTimeout(function(){c.selectZoom()},this.state.timers))}return!1};
Fractal.prototype.selectZoom=function(){this.select.timer=null;document.body.style.cursor="default";this.applyZoom(this.select.zoom);this.copyToForm();this.applyChanges();this.select.zoom=null;this.select.style.display="none";this.select.style.background="#EECC11";this.select.style.borderColor="#596380";this.select.style.borderWidth="1px"};
Fractal.prototype.drawPreview=function(){this.preview.julia=!0;this.preview.selected=new Complex(this.selected.re,this.selected.im);this.preview.position=this.savePos;this.preview.win&&this.preview.win.focus();this.preview.drawCore();this.state.control&&this.preview.serverRender()};
Fractal.prototype.clearPreview=function(){this.preview&&(document.getElementById("previewbtn").innerHTML="Show Preview",clearTimeout(this.preview.timeout),document.mouse.moveUpdate=!1,this.preview.win&&this.preview.win.close(),this.preview=null,this.reselectAll())};
Fractal.prototype.showPreview=function(){document.mouse.moveUpdate=!0;if(this.preview)this.preview.load(this.toStringMinimal());else{if(this.state.disabled)this.preview=new Fractal("preview");else{var a=window.open("","view1","resizable=1,width=500,height=500");a.document.open();a.document.write("<html><head><link rel='stylesheet' type='text/css' href='styles.css'></head><body><div id='previewer'></div></body></html>");a.document.close();a.document.onkeydown=handleKey;this.preview=new Fractal(a.document.getElementById("previewer"));
this.preview.win=a}this.preview.init(this.state);this.preview.load(this.toStringNoFormulae());this.preview.width=this.preview.height=0}this.preview.win&&(this.preview.click=null,this.preview.down=null,this.preview.up=null);this.preview.applyChanges();this.drawPreview()};Fractal.prototype.togglePreview=function(){this.preview||this.julia?this.clearPreview():(this.showPreview(),document.getElementById("previewbtn")&&(document.getElementById("previewbtn").innerHTML="Show Preview &#10003;"))};
Fractal.prototype.pinch=function(a,b){this.state.control&&this.state.disabled&&this.preview||(this.applyZoom(0<a.distance?1+1E-4*a.distance:1/(1+-1E-4*a.distance)),this.copyToForm(),this.draw(),this.select&&(this.select.style.display="none"))};var paletteWin;function openPalette(){paletteWin=window.open("palette.html","palette","resizable=1,width=500,height=600,scrollbars=yes")}try{module.exports={Fractal:Fractal,State:State,getSources:function(){return sources},getFormula_list:function(){return formula_list}}}catch(e$$38){console.log("Browser mode")};
/*
 Javascript graphics utility library
 Helper functions, WebGL classes, Mouse input, Colours and Gradients UI
 Copyright (c) 2014, Owen Kaluza
 Released into public domain:
 This program is free software. It comes without any warranty, to
 the extent permitted by applicable law. You can redistribute it
 and/or modify it as long as this header remains intact
*/
var OK=function(){var a={debug_on:!1,debug:function(b){if(a.debug_on){var c=document.getElementById("console");c?c.innerHTML="<div style=\"font-family: 'monospace'; font-size: 8pt;\">"+b+"</div>"+c.innerHTML:console.log(b)}},clear:function(){var a=document.getElementById("console");a&&(a.innerHTML="")}};return a}();function getSearchVariable(a,b){for(var c=window.location.search.substring(1).split("&"),d=0;d<c.length;d++){var e=c[d].split("=");if(unescape(e[0])==a)return unescape(e[1])}return b}
function getImageDataURL(a){var b=document.createElement("canvas");b.width=a.width;b.height=a.height;b.getContext("2d").drawImage(a,0,0);return b.toDataURL("image/png")}function toggle(a){var b=document.getElementById(a).style.display;"none"!=b&&b?document.getElementById(a).style.display="none":document.getElementById(a).style.display="block"}function setAll(a,b){for(var c=document.getElementsByClassName(b),d=0;d<c.length;d++)c[d].style.display=a}
function getSourceFromElement(a){var b=document.getElementById(a);if(!b)return null;a="";for(b=b.firstChild;b;)3==b.nodeType&&(a+=b.textContent),b=b.nextSibling;return a}function removeChildren(a){if(a.hasChildNodes())for(;0<a.childNodes.length;)a.removeChild(a.firstChild)}function requestFullScreen(a){a=document.getElementById(a);a.requestFullscreen?a.requestFullscreen():a.mozRequestFullScreen?a.mozRequestFullScreen():a.webkitRequestFullScreen&&a.webkitRequestFullScreen()}
function typeOf(a){var b=typeof a;"object"===b&&(a?"number"!==typeof a.length||a.propertyIsEnumerable("length")||"function"!==typeof a.splice||(b="array"):b="null");return b}function isEmpty(a){var b,c;if("object"===typeOf(a))for(b in a)if(c=a[b],void 0!==c&&"function"!==typeOf(c))return!1;return!0}
function ajaxReadFile(a,b,c,d,e){var f=new XMLHttpRequest,g=0;void 0!=d&&("number"==typeof d?g=d:f.onprogress=d);f.onreadystatechange=function(){if(0<g&&2<f.readyState){var c=parseInt(f.responseText.length);d&&setProgress(c/g*100)}4==f.readyState&&(200==f.status?(d&&setProgress(100),OK.debug("RECEIVED: "+a),b&&b(f.responseText,a)):b?b("Error: "+f.status+" : "+a):OK.debug("Ajax Read File Error: returned status code "+f.status+" "+f.statusText))};c?f.open("GET",a+"?d="+(new Date).getTime(),!0):f.open("GET",
a,!0);for(var h in e)f.setRequestHeader(h,e[h]);f.send(null)}function readURL(a,b,c){var d=new XMLHttpRequest,e=0;void 0!=c&&("number"==typeof c?e=c:d.onprogress=c);d.onreadystatechange=function(){if(0<e&&2<d.readyState){var a=parseInt(d.responseText.length);c&&setProgress(a/e*100)}};b?d.open("GET",a+"?d="+(new Date).getTime(),!1):d.open("GET",a,!1);d.overrideMimeType("text/plain; charset=x-user-defined");d.send(null);if(200!=d.status)return"";c&&setProgress(100);return d.responseText}
function updateProgress(a){a.lengthComputable&&(setProgress(a.loaded/a.total*100),OK.debug(a.loaded+" / "+a.total))}function setProgress(a){a=Math.round(a);document.getElementById("progressbar").style.width=3*a+"px";document.getElementById("progressstatus").innerHTML=a+"%"}
function ajaxPost(a,b,c,d,e){var f=new XMLHttpRequest;void 0!=d&&(f.upload.onprogress=d);f.onreadystatechange=function(){4==f.readyState&&(200==f.status?(d&&setProgress(100),OK.debug("POST: "+a),c&&c(f.responseText)):c?c("Error, status:"+f.status):OK.debug("Ajax Post Error: returned status code "+f.status+" "+f.statusText))};f.open("POST",a,!0);"string"==typeof b&&f.setRequestHeader("Content-type","application/x-www-form-urlencoded");if(e)for(key in e)f.setRequestHeader(key,e[key]);f.send(b)}
var defaultMouse,dragMouse;function MouseEventHandler(a,b,c,d,e,f,g){this.click=a;this.wheel=b;this.move=c;this.down=d;this.up=e;this.leave=f;this.pinch=g}
function Mouse(a,b,c){this.element=a;this.handler=b;this.isdown=this.disabled=!1;this.button=null;this.dragged=!1;this.lastY=this.lastX=this.absoluteY=this.absoluteX=this.x=this.x=0;this.slider=null;this.spin=0;this.moveUpdate=!1;this.enableContext=c?!0:!1;a.addEventListener("onwheel"in document?"wheel":"mousewheel",handleMouseWheel,!1);a.onmousedown=handleMouseDown;a.onmouseout=handleMouseLeave;document.onmouseup=handleMouseUp;document.onmousemove=handleMouseMove;a.addEventListener("touchstart",
touchHandler,!0);a.addEventListener("touchmove",touchHandler,!0);a.addEventListener("touchend",touchHandler,!0);a.oncontextmenu=function(){return this.mouse.enableContext}}Mouse.prototype.setDefault=function(){defaultMouse=document.mouse=this};
Mouse.prototype.update=function(a){a||(a=window.event);this.x=a.clientX;this.y=a.clientY;this.absoluteX=this.x;this.absoluteY=this.y;var b=this.element.getBoundingClientRect(),b=[b.left,b.top];this.x-=b[0];this.y-=b[1];this.clientx=a.pageX-b[0];this.clienty=a.pageY-b[1]};function getMouse(a){a||(a=window.event);var b=a.target.mouse;if(b)return b;for(a=a.target;a!=document;)if(a=a.parentNode,a.mouse)return a.mouse;return null}
function handleMouseDown(a){var b=getMouse(a);if(!b||b.disabled)return!0;b.target=(a||window.event).target;b.dragged=!1;b.update(a);b.isdown||(b.lastX=b.absoluteX,b.lastY=b.absoluteY);b.isdown=!0;dragMouse=b;b.button=a.button;document.mouse=b;var c=!0;b.handler.down&&(c=b.handler.down(a,b));!c&&a.preventDefault&&a.preventDefault();return c}
function handleMouseUp(a){var b=document.mouse;if(!b||b.disabled)return!0;var c=!0;b.isdown&&(b.update(a),b.handler.click&&(c=b.handler.click(a,b)),b.isdown=!1,dragMouse=null,b.button=null,b.dragged=!1);b.handler.up&&(c=c&&b.handler.up(a,b));document.mouse=defaultMouse;!c&&a.preventDefault&&a.preventDefault();return c}
function handleMouseMove(a){var b=dragMouse?dragMouse:getMouse(a);if(!b||b.disabled)return!0;b.update(a);b.deltaX=b.absoluteX-b.lastX;b.deltaY=b.absoluteY-b.lastY;var c=!0;!b.dragged&&b.isdown&&3<Math.abs(b.deltaX)+Math.abs(b.deltaY)&&(b.dragged=!0);b.handler.move&&(c=b.handler.move(a,b));b.moveUpdate&&(b.lastX=b.absoluteX,b.lastY=b.absoluteY);!c&&a.preventDefault&&a.preventDefault();return c}
function handleMouseWheel(a){var b=getMouse(a);if(!b||b.disabled)return!0;b.update(a);var c=!1;a.spin=0<(a.deltaY?-a.deltaY:a.wheelDelta)?1:-1;b.handler.wheel&&(c=b.handler.wheel(a,b));!c&&a.preventDefault&&a.preventDefault();return c}function handleMouseLeave(a){var b=getMouse(a);if(!b||b.disabled)return!0;var c=!0;b.handler.leave&&(c=b.handler.leave(a,b));!c&&a.preventDefault&&a.preventDefault();return a.returnValue=c}
function touchHandler(a){var b=a.changedTouches[0],c=null,d=getMouse(a);switch(a.type){case "touchstart":2==a.touches.length?(d.isdown=!1,d.scaling=0):c="mousedown";break;case "touchmove":if(null!=d.scaling&&2==a.touches.length){var e=Math.sqrt((a.touches[0].pageX-a.touches[1].pageX)*(a.touches[0].pageX-a.touches[1].pageX)+(a.touches[0].pageY-a.touches[1].pageY)*(a.touches[0].pageY-a.touches[1].pageY));0<d.scaling?(a.distance=e-d.scaling,d.handler.pinch&&d.handler.pinch(a,d),a.returnValue=!0):d.scaling=
e}else c="mousemove";break;case "touchend":null!=d.scaling?d.scaling=0==d.scaling?null:0:c="mouseup";break;default:return}1<a.touches.length&&(c=null);c&&(d=document.createEvent("MouseEvent"),d.initMouseEvent(c,!0,!0,window,1,b.screenX,b.screenY,b.clientX,b.clientY,a.ctrlKey,a.altKey,a.shiftKey,a.metaKey,0,null),b.target.dispatchEvent(d),a.preventDefault())}function Viewport(a,b,c,d){this.x=a;this.y=b;this.width=c;this.height=d}
function WebGL(a,b){this.program=null;this.modelView=new ViewMatrix;this.perspective=new ViewMatrix;this.textures=[];this.timer=null;if(!window.WebGLRenderingContext)throw"No browser WebGL support";try{this.gl=a.getContext("webgl",b)||a.getContext("experimental-webgl",b)}catch(c){throw OK.debug("detectGL exception: "+c),"No context";}this.viewport=new Viewport(0,0,a.width,a.height);if(!this.gl)throw"Failed to get context";}
WebGL.prototype.setMatrices=function(){this.gl.uniformMatrix4fv(this.program.mvMatrixUniform,!1,this.modelView.matrix);this.gl.uniformMatrix4fv(this.program.pMatrixUniform,!1,this.perspective.matrix);if(this.program.nMatrixUniform){var a=mat4.create(this.modelView.matrix);mat4.inverse(a);mat4.transpose(a);this.gl.uniformMatrix4fv(this.program.nMatrixUniform,!1,a)}};
WebGL.prototype.initDraw2d=function(){this.gl.viewport(this.viewport.x,this.viewport.y,this.viewport.width,this.viewport.height);this.gl.enableVertexAttribArray(this.program.attributes.aVertexPosition);this.gl.bindBuffer(this.gl.ARRAY_BUFFER,this.vertexPositionBuffer);this.gl.vertexAttribPointer(this.program.attributes.aVertexPosition,this.vertexPositionBuffer.itemSize,this.gl.FLOAT,!1,0,0);this.program.attributes.aTextureCoord&&(this.gl.enableVertexAttribArray(this.program.attributes.aTextureCoord),
this.gl.bindBuffer(this.gl.ARRAY_BUFFER,this.textureCoordBuffer),this.gl.vertexAttribPointer(this.program.attributes.aTextureCoord,this.textureCoordBuffer.itemSize,this.gl.FLOAT,!1,0,0));this.setMatrices()};WebGL.prototype.updateTexture=function(a,b,c){void 0==c&&(c=this.gl.TEXTURE0);this.gl.activeTexture(c);this.gl.bindTexture(this.gl.TEXTURE_2D,a);this.gl.texImage2D(this.gl.TEXTURE_2D,0,this.gl.RGBA,this.gl.RGBA,this.gl.UNSIGNED_BYTE,b);this.gl.bindTexture(this.gl.TEXTURE_2D,null)};
WebGL.prototype.init2dBuffers=function(a){void 0==a&&(a=this.gl.TEXTURE0);this.vertexPositionBuffer=this.gl.createBuffer();this.gl.bindBuffer(this.gl.ARRAY_BUFFER,this.vertexPositionBuffer);this.gl.bufferData(this.gl.ARRAY_BUFFER,new Float32Array([1,1,-1,1,1,-1,-1,-1]),this.gl.STATIC_DRAW);this.vertexPositionBuffer.itemSize=2;this.vertexPositionBuffer.numItems=4;this.gl.activeTexture(a);this.gradientTexture=this.gl.createTexture();this.gl.bindTexture(this.gl.TEXTURE_2D,this.gradientTexture);this.gl.texParameteri(this.gl.TEXTURE_2D,
this.gl.TEXTURE_MAG_FILTER,this.gl.NEAREST);this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_MIN_FILTER,this.gl.NEAREST);this.textureCoordBuffer=this.gl.createBuffer();this.gl.bindBuffer(this.gl.ARRAY_BUFFER,this.textureCoordBuffer);this.gl.bufferData(this.gl.ARRAY_BUFFER,new Float32Array([1,1,0,1,1,0,0,0]),this.gl.STATIC_DRAW);this.textureCoordBuffer.itemSize=2;this.textureCoordBuffer.numItems=4};
WebGL.prototype.loadTexture=function(a,b,c,d){void 0==b&&(b=this.gl.NEAREST);void 0==c&&(c=this.gl.RGBA);this.texid=this.textures.length;this.textures.push(this.gl.createTexture());this.gl.bindTexture(this.gl.TEXTURE_2D,this.textures[this.texid]);d&&this.gl.pixelStorei(this.gl.UNPACK_FLIP_Y_WEBGL,!0);this.gl.texImage2D(this.gl.TEXTURE_2D,0,c,c,this.gl.UNSIGNED_BYTE,a);this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_MAG_FILTER,b);this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_MIN_FILTER,
b);this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_WRAP_S,this.gl.CLAMP_TO_EDGE);this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_WRAP_T,this.gl.CLAMP_TO_EDGE);this.gl.bindTexture(this.gl.TEXTURE_2D,null);return this.textures[this.texid]};WebGL.prototype.setPerspective=function(a,b,c,d){this.perspective.matrix=mat4.perspective(a,b,c,d)};WebGL.prototype.use=function(a){this.program=a;this.program.program&&this.gl.useProgram(this.program.program)};
WebGL.prototype.view=function(a){if(this.gl){this.gl.viewport(0,0,this.gl.viewportWidth,this.gl.viewportHeight);this.gl.clear(this.gl.COLOR_BUFFER_BIT|this.gl.DEPTH_BUFFER_BIT);this.setPerspective(a.fov,this.gl.viewportWidth/this.gl.viewportHeight,a.near_clip,a.far_clip);this.modelView.identity();this.modelView.translate([a.translate[0],a.translate[1],a.translate[2]]);var b=[-(a.focus[0]-a.centre[0]),-(a.focus[1]-a.centre[1]),-(a.focus[2]-a.centre[2])];this.modelView.translate(b);this.modelView.mult(quat4.toMat4(a.rotate));
this.modelView.scale(a.scale);this.modelView.translate([-b[0],-b[1],-b[2]]);this.modelView.translate([-a.focus[0],-a.focus[1],-a.focus[2]*a.orientation]);1==a.orientation?this.gl.frontFace(a.gl.CCW):(this.gl.frontFace(a.gl.CW),this.modelView.scale([1,1,-1]))}};
function WebGLProgram(a,b,c){this.program=null;0>b.indexOf("main")&&(b=getSourceFromElement(b));0>c.indexOf("main")&&(c=getSourceFromElement(c));this.gl=a;this.program&&this.gl.isProgram(this.program)&&(this.gl.isShader(this.vshader)&&(this.gl.detachShader(this.program,this.vshader),this.gl.deleteShader(this.vshader)),this.gl.isShader(this.fshader)&&(this.gl.detachShader(this.program,this.fshader),this.gl.deleteShader(this.fshader)),this.gl.deleteProgram(this.program));this.program=this.gl.createProgram();
this.vshader=this.compileShader(b,this.gl.VERTEX_SHADER);this.fshader=this.compileShader(c,this.gl.FRAGMENT_SHADER);this.gl.attachShader(this.program,this.vshader);this.gl.attachShader(this.program,this.fshader);this.gl.linkProgram(this.program);if(!this.gl.getProgramParameter(this.program,this.gl.LINK_STATUS))throw"Could not initialise shaders: "+this.gl.getProgramInfoLog(this.program);}
WebGLProgram.prototype.compileShader=function(a,b){var c=this.gl.createShader(b);this.gl.shaderSource(c,a);this.gl.compileShader(c);if(!this.gl.getShaderParameter(c,this.gl.COMPILE_STATUS))throw this.gl.getShaderInfoLog(c);return c};
WebGLProgram.prototype.setup=function(a,b,c){if(this.program){void 0==a&&(a=["aVertexPosition","aTextureCoord"]);this.attributes={};for(var d in a)this.attributes[a[d]]=this.gl.getAttribLocation(this.program,a[d]),c||this.gl.enableVertexAttribArray(this.attributes[a[d]]);this.uniforms={};for(d in b)this.uniforms[b[d]]=this.gl.getUniformLocation(this.program,b[d]);this.mvMatrixUniform=this.gl.getUniformLocation(this.program,"uMVMatrix");this.pMatrixUniform=this.gl.getUniformLocation(this.program,"uPMatrix");
this.nMatrixUniform=this.gl.getUniformLocation(this.program,"uNMatrix")}};function ViewMatrix(){this.matrix=mat4.create();mat4.identity(this.matrix);this.stack=[]}ViewMatrix.prototype.toString=function(){return JSON.stringify(this.toArray())};ViewMatrix.prototype.toArray=function(){return JSON.parse(mat4.str(this.matrix))};ViewMatrix.prototype.push=function(a){a?(this.stack.push(mat4.create(a)),this.matrix=mat4.create(a)):this.stack.push(mat4.create(this.matrix))};
ViewMatrix.prototype.pop=function(){if(0==this.stack.length)throw"Matrix stack underflow";return this.matrix=this.stack.pop()};ViewMatrix.prototype.mult=function(a){mat4.multiply(this.matrix,a)};ViewMatrix.prototype.identity=function(){mat4.identity(this.matrix)};ViewMatrix.prototype.scale=function(a){mat4.scale(this.matrix,a)};ViewMatrix.prototype.translate=function(a){mat4.translate(this.matrix,a)};ViewMatrix.prototype.rotate=function(a,b){mat4.rotate(this.matrix,a*Math.PI/180,b)};
function Palette(a,b){this.premultiply=b;this.background=new Colour("rgba(0,0,0,0)");this.colours=[];this.slider=new Image;this.slider.src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAkAAAAPCAYAAAA2yOUNAAAAj0lEQVQokWNIjHT8/+zZs//Pnj37/+TJk/9XLp/+f+bEwf9HDm79v2Prqv9aKrz/GUYVEaeoMDMQryJXayWIoi0bFmFV1NWS+z/E1/Q/AwMDA0NVcez/LRsWoSia2luOUAADVcWx/xfO6/1/5fLp/1N7y//HhlmhKoCBgoyA/w3Vyf8jgyyxK4CBUF8zDAUAAJRXY0G1eRgAAAAASUVORK5CYII=";if(a){var c=!1;if("string"==typeof a)for(var d=a.split(/[\n;]/),e,f=0;f<
d.length;f++){var g=d[f].trim();if(g){var h=g.split("=");if("Background"==h[0])this.background=new Colour(h[1]);else if("P"==h[0][0])e=parseFloat(h[1]);else if("C"==h[0][0]){if(this.colours.push(new ColourPos(h[1],e)),1==e)break}else 2==h.length?this.colours.push(new ColourPos(h[1],h[0])):(c=!0,this.colours.push(new ColourPos(g)))}}else{for(d=0;d<a.length;d++)void 0==a[d].position&&(c=!0),this.colours.push(new ColourPos(a[d].colour,a[d].position));a.background&&(this.background=new Colour(a.background))}if(c)for(d=
0;d<this.colours.length;d++)this.colours[d].position=1/(this.colours.length-1)*d;this.sort();c=!1;for(d=0;d<this.colours.length;d++)0<this.colours[d].colour.alpha&&(c=!0),1<this.colours[d].colour.alpha&&(this.colours[d].colour.alpha=1);if(!c)for(d=0;d<this.colours.length;d++)this.colours[d].colour.alpha=1}else this.colours.push(new ColourPos("rgba(255,255,255,1)",0)),this.colours.push(new ColourPos("rgba(0,0,0,1)",1))}
Palette.prototype.sort=function(){this.colours.sort(function(a,b){return a.position-b.position})};Palette.prototype.newColour=function(a,b){var c=new ColourPos(b,a);this.colours.push(c);this.sort();for(c=1;c<this.colours.length-1;c++)if(this.colours[c].position==a)return c;return-1};Palette.prototype.inRange=function(a,b,c){for(var d=0;d<this.colours.length;d++){var e=this.colours[d].position*c;if(a==e||1<b&&a>=e-b/2&&a<=e+b/2)return d}return-1};
Palette.prototype.inDragRange=function(a,b,c){for(var d=1;d<this.colours.length-1;d++){var e=this.colours[d].position*c;if(a==e||1<b&&a>=e-b/2&&a<=e+b/2)return d}return 0};Palette.prototype.remove=function(a){this.colours.splice(a,1)};Palette.prototype.toString=function(){for(var a="Background="+this.background.html(),b=0;b<this.colours.length;b++)a+="\n"+this.colours[b].position.toFixed(6)+"="+this.colours[b].colour.html();return a};
Palette.prototype.get=function(){var a={};a.background=this.background.html();a.colours=[];for(var b=0;b<this.colours.length;b++)a.colours.push({position:this.colours[b].position,colour:this.colours[b].colour.html()});return a};Palette.prototype.toJSON=function(){return JSON.stringify(this.get())};
Palette.prototype.draw=function(a,b){if(!this.slider.width&&b){var c=this;setTimeout(function(){c.draw(a,b)},150)}else if(a){var d=/webkit/.test(navigator.userAgent.toLowerCase());0==this.colours.length&&(this.background=new Colour("#ffffff"),this.colours.push(new ColourPos("#000000",0)),this.colours.push(new ColourPos("#ffffff",1)));list=this.colours.slice(0);list.sort(function(a,b){return a.position-b.position});if(a.getContext){var e=a.width,f=a.height,g=a.getContext("2d");g.clearRect(0,0,e,f);
if(d)for(var h=0,d=1;d<list.length;d++){var k=Math.round(e*list[d].position);g.fillStyle=g.createLinearGradient(h,0,k,0);var l=list[d-1].colour,m=list[d].colour;this.premultiply&&!b&&(l=this.background.blend(l),m=this.background.blend(m));g.fillStyle.addColorStop(0,l.html());g.fillStyle.addColorStop(1,m.html());g.fillRect(h,0,k-h,f);h=k}else{g.fillStyle=g.createLinearGradient(0,0,e,0);for(d=0;d<list.length;d++)h=list[d].colour,this.premultiply&&!b&&(h=this.background.blend(h)),g.fillStyle.addColorStop(list[d].position,
h.html());g.fillRect(0,0,e,f)}if(f=document.getElementById("backgroundCUR"))f.style.background=this.background.html();if(b)for(d=1;d<list.length-1;d++)f=Math.floor(e*list[d].position)+.5,50<list[d].colour.HSV().V?g.strokeStyle="black":g.strokeStyle="white",g.beginPath(),g.moveTo(f,0),g.lineTo(f,a.height),g.closePath(),g.stroke(),f-=this.slider.width/2,g.drawImage(this.slider,f,0)}else alert("getContext failed!")}else alert("Invalid canvas!")};
function ColourPos(a,b){this.position=void 0==b?0:parseFloat(b);if(0<=this.position&&1>=this.position)this.colour=a?"object"==typeof a?a:new Colour(a):new Colour("#000000");else throw"Invalid Colour Position: "+b;}
function Colour(a){"undefined"==typeof a?this.set("#ffffff"):"string"==typeof a?this.set(a):"object"==typeof a?"undefined"!=typeof a.H?this.setHSV(a):"undefined"!=typeof a.red?(this.red=a.red,this.green=a.green,this.blue=a.blue,this.alpha=a.alpha):a.R?(this.red=a.R,this.green=a.G,this.blue=a.B,this.alpha="undefined"==typeof a.A?1:a.A):(this.red=a[0],this.green=a[1],this.blue=a[2],1>=this.red&&1>=this.green&&1>=this.blue&&(this.red=Math.round(255*this.red),this.green=Math.round(255*this.green),this.blue=
Math.round(255*this.blue)),this.alpha="undefined"==typeof a[3]?1:a[3]):this.fromInt(a)}
Colour.prototype.set=function(a){a||(a="#ffffff");var b=/^rgba?\((\d{1,3})\s*,\s*(\d{1,3})\s*,\s*(\d{1,3})\s*,?\s*(\d\.?\d*)?\)$/.exec(a);b?(this.red=parseInt(b[1]),this.green=parseInt(b[2]),this.blue=parseInt(b[3]),this.alpha="undefined"==typeof b[4]?1:parseFloat(b[4])):"#"==a.charAt(0)?(a=a.substring(1,7),this.alpha=1,this.red=parseInt(a.substring(0,2),16),this.green=parseInt(a.substring(2,4),16),this.blue=parseInt(a.substring(4,6),16)):this.fromInt(parseInt(a))};
Colour.prototype.fromInt=function(a){this.red=a&255;this.green=(a&65280)>>>8;this.blue=(a&16711680)>>>16;this.alpha=((a&4278190080)>>>24)/255};Colour.prototype.toInt=function(){var a=this.red,a=a+(this.green<<8),a=a+(this.blue<<16);return a+=Math.round(255*this.alpha)<<24};Colour.prototype.toString=function(){return this.html()};Colour.prototype.html=function(){return"rgba("+this.red+","+this.green+","+this.blue+","+this.alpha.toFixed(2)+")"};
Colour.prototype.rgbaGL=function(){return new Float32Array([this.red/255,this.green/255,this.blue/255,this.alpha])};Colour.prototype.rgbaGLSL=function(){var a=this.rgbaGL();return"rgba("+a[0].toFixed(4)+","+a[1].toFixed(4)+","+a[2].toFixed(4)+","+a[3].toFixed(4)+")"};Colour.prototype.rgba=function(){return[this.red/255,this.green/255,this.blue/255,this.alpha]};Colour.prototype.rgbaObj=function(){return{R:this.red,G:this.green,B:this.blue,A:this.alpha}};Colour.prototype.print=function(){OK.debug(this.printString(!0))};
Colour.prototype.printString=function(a){return"R:"+this.red+" G:"+this.green+" B:"+this.blue+(a?" A:"+this.alpha:"")};Colour.prototype.HEX=function(a){a=Math.round(Math.min(Math.max(0,a),255));return"0123456789ABCDEF".charAt((a-a%16)/16)+"0123456789ABCDEF".charAt(a%16)};Colour.prototype.htmlHex=function(a){return"#"+this.HEX(this.red)+this.HEX(this.green)+this.HEX(this.blue)};Colour.prototype.hex=function(a){return this.HEX(this.red)+this.HEX(this.green)+this.HEX(this.blue)+this.HEX(255*this.alpha)};
Colour.prototype.hexGL=function(a){return this.HEX(255*this.alpha)+this.HEX(this.blue)+this.HEX(this.green)+this.HEX(this.red)};
Colour.prototype.setHSV=function(a){var b,c,d,e,f;f=a.S/100;var g=a.V/100,h=a.H/360;if(0<f){1<=h&&(h=0);h*=6;F=h-Math.floor(h);d=Math.round(255*g*(1-f));e=Math.round(255*g*(1-f*F));f=Math.round(255*g*(1-f*(1-F)));g=Math.round(255*g);switch(Math.floor(h)){case 0:b=g;c=f;e=d;break;case 1:b=e;c=g;e=d;break;case 2:b=d;c=g;e=f;break;case 3:b=d;c=e;e=g;break;case 4:b=f;c=d;e=g;break;case 5:b=g,c=d}this.red=b?b:0;this.green=c?c:0;this.blue=e?e:0}else this.blue=this.green=this.red=g=Math.round(255*g);this.alpha=
"undefined"==typeof a.A?1:a.A};Colour.prototype.HSV=function(){var a=this.red/255,b=this.green/255,c=this.blue/255,d=Math.max(a,b,c);deltaMax=d-Math.min(a,b,c);var e,f,g,h,k;0==deltaMax?e=f=0:(e=deltaMax/d,g=((d-a)/6+deltaMax/2)/deltaMax,h=((d-b)/6+deltaMax/2)/deltaMax,k=((d-c)/6+deltaMax/2)/deltaMax,a==d?f=k-h:b==d?f=1/3+g-k:c==d&&(f=2/3+h-g),0>f&&(f+=1),1<f&&--f);return{H:360*f,S:100*e,V:100*d}};Colour.prototype.HSVA=function(){var a=this.HSV();a.A=this.alpha;return a};
Colour.prototype.interpolate=function(a,b){this.red=Math.round(this.red+b*(a.red-this.red));this.green=Math.round(this.green+b*(a.green-this.green));this.blue=Math.round(this.blue+b*(a.blue-this.blue));this.alpha=Math.round(this.alpha+b*(a.alpha-this.alpha))};Colour.prototype.blend=function(a){return new Colour([Math.round((1-a.alpha)*this.red+a.alpha*a.red),Math.round((1-a.alpha)*this.green+a.alpha*a.green),Math.round((1-a.alpha)*this.blue+a.alpha*a.blue),(1-a.alpha)*this.alpha+a.alpha*a.alpha])};
function MoveWindow(a){if(a){this.element=document.getElementById(a);if(!this.element)return alert("No such element: "+a),null;this.mouse=new Mouse(this.element,this);this.mouse.moveUpdate=!0;this.element.mouse=this.mouse}}
MoveWindow.prototype.open=function(a,b){var c=this.element.style;0>a&&(a=0);0>b&&(b=0);void 0!=a&&(c.left=a+"px");void 0!=b&&(c.top=b+"px");c.display="block";var d=this.element.offsetWidth,e=this.element.offsetHeight;a+d>window.innerWidth-20&&(c.left=window.innerWidth-d-20+"px");b+e>window.innerHeight-20&&(c.top=window.innerHeight-e-20+"px")};MoveWindow.prototype.close=function(){this.element.style.display="none"};
MoveWindow.prototype.move=function(a,b){if(b.isdown&&!(0<b.button)){var c=b.element.style;c.left=parseInt(c.left)+b.deltaX+"px";c.top=parseInt(c.top)+b.deltaY+"px"}};MoveWindow.prototype.down=function(a,b){return!1};function scale(a,b,c,d){return clamp(d*a/b,c,d)}function clamp(a,b,c){return Math.max(b,Math.min(c,a))}
function ColourPicker(a,b){function c(a,b,c){var d=document.createElement("div");d.id=a;b&&(d.innerHTML=b);c&&(d.style.cssText=c);return d}var d=document.getElementById("picker");if(d&&d.picker)return d.picker.savefn=a,d.picker.abortfn=b,d.picker;d=document.body;this.element=c("picker",null,"display:none; top: 58px; z-index: 20; background: #0d0d0d; color: #aaa; cursor: move; font-family: arial; font-size: 11px; padding: 7px 10px 11px 10px; position: fixed; width: 232px; border-radius: 5px; border: 1px solid #444;");
var e=c("pickCURBG",null,'background-image: url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAIElEQVQ4jWP4TwAcOHAAL2YYNWBYGEBIASEwasCwMAAALvidroqDalkAAAAASUVORK5CYII="); float: left; width: 12px; height: 12px; margin-right: 3px;');e.appendChild(c("pickCUR",null,"float: left; width: 12px; height: 12px; background: #fff; margin-right: 3px;"));this.element.appendChild(e);e=c("pickRGB","R: 255 G: 255 B: 255","float: left; position: relative; top: -1px;");e.onclick="colours.picker.updateString()";
this.element.appendChild(e);this.element.appendChild(c("pickCLOSE","X","float: right; cursor: pointer; margin: 0 8px 3px;"));this.element.appendChild(c("pickOK","OK","float: right; cursor: pointer; margin: 0 8px 3px;"));e=c("SV",null,"position: relative; cursor: crosshair; float: left; height: 170px; width: 170px; margin-right: 10px; background: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAEG0lEQVQ4jQEQBO/7APz8/Pz7+/vx+/v75Pr6+tb6+vrF+Pj4tPf396H4+PiO9/f3e/X19Wfz8/NU8PDwQuvr6zLi4uIjzs7OFZmZmQoA8PDw/O/v7/Ht7e3l7Ozs2Ozs7Mjq6uq35ubmpeXl5ZLf39+A3NzcbtXV1VvMzMxLvr6+O6ioqCyEhIQfQEBAFADk5OT84eHh8uDg4Obe3t7Z3Nzcy9nZ2brV1dWq0NDQmcrKyofCwsJ2uLi4ZKqqqlSYmJhFfX19N1lZWSsnJychANPT0/zT09Pz0NDQ6c3NzdzKysrNx8fHv8DAwK+6urqfsrKyj6mpqX+cnJxvjIyMX3l5eVBeXl5EPz8/ORsbGy8Aw8PD/MHBwfS+vr7qurq63ra2ttKxsbHErKystaOjo6eampqXj4+PiYODg3lycnJrXl5eX0hISFIuLi5IEBAQPwCwsLD9r6+v9aysrOynp6fioqKi1p2dncmVlZW8jo6OroODg6F5eXmUa2trhl1dXXlLS0ttNzc3YiIiIlkNDQ1RAJ6env2bm5v2l5eX7pSUlOWPj4/aiIiIz4GBgcN5eXm3cHBwq2RkZJ5XV1eSSkpKhzk5OX0qKipzGBgYawgICGMAioqK/YeHh/eDg4PvgICA6Hp6et90dHTVbW1ty2VlZcBcXFy1UVFRqkZGRqA6OjqWLS0tjSEhIYQSEhJ9BgYGdwB2dnb+c3Nz+HFxcfJra2vrZmZm42JiYttaWlrRUlJSyUtLS79CQkK2Nzc3rS0tLaQiIiKdGBgYlQ4ODo8EBASKAGNjY/5gYGD5XV1d9FpaWu5VVVXnTk5O4UlJSdlCQkLRPDw8yTQ0NMEqKiq7IiIisxkZGa0RERGmCgoKoQMDA5wAUFBQ/k9PT/pKSkr3R0dH8kNDQ+w+Pj7mOTk54DMzM9otLS3TJycnzSAgIMgZGRnBExMTvA0NDbcHBweyAwMDrwA9PT3+PDw8+zo6Ovg2Njb0MzMz8DAwMOwqKirnJSUl4iEhId4cHBzYFxcX1BISEtAODg7KCQkJxwQEBMQBAQHBAC0tLf4rKyv9Kioq+iYmJvclJSX0ISEh8R4eHu4aGhrqFhYW5xMTE+MQEBDgDQ0N3AgICNkGBgbWBAQE0wAAANEAHh4e/h0dHf0bGxv7Ghoa+hgYGPcWFhb2FBQU8xEREfEPDw/uDAwM7AoKCuoICAjoBgYG5gMDA+MBAQHiAAAA4QARERH+EBAQ/g8PD/0NDQ38DQ0N+wsLC/kKCgr4CAgI9wcHB/YFBQX0BAQE8wICAvIBAQHwAQEB7wAAAO8AAADuAAUFBf4FBQX+BAQE/gQEBP4DAwP+AwMD/QMDA/0CAgL8AQEB/AEBAfsAAAD7AAAA+wAAAPoAAAD6AAAA+QAAAPmq2NbsCl2m4wAAAABJRU5ErkJggg==') no-repeat; background-size: 100%;");
e.appendChild(c("SVslide",null,"background: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAkAAAAJCAYAAADgkQYQAAAALUlEQVQYlWNgQAX/kTBW8B8ZYFMIk0ARQFaIoQCbQuopIspNRPsOrpABSzgBAFHzU61KjdKlAAAAAElFTkSuQmCC'); height: 9px; width: 9px; position: absolute; cursor: crosshair"));this.element.appendChild(e);e=c("H",null,'cursor: crosshair; float: left; height: 170px; position: relative; width: 19px; padding: 0;background-image: url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAIElEQVQ4jWP4TwAcOHAAL2YYNWBYGEBIASEwasCwMAAALvidroqDalkAAAAASUVORK5CYII=");');
e.appendChild(c("Hmodel",null,"position: relative;"));e.appendChild(c("Hslide",null,'top: 0px; left: -5px; background: url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAB0AAAAFCAYAAAC5Fuf5AAAAKklEQVQokWP4////fwY6gv////9n+A8F9LIQxVJaW4xiz4D5lB4WIlsMAPjER7mTpG/OAAAAAElFTkSuQmCC"); height: 5px; width: 29px; position: absolute; '));this.element.appendChild(e);e=c("O",null,'cursor: crosshair; float: left; height: 170px; position: relative; width: 19px; padding: 0;background-image: url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAIElEQVQ4jWP4TwAcOHAAL2YYNWBYGEBIASEwasCwMAAALvidroqDalkAAAAASUVORK5CYII=");border: 1px solid #888; left: 9px;');
e.appendChild(c("Omodel",null,"position: relative;"));e.appendChild(c("Oslide",null,'top: 0px; left: -5px; background: url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAB0AAAAFCAYAAAC5Fuf5AAAAKklEQVQokWP4////fwY6gv////9n+A8F9LIQxVJaW4xiz4D5lB4WIlsMAPjER7mTpG/OAAAAAElFTkSuQmCC"); height: 5px; width: 29px; position: absolute; '));this.element.appendChild(e);d.appendChild(this.element);d=document.createElement("style");d.styleSheet?d.styleSheet.cssText="#pickRGB:hover {color: #FFD000;} #pickCLOSE:hover {color: #FFD000;} #pickOK:hover {color: #FFD000;}":
d.appendChild(document.createTextNode("#pickRGB:hover {color: #FFD000;} #pickCLOSE:hover {color: #FFD000;} #pickOK:hover {color: #FFD000;}"));document.getElementsByTagName("head")[0].appendChild(d);MoveWindow.call(this,"picker");this.savefn=a;this.abortfn=b;this.size=170;this.sv=5;this.oh=2;this.picked={H:360,S:100,V:100,A:1};this.max={H:360,S:100,V:100,A:1};this.colour=new Colour;for(var e="",f,d=0;d<=this.size;d++)f=new Colour({H:Math.round(360/this.size*d),S:100,V:100,A:1}),e+="<div class='hue' style='height: 1px; width: 19px; margin: 0; padding: 0; background: "+
f.htmlHex()+";'> </div>";document.getElementById("Hmodel").innerHTML=e;e="";for(d=0;d<=this.size;d++)f=1-d/this.size,e+="<div class='opacity' style='height: 1px; width: 19px; margin: 0; padding: 0; background: #000;opacity: "+f.toFixed(2)+";'> </div>";document.getElementById("Omodel").innerHTML=e;this.element.picker=this}ColourPicker.prototype=new MoveWindow;ColourPicker.prototype.constructor=MoveWindow;
ColourPicker.prototype.pick=function(a,b,c){this.update(a.HSVA());"block"!=this.element.style.display&&MoveWindow.prototype.open.call(this,b,c)};ColourPicker.prototype.select=function(a,b,c){if(!b||!c){var d=a.getBoundingClientRect();b=b?b:d.left+32;c=c?c:d.top+32}d=new Colour(a.style.backgroundColor);this.update(d.HSVA());"block"!=this.element.style.display&&(MoveWindow.prototype.open.call(this,b,c),this.target=a)};
ColourPicker.prototype.click=function(a,b){if("pickCLOSE"==b.target.id)this.abortfn&&this.abortfn(),toggle("picker");else if("pickOK"==b.target.id){this.savefn&&this.savefn(this.picked);if(this.target){var c=new Colour(this.picked);this.target.style.backgroundColor=c.html()}toggle("picker")}else"SV"==b.target.id?this.setSV(b):"Hslide"==b.target.id||"hue"==b.target.className?this.setHue(b):"Oslide"!=b.target.id&&"opacity"!=b.target.className||this.setOpacity(b)};
ColourPicker.prototype.move=function(a,b){b.isdown&&0==b.button&&("picker"==b.target.id||"pickCUR"==b.target.id||"pickRGB"==b.target.id?MoveWindow.prototype.move.call(this,a,b):b.target&&this.click(a,b))};ColourPicker.prototype.wheel=function(a,b){this.incHue(-a.spin)};
ColourPicker.prototype.setSV=function(a){var b=document.getElementById("SV").getBoundingClientRect(),c=a.absoluteX-parseInt(b.left);a=a.absoluteY-parseInt(b.top);this.picked.S=scale(c,this.size,0,this.max.S);this.picked.V=this.max.V-scale(a,this.size,0,this.max.V);this.update(this.picked)};ColourPicker.prototype.setHue=function(a){var b=document.getElementById("H").getBoundingClientRect();parseInt(b.left);a=a.absoluteY-parseInt(b.top);this.picked.H=scale(a,this.size,0,this.max.H);this.update(this.picked)};
ColourPicker.prototype.incHue=function(a){this.picked.H+=a;this.picked.H=clamp(this.picked.H,0,this.max.H);this.update(this.picked)};ColourPicker.prototype.setOpacity=function(a){var b=document.getElementById("O").getBoundingClientRect();parseInt(b.left);a=a.absoluteY-parseInt(b.top);this.picked.A=1-clamp(a/this.size,0,1);this.update(this.picked)};ColourPicker.prototype.updateString=function(a){a||(a=prompt("Edit colour:",this.colour.html()));a&&(this.colour=new Colour(a),this.update(this.colour.HSV()))};
ColourPicker.prototype.update=function(a){this.picked=a;this.colour=new Colour(a);rgba=this.colour.rgbaObj();rgbaStr=this.colour.html();bgcol=new Colour({H:a.H,S:100,V:100,A:255});document.getElementById("pickRGB").innerHTML=this.colour.printString();document.getElementById("pickCUR").style.background=rgbaStr;document.getElementById("pickCUR").style.backgroundColour=rgbaStr;document.getElementById("SV").style.backgroundColor=bgcol.htmlHex();document.getElementById("Hslide").style.top=a.H/360*this.size-
this.oh+"px";document.getElementById("SVslide").style.top=Math.round(this.size-a.V/100*this.size-this.sv)+"px";document.getElementById("SVslide").style.left=Math.round(a.S/100*this.size-this.sv)+"px";document.getElementById("Oslide").style.top=this.size*(1-a.A)-this.oh-1+"px"};
function GradientEditor(a,b,c,d,e){this.canvas=a;this.callback=b;this.premultiply=c;this.changed=!0;this.inserting=!1;this.element=this.editing=null;this.spin=0;this.scrollable=e;d||(this.picker=new ColourPicker(this.save.bind(this),this.cancel.bind(this)));this.palette=new Palette(null,c);this.canvas.mouse=new Mouse(this.canvas,this);this.canvas.oncontextmenu="return false;";this.canvas.oncontextmenu=function(){return!1}}
GradientEditor.prototype.read=function(a){this.palette=new Palette(a,this.premultiply);this.reset();this.update(!0)};GradientEditor.prototype.update=function(a){this.changed=!0;this.palette.draw(this.canvas,!0);!a&&this.callback&&this.callback(this)};GradientEditor.prototype.get=function(a,b){if(b&&!this.changed)return!1;this.changed=!1;this.palette.draw(a,!1);return!0};
GradientEditor.prototype.insert=function(a,b,c){this.inserting=!0;var d=new Colour;this.editing=this.palette.newColour(a,d);this.update();this.picker=new ColourPicker(this.save.bind(this),this.cancel.bind(this));this.picker.pick(d,b,c)};GradientEditor.prototype.editBackground=function(a){this.editing=-1;this.element=a;this.picker=new ColourPicker(this.save.bind(this),this.cancel.bind(this));a=a.getBoundingClientRect();this.picker.pick(this.palette.background,a.left+32,a.top+32)};
GradientEditor.prototype.edit=function(a,b,c){this.picker=new ColourPicker(this.save.bind(this),this.cancel.bind(this));"number"==typeof a?(this.editing=a,this.picker.pick(this.palette.colours[a].colour,b,c)):"object"==typeof a&&(this.cancel(),this.element=a,b=new Colour(a.style.backgroundColor),a=a.getBoundingClientRect(),this.picker.pick(b,a.left+32,a.top+32));this.update()};
GradientEditor.prototype.save=function(a){null!=this.editing&&(0<=this.editing?this.palette.colours[this.editing].colour.setHSV(a):this.palette.background.setHSV(a));if(this.element){var b=new Colour(0);b.setHSV(a);this.element.style.backgroundColor=b.html();if(this.element.onchange)this.element.onchange()}this.reset();this.update()};GradientEditor.prototype.cancel=function(){0<=this.editing&&this.inserting&&this.palette.remove(this.editing);this.reset();this.update()};
GradientEditor.prototype.reset=function(){this.inserting=!1;this.element=this.editing=null};
GradientEditor.prototype.click=function(a,b){if(a.ctrlKey){for(var c=0;c<this.palette.colours.length;c++)this.palette.colours[c].position=1-this.palette.colours[c].position;this.update();return!1}if(null!=b.slider)return b.slider=null,this.palette.sort(),this.update(),!1;var d=this.canvas;if(d.getContext){this.cancel();d.getContext("2d");var e=d.getBoundingClientRect().top+30,c=this.palette.inRange(b.x,this.palette.slider.width,d.width);0<=c?0==a.button?this.edit(c,a.clientX-128,e):2==a.button&&(this.palette.remove(c),
this.update()):this.insert(b.x/d.width,a.clientX-128,e)}return!1};GradientEditor.prototype.down=function(a,b){return!1};GradientEditor.prototype.move=function(a,b){if(!b.isdown)return!0;if(null==b.slider){var c=this.palette.inDragRange(b.x,this.palette.slider.width,this.canvas.width);0<c&&(b.slider=c)}null==b.slider?b.isdown=!1:(1>b.x&&(b.x=1),b.x>this.canvas.width-1&&(b.x=this.canvas.width-1),this.palette.colours[b.slider].position=b.x/this.canvas.width,this.update(!0))};
GradientEditor.prototype.wheel=function(a,b){this.timer?clearTimeout(this.timer):this.canvas.style.cursor="wait";this.spin+=.01*a.spin;var c=this;this.timer=setTimeout(function(){c.cycle(c.spin);c.spin=0},150)};GradientEditor.prototype.leave=function(a,b){};
GradientEditor.prototype.cycle=function(a){this.canvas.style.cursor="default";this.timer=null;for(var b=1;b<this.palette.colours.length-1;b++){var c=this.palette.colours[b].position,c=c+a;0>=c&&(c+=1);1<=c&&--c;this.palette.colours[b].position=c}this.palette.sort();this.update()};
var FLOAT_EPSILON=1E-6,glMath={};(function(){if("undefined"!=typeof Float32Array){var a=new Float32Array(1),b=new Int32Array(a.buffer);glMath.invsqrt=function(c){a[0]=c;b[0]=1597463007-(b[0]>>1);var d=a[0];return d*(1.5-.5*c*d*d)}}else glMath.invsqrt=function(a){return 1/Math.sqrt(a)}})();var MatrixArray=null;function setMatrixArrayType(a){return MatrixArray=a}function determineMatrixArrayType(){return MatrixArray="undefined"!==typeof Float32Array?Float32Array:Array}determineMatrixArrayType();
var vec3={create:function(a){var b=new MatrixArray(3);a?(b[0]=a[0],b[1]=a[1],b[2]=a[2]):b[0]=b[1]=b[2]=0;return b},createFrom:function(a,b,c){var d=new MatrixArray(3);d[0]=a;d[1]=b;d[2]=c;return d},set:function(a,b){b[0]=a[0];b[1]=a[1];b[2]=a[2];return b},equal:function(a,b){return a===b||Math.abs(a[0]-b[0])<FLOAT_EPSILON&&Math.abs(a[1]-b[1])<FLOAT_EPSILON&&Math.abs(a[2]-b[2])<FLOAT_EPSILON},add:function(a,b,c){if(!c||a===c)return a[0]+=b[0],a[1]+=b[1],a[2]+=b[2],a;c[0]=a[0]+b[0];c[1]=a[1]+b[1];c[2]=
a[2]+b[2];return c},subtract:function(a,b,c){if(!c||a===c)return a[0]-=b[0],a[1]-=b[1],a[2]-=b[2],a;c[0]=a[0]-b[0];c[1]=a[1]-b[1];c[2]=a[2]-b[2];return c},multiply:function(a,b,c){if(!c||a===c)return a[0]*=b[0],a[1]*=b[1],a[2]*=b[2],a;c[0]=a[0]*b[0];c[1]=a[1]*b[1];c[2]=a[2]*b[2];return c},negate:function(a,b){b||(b=a);b[0]=-a[0];b[1]=-a[1];b[2]=-a[2];return b},scale:function(a,b,c){if(!c||a===c)return a[0]*=b,a[1]*=b,a[2]*=b,a;c[0]=a[0]*b;c[1]=a[1]*b;c[2]=a[2]*b;return c},normalize:function(a,b){b||
(b=a);var c=a[0],d=a[1],e=a[2],g=Math.sqrt(c*c+d*d+e*e);if(!g)return b[0]=0,b[1]=0,b[2]=0,b;if(1===g)return b[0]=c,b[1]=d,b[2]=e,b;g=1/g;b[0]=c*g;b[1]=d*g;b[2]=e*g;return b},cross:function(a,b,c){c||(c=a);var d=a[0],e=a[1];a=a[2];var g=b[0],f=b[1];b=b[2];c[0]=e*b-a*f;c[1]=a*g-d*b;c[2]=d*f-e*g;return c},length:function(a){var b=a[0],c=a[1];a=a[2];return Math.sqrt(b*b+c*c+a*a)},squaredLength:function(a){var b=a[0],c=a[1];a=a[2];return b*b+c*c+a*a},dot:function(a,b){return a[0]*b[0]+a[1]*b[1]+a[2]*b[2]},
direction:function(a,b,c){c||(c=a);var d=a[0]-b[0],e=a[1]-b[1];a=a[2]-b[2];b=Math.sqrt(d*d+e*e+a*a);if(!b)return c[0]=0,c[1]=0,c[2]=0,c;b=1/b;c[0]=d*b;c[1]=e*b;c[2]=a*b;return c},lerp:function(a,b,c,d){d||(d=a);d[0]=a[0]+c*(b[0]-a[0]);d[1]=a[1]+c*(b[1]-a[1]);d[2]=a[2]+c*(b[2]-a[2]);return d},dist:function(a,b){var c=b[0]-a[0],d=b[1]-a[1],e=b[2]-a[2];return Math.sqrt(c*c+d*d+e*e)}},xUnitVec3=vec3.createFrom(1,0,0),yUnitVec3=vec3.createFrom(0,1,0),zUnitVec3=vec3.createFrom(0,0,1),tmpvec3=vec3.create();
vec3.str=function(a){return"["+a[0]+", "+a[1]+", "+a[2]+"]"};
var mat4={create:function(a){var b=new MatrixArray(16);a&&(b[0]=a[0],b[1]=a[1],b[2]=a[2],b[3]=a[3],b[4]=a[4],b[5]=a[5],b[6]=a[6],b[7]=a[7],b[8]=a[8],b[9]=a[9],b[10]=a[10],b[11]=a[11],b[12]=a[12],b[13]=a[13],b[14]=a[14],b[15]=a[15]);return b},createFrom:function(a,b,c,d,e,g,f,h,m,k,n,l,q,r,w,x){var p=new MatrixArray(16);p[0]=a;p[1]=b;p[2]=c;p[3]=d;p[4]=e;p[5]=g;p[6]=f;p[7]=h;p[8]=m;p[9]=k;p[10]=n;p[11]=l;p[12]=q;p[13]=r;p[14]=w;p[15]=x;return p},set:function(a,b){b[0]=a[0];b[1]=a[1];b[2]=a[2];b[3]=
a[3];b[4]=a[4];b[5]=a[5];b[6]=a[6];b[7]=a[7];b[8]=a[8];b[9]=a[9];b[10]=a[10];b[11]=a[11];b[12]=a[12];b[13]=a[13];b[14]=a[14];b[15]=a[15];return b},equal:function(a,b){return a===b||Math.abs(a[0]-b[0])<FLOAT_EPSILON&&Math.abs(a[1]-b[1])<FLOAT_EPSILON&&Math.abs(a[2]-b[2])<FLOAT_EPSILON&&Math.abs(a[3]-b[3])<FLOAT_EPSILON&&Math.abs(a[4]-b[4])<FLOAT_EPSILON&&Math.abs(a[5]-b[5])<FLOAT_EPSILON&&Math.abs(a[6]-b[6])<FLOAT_EPSILON&&Math.abs(a[7]-b[7])<FLOAT_EPSILON&&Math.abs(a[8]-b[8])<FLOAT_EPSILON&&Math.abs(a[9]-
b[9])<FLOAT_EPSILON&&Math.abs(a[10]-b[10])<FLOAT_EPSILON&&Math.abs(a[11]-b[11])<FLOAT_EPSILON&&Math.abs(a[12]-b[12])<FLOAT_EPSILON&&Math.abs(a[13]-b[13])<FLOAT_EPSILON&&Math.abs(a[14]-b[14])<FLOAT_EPSILON&&Math.abs(a[15]-b[15])<FLOAT_EPSILON},identity:function(a){a||(a=mat4.create());a[0]=1;a[1]=0;a[2]=0;a[3]=0;a[4]=0;a[5]=1;a[6]=0;a[7]=0;a[8]=0;a[9]=0;a[10]=1;a[11]=0;a[12]=0;a[13]=0;a[14]=0;a[15]=1;return a},transpose:function(a,b){if(!b||a===b){var c=a[1],d=a[2],e=a[3],g=a[6],f=a[7],h=a[11];a[1]=
a[4];a[2]=a[8];a[3]=a[12];a[4]=c;a[6]=a[9];a[7]=a[13];a[8]=d;a[9]=g;a[11]=a[14];a[12]=e;a[13]=f;a[14]=h;return a}b[0]=a[0];b[1]=a[4];b[2]=a[8];b[3]=a[12];b[4]=a[1];b[5]=a[5];b[6]=a[9];b[7]=a[13];b[8]=a[2];b[9]=a[6];b[10]=a[10];b[11]=a[14];b[12]=a[3];b[13]=a[7];b[14]=a[11];b[15]=a[15];return b},determinant:function(a){var b=a[0],c=a[1],d=a[2],e=a[3],g=a[4],f=a[5],h=a[6],m=a[7],k=a[8],n=a[9],l=a[10],q=a[11],r=a[12],w=a[13],x=a[14];a=a[15];return r*n*h*e-k*w*h*e-r*f*l*e+g*w*l*e+k*f*x*e-g*n*x*e-r*n*d*
m+k*w*d*m+r*c*l*m-b*w*l*m-k*c*x*m+b*n*x*m+r*f*d*q-g*w*d*q-r*c*h*q+b*w*h*q+g*c*x*q-b*f*x*q-k*f*d*a+g*n*d*a+k*c*h*a-b*n*h*a-g*c*l*a+b*f*l*a},inverse:function(a,b){b||(b=a);var c=a[0],d=a[1],e=a[2],g=a[3],f=a[4],h=a[5],m=a[6],k=a[7],n=a[8],l=a[9],q=a[10],r=a[11],w=a[12],x=a[13],p=a[14],z=a[15],u=c*h-d*f,v=c*m-e*f,s=c*k-g*f,t=d*m-e*h,A=d*k-g*h,B=e*k-g*m,C=n*x-l*w,D=n*p-q*w,E=n*z-r*w,F=l*p-q*x,G=l*z-r*x,H=q*z-r*p,y=u*H-v*G+s*F+t*E-A*D+B*C;if(!y)return null;y=1/y;b[0]=(h*H-m*G+k*F)*y;b[1]=(-d*H+e*G-g*F)*
y;b[2]=(x*B-p*A+z*t)*y;b[3]=(-l*B+q*A-r*t)*y;b[4]=(-f*H+m*E-k*D)*y;b[5]=(c*H-e*E+g*D)*y;b[6]=(-w*B+p*s-z*v)*y;b[7]=(n*B-q*s+r*v)*y;b[8]=(f*G-h*E+k*C)*y;b[9]=(-c*G+d*E-g*C)*y;b[10]=(w*A-x*s+z*u)*y;b[11]=(-n*A+l*s-r*u)*y;b[12]=(-f*F+h*D-m*C)*y;b[13]=(c*F-d*D+e*C)*y;b[14]=(-w*t+x*v-p*u)*y;b[15]=(n*t-l*v+q*u)*y;return b},toRotationMat:function(a,b){b||(b=mat4.create());b[0]=a[0];b[1]=a[1];b[2]=a[2];b[3]=a[3];b[4]=a[4];b[5]=a[5];b[6]=a[6];b[7]=a[7];b[8]=a[8];b[9]=a[9];b[10]=a[10];b[11]=a[11];b[12]=0;b[13]=
0;b[14]=0;b[15]=1;return b},multiply:function(a,b,c){c||(c=a);var d=a[0],e=a[1],g=a[2],f=a[3],h=a[4],m=a[5],k=a[6],n=a[7],l=a[8],q=a[9],r=a[10],w=a[11],x=a[12],p=a[13],z=a[14];a=a[15];var u=b[0],v=b[1],s=b[2],t=b[3];c[0]=u*d+v*h+s*l+t*x;c[1]=u*e+v*m+s*q+t*p;c[2]=u*g+v*k+s*r+t*z;c[3]=u*f+v*n+s*w+t*a;u=b[4];v=b[5];s=b[6];t=b[7];c[4]=u*d+v*h+s*l+t*x;c[5]=u*e+v*m+s*q+t*p;c[6]=u*g+v*k+s*r+t*z;c[7]=u*f+v*n+s*w+t*a;u=b[8];v=b[9];s=b[10];t=b[11];c[8]=u*d+v*h+s*l+t*x;c[9]=u*e+v*m+s*q+t*p;c[10]=u*g+v*k+s*r+
t*z;c[11]=u*f+v*n+s*w+t*a;u=b[12];v=b[13];s=b[14];t=b[15];c[12]=u*d+v*h+s*l+t*x;c[13]=u*e+v*m+s*q+t*p;c[14]=u*g+v*k+s*r+t*z;c[15]=u*f+v*n+s*w+t*a;return c},multiplyVec3:function(a,b,c){c||(c=b);var d=b[0],e=b[1];b=b[2];c[0]=a[0]*d+a[4]*e+a[8]*b+a[12];c[1]=a[1]*d+a[5]*e+a[9]*b+a[13];c[2]=a[2]*d+a[6]*e+a[10]*b+a[14];return c},translate:function(a,b,c){var d=b[0],e=b[1];b=b[2];var g,f,h,m,k,n,l,q,r,w,x,p;if(!c||a===c)return a[12]=a[0]*d+a[4]*e+a[8]*b+a[12],a[13]=a[1]*d+a[5]*e+a[9]*b+a[13],a[14]=a[2]*
d+a[6]*e+a[10]*b+a[14],a[15]=a[3]*d+a[7]*e+a[11]*b+a[15],a;g=a[0];f=a[1];h=a[2];m=a[3];k=a[4];n=a[5];l=a[6];q=a[7];r=a[8];w=a[9];x=a[10];p=a[11];c[0]=g;c[1]=f;c[2]=h;c[3]=m;c[4]=k;c[5]=n;c[6]=l;c[7]=q;c[8]=r;c[9]=w;c[10]=x;c[11]=p;c[12]=g*d+k*e+r*b+a[12];c[13]=f*d+n*e+w*b+a[13];c[14]=h*d+l*e+x*b+a[14];c[15]=m*d+q*e+p*b+a[15];return c},scale:function(a,b,c){var d=b[0],e=b[1];b=b[2];if(!c||a===c)return a[0]*=d,a[1]*=d,a[2]*=d,a[3]*=d,a[4]*=e,a[5]*=e,a[6]*=e,a[7]*=e,a[8]*=b,a[9]*=b,a[10]*=b,a[11]*=b,
a;c[0]=a[0]*d;c[1]=a[1]*d;c[2]=a[2]*d;c[3]=a[3]*d;c[4]=a[4]*e;c[5]=a[5]*e;c[6]=a[6]*e;c[7]=a[7]*e;c[8]=a[8]*b;c[9]=a[9]*b;c[10]=a[10]*b;c[11]=a[11]*b;c[12]=a[12];c[13]=a[13];c[14]=a[14];c[15]=a[15];return c},rotate:function(a,b,c,d){var e=c[0],g=c[1];c=c[2];var f=Math.sqrt(e*e+g*g+c*c),h,m,k,n,l,q,r,w,x,p,z,u,v,s,t,A,B,C,D,E;if(!f)return null;1!==f&&(f=1/f,e*=f,g*=f,c*=f);h=Math.sin(b);m=Math.cos(b);k=1-m;b=a[0];f=a[1];n=a[2];l=a[3];q=a[4];r=a[5];w=a[6];x=a[7];p=a[8];z=a[9];u=a[10];v=a[11];s=e*e*
k+m;t=g*e*k+c*h;A=c*e*k-g*h;B=e*g*k-c*h;C=g*g*k+m;D=c*g*k+e*h;E=e*c*k+g*h;e=g*c*k-e*h;g=c*c*k+m;d?a!==d&&(d[12]=a[12],d[13]=a[13],d[14]=a[14],d[15]=a[15]):d=a;d[0]=b*s+q*t+p*A;d[1]=f*s+r*t+z*A;d[2]=n*s+w*t+u*A;d[3]=l*s+x*t+v*A;d[4]=b*B+q*C+p*D;d[5]=f*B+r*C+z*D;d[6]=n*B+w*C+u*D;d[7]=l*B+x*C+v*D;d[8]=b*E+q*e+p*g;d[9]=f*E+r*e+z*g;d[10]=n*E+w*e+u*g;d[11]=l*E+x*e+v*g;return d},rotateX:function(a,b,c){var d=Math.sin(b);b=Math.cos(b);var e=a[4],g=a[5],f=a[6],h=a[7],m=a[8],k=a[9],n=a[10],l=a[11];c?a!==c&&
(c[0]=a[0],c[1]=a[1],c[2]=a[2],c[3]=a[3],c[12]=a[12],c[13]=a[13],c[14]=a[14],c[15]=a[15]):c=a;c[4]=e*b+m*d;c[5]=g*b+k*d;c[6]=f*b+n*d;c[7]=h*b+l*d;c[8]=e*-d+m*b;c[9]=g*-d+k*b;c[10]=f*-d+n*b;c[11]=h*-d+l*b;return c},rotateY:function(a,b,c){var d=Math.sin(b);b=Math.cos(b);var e=a[0],g=a[1],f=a[2],h=a[3],m=a[8],k=a[9],n=a[10],l=a[11];c?a!==c&&(c[4]=a[4],c[5]=a[5],c[6]=a[6],c[7]=a[7],c[12]=a[12],c[13]=a[13],c[14]=a[14],c[15]=a[15]):c=a;c[0]=e*b+m*-d;c[1]=g*b+k*-d;c[2]=f*b+n*-d;c[3]=h*b+l*-d;c[8]=e*d+m*
b;c[9]=g*d+k*b;c[10]=f*d+n*b;c[11]=h*d+l*b;return c},rotateZ:function(a,b,c){var d=Math.sin(b);b=Math.cos(b);var e=a[0],g=a[1],f=a[2],h=a[3],m=a[4],k=a[5],n=a[6],l=a[7];c?a!==c&&(c[8]=a[8],c[9]=a[9],c[10]=a[10],c[11]=a[11],c[12]=a[12],c[13]=a[13],c[14]=a[14],c[15]=a[15]):c=a;c[0]=e*b+m*d;c[1]=g*b+k*d;c[2]=f*b+n*d;c[3]=h*b+l*d;c[4]=e*-d+m*b;c[5]=g*-d+k*b;c[6]=f*-d+n*b;c[7]=h*-d+l*b;return c},frustum:function(a,b,c,d,e,g,f){f||(f=mat4.create());var h=b-a,m=d-c,k=g-e;f[0]=2*e/h;f[1]=0;f[2]=0;f[3]=0;
f[4]=0;f[5]=2*e/m;f[6]=0;f[7]=0;f[8]=(b+a)/h;f[9]=(d+c)/m;f[10]=-(g+e)/k;f[11]=-1;f[12]=0;f[13]=0;f[14]=-(g*e*2)/k;f[15]=0;return f},perspective:function(a,b,c,d,e){a=c*Math.tan(a*Math.PI/360);b*=a;return mat4.frustum(-b,b,-a,a,c,d,e)},ortho:function(a,b,c,d,e,g,f){f||(f=mat4.create());var h=b-a,m=d-c,k=g-e;f[0]=2/h;f[1]=0;f[2]=0;f[3]=0;f[4]=0;f[5]=2/m;f[6]=0;f[7]=0;f[8]=0;f[9]=0;f[10]=-2/k;f[11]=0;f[12]=-(a+b)/h;f[13]=-(d+c)/m;f[14]=-(g+e)/k;f[15]=1;return f},lookAt:function(a,b,c,d){d||(d=mat4.create());
var e,g,f,h,m,k,n,l,q=a[0],r=a[1];a=a[2];f=c[0];h=c[1];g=c[2];n=b[0];c=b[1];e=b[2];if(q===n&&r===c&&a===e)return mat4.identity(d);b=q-n;c=r-c;n=a-e;l=1/Math.sqrt(b*b+c*c+n*n);b*=l;c*=l;n*=l;e=h*n-g*c;g=g*b-f*n;f=f*c-h*b;(l=Math.sqrt(e*e+g*g+f*f))?(l=1/l,e*=l,g*=l,f*=l):f=g=e=0;h=c*f-n*g;m=n*e-b*f;k=b*g-c*e;(l=Math.sqrt(h*h+m*m+k*k))?(l=1/l,h*=l,m*=l,k*=l):k=m=h=0;d[0]=e;d[1]=h;d[2]=b;d[3]=0;d[4]=g;d[5]=m;d[6]=c;d[7]=0;d[8]=f;d[9]=k;d[10]=n;d[11]=0;d[12]=-(e*q+g*r+f*a);d[13]=-(h*q+m*r+k*a);d[14]=-(b*
q+c*r+n*a);d[15]=1;return d},str:function(a){return"["+a[0]+", "+a[1]+", "+a[2]+", "+a[3]+", "+a[4]+", "+a[5]+", "+a[6]+", "+a[7]+", "+a[8]+", "+a[9]+", "+a[10]+", "+a[11]+", "+a[12]+", "+a[13]+", "+a[14]+", "+a[15]+"]"}};
var parser=function(){function f(){this.yy={}}var q={trace:function(){},yy:{},symbols_:{error:2,expressions:3,e:4,EOF:5,p:6,"(":7,")":8,real:9,INTEGER:10,REAL:11,E:12,PI:13,"const":14,call:15,IDENTIFIER:16,COMPLEXFN:17,REALFN:18,"+":19,"-":20,"*":21,"/":22,"^":23,"==":24,"!=":25,"<=":26,">=":27,"<":28,">":29,"#":30,"!":31,"|":32,$:33,COMPLEX:34,$accept:0,$end:1},terminals_:{2:"error",5:"EOF",7:"(",8:")",10:"INTEGER",11:"REAL",12:"E",13:"PI",16:"IDENTIFIER",17:"COMPLEXFN",18:"REALFN",19:"+",20:"-",
21:"*",22:"/",23:"^",24:"==",25:"!=",26:"<=",27:">=",28:"<",29:">",30:"#",31:"!",32:"|",33:"$",34:"COMPLEX"},productions_:[0,[3,2],[6,3],[9,1],[9,1],[9,1],[9,1],[14,1],[15,2],[15,2],[15,2],[4,3],[4,3],[4,3],[4,3],[4,3],[4,3],[4,3],[4,3],[4,3],[4,3],[4,3],[4,2],[4,2],[4,2],[4,3],[4,3],[4,1],[4,1],[4,1],[4,1],[4,1]],performAction:function(a,d,e,c,r,b,f){a=b.length-1;switch(r){case 1:return b[a-1];case 2:this.$="real"==c[b[a-1]]&&c.eval?"("+c.eval(b[a-1],!0)+")":"("+b[a-1]+")";c[this.$]=c[b[a-1]];break;
case 3:this.$=b[a]+".0";break;case 5:this.$="2.718281828";break;case 6:this.$="3.141592654";break;case 7:c.eval||(c.eval=function(a,b){var c;c=(a+"").replace(/(?:[a-z$_][a-z0-9$_]*)|(?:[;={}\[\]"'!&<>^\\?:])/ig,function(a){return Math.hasOwnProperty(a)?"Math."+a:a});var d;try{d=eval(c)}catch(e){d=a}return b?d==Math.floor(d)?d+".0":d+"":d});c[this.$]="real";break;case 8:this.$=b[a-1]+b[a];c[this.$]=c[b[a]];break;case 9:this.$="real"!=c[b[a]]?"c"+b[a-1]+b[a]:b[a-1]+b[a];c[this.$]=c[b[a]];break;case 10:this.$=
"real"==c[b[a]]&&c.eval?c.eval(b[a-1]+b[a],!0):b[a-1]+b[a];c[this.$]="real";break;case 11:var m,k;c.eval&&(m=c.eval(b[a-2]),k=c.eval(b[a]));0==m?this.$=b[a]:0==k?this.$=b[a-2]:"real"==c[b[a-2]]&&"real"==c[b[a]]?(this.$=b[a-2]+" + "+b[a],c.eval&&(this.$=c.eval(this.$,!0)),c[this.$]="real"):(this.$="real"==c[b[a-2]]?"C("+b[a-2]+",0) + "+b[a]:"real"==c[b[a]]?b[a-2]+" + C("+b[a]+",0)":b[a-2]+" + "+b[a],c[this.$]="complex");break;case 12:c.eval&&(m=c.eval(b[a-2]),k=c.eval(b[a]));0==m?this.$=b[a]:0==k?
this.$=b[a-2]:"real"==c[b[a-2]]&&"real"==c[b[a]]?(this.$=b[a-2]+" - "+b[a],c.eval&&(this.$=c.eval(this.$,!0)),c[this.$]="real"):(this.$="real"==c[b[a-2]]?"C("+b[a-2]+",0) - "+b[a]:"real"==c[b[a]]?b[a-2]+" - C("+b[a]+",0)":b[a-2]+" - "+b[a],c[this.$]="complex");break;case 13:c.eval&&(m=c.eval(b[a-2]),k=c.eval(b[a]));0==m||0==k?(this.$="0.0",c[this.$]="real"):1==m?this.$=b[a]:1==k?this.$=b[a-2]:"real"==c[b[a-2]]&&"real"==c[b[a]]?(this.$=b[a-2]+" * "+b[a],c.eval&&(this.$=c.eval(this.$,!0)),c[this.$]=
"real"):(this.$="real"==c[b[a-2]]?"mul(C("+b[a-2]+",0),"+b[a]+")":"real"==c[b[a]]?"mul("+b[a-2]+",C("+b[a]+",0))":"mul("+b[a-2]+","+b[a]+")",c[this.$]="complex");break;case 14:c.eval&&(m=c.eval(b[a-2]),k=c.eval(b[a]));0==m||0==k?(this.$="0.0",c[this.$]="real"):1==k?this.$=b[a-2]:"real"==c[b[a-2]]&&"real"==c[b[a]]?(this.$=b[a-2]+" / "+b[a],c.eval&&(this.$=c.eval(this.$,!0)),c[this.$]="real"):("real"==c[b[a-2]]?c.eval&&1==c.eval(b[a-2])?this.$="inv("+b[a]+")":this.$="div(C("+b[a-2]+",0), "+b[a]+")":
"real"==c[b[a]]?c.eval&&1==c.eval(b[a])?this.$=b[a-2]:this.$="div("+b[a-2]+",(C(, "+b[a]+",0))":this.$="div("+b[a-2]+","+b[a]+")",c[this.$]="complex");break;case 15:var p;c.eval&&(p=c.eval(b[a]));1==p?this.$=b[a-2]:"real"==c[b[a-2]]&&"real"==c[b[a]]?(this.$="pow("+b[a-2]+", "+b[a]+")",this.$=c.eval?c.eval(this.$,!0):0==p?"1.0":2==p?"("+b[a-2]+"*"+b[a-2]+")":3==p?"("+b[a-2]+"*"+b[a-2]+"*"+b[a-2]+")":"pow("+b[a-2]+","+b[a]+")",c[this.$]="real"):(0==p?this.$="C(1,0)":2==p?this.$="sqr("+b[a-2]+")":3==
p?this.$="cube("+b[a-2]+")":("real"==c[b[a-2]]&&(b[a-2]="C("+b[a-2]+",0)"),"real"==c[b[a]]&&(b[a]="C("+b[a]+",0)"),this.$="cpow("+b[a-2]+","+b[a]+")"),c[this.$]="complex");break;case 16:this.$=b[a-2]+" == "+b[a];break;case 17:this.$=b[a-2]+" != "+b[a];break;case 18:this.$="R("+b[a-2]+") <= R("+b[a]+")";break;case 19:this.$="R("+b[a-2]+") >= R("+b[a]+")";break;case 20:this.$="R("+b[a-2]+") < R("+b[a]+")";break;case 21:this.$="R("+b[a-2]+") > R("+b[a]+")";break;case 22:this.$="R("+b[a]+")";c[this.$]=
"real";break;case 23:this.$="!"+b[a];c[this.$]=c[b[a]];break;case 24:this.$="-"+b[a];c[this.$]=c[b[a]];break;case 25:this.$="real"==c[b[a-1]]?"abs("+b[a-1]+")":"cabs("+b[a-1]+")";c[this.$]="real";break;case 26:this.$="real"==c[b[a-1]]?"("+b[a-1]+"*"+b[a-1]+")":"norm("+b[a-1]+")";c[this.$]="real";break;case 27:c[this.$]="real";break;case 28:this.$="C"+b[a];c[this.$]="complex";break;case 29:switch(b[a]){case "pi":case "PI":this.$="PI";c[this.$]="real";break;case "e":case "E":this.$="E";c[this.$]="real";
break;default:c[this.$]="complex"}}},table:[{3:1,4:2,30:[1,3],31:[1,4],20:[1,5],32:[1,6],33:[1,7],14:8,34:[1,9],16:[1,10],6:11,15:12,9:13,7:[1,14],17:[1,15],18:[1,16],10:[1,17],11:[1,18],12:[1,19],13:[1,20]},{1:[3]},{5:[1,21],19:[1,22],20:[1,23],21:[1,24],22:[1,25],23:[1,26],24:[1,27],25:[1,28],26:[1,29],27:[1,30],28:[1,31],29:[1,32]},{4:33,30:[1,3],31:[1,4],20:[1,5],32:[1,6],33:[1,7],14:8,34:[1,9],16:[1,10],6:11,15:12,9:13,7:[1,14],17:[1,15],18:[1,16],10:[1,17],11:[1,18],12:[1,19],13:[1,20]},{4:34,
30:[1,3],31:[1,4],20:[1,5],32:[1,6],33:[1,7],14:8,34:[1,9],16:[1,10],6:11,15:12,9:13,7:[1,14],17:[1,15],18:[1,16],10:[1,17],11:[1,18],12:[1,19],13:[1,20]},{4:35,30:[1,3],31:[1,4],20:[1,5],32:[1,6],33:[1,7],14:8,34:[1,9],16:[1,10],6:11,15:12,9:13,7:[1,14],17:[1,15],18:[1,16],10:[1,17],11:[1,18],12:[1,19],13:[1,20]},{4:36,30:[1,3],31:[1,4],20:[1,5],32:[1,6],33:[1,7],14:8,34:[1,9],16:[1,10],6:11,15:12,9:13,7:[1,14],17:[1,15],18:[1,16],10:[1,17],11:[1,18],12:[1,19],13:[1,20]},{4:37,30:[1,3],31:[1,4],
20:[1,5],32:[1,6],33:[1,7],14:8,34:[1,9],16:[1,10],6:11,15:12,9:13,7:[1,14],17:[1,15],18:[1,16],10:[1,17],11:[1,18],12:[1,19],13:[1,20]},{5:[2,27],19:[2,27],20:[2,27],21:[2,27],22:[2,27],23:[2,27],24:[2,27],25:[2,27],26:[2,27],27:[2,27],28:[2,27],29:[2,27],32:[2,27],33:[2,27],8:[2,27]},{5:[2,28],19:[2,28],20:[2,28],21:[2,28],22:[2,28],23:[2,28],24:[2,28],25:[2,28],26:[2,28],27:[2,28],28:[2,28],29:[2,28],32:[2,28],33:[2,28],8:[2,28]},{6:38,7:[1,14],5:[2,29],19:[2,29],20:[2,29],21:[2,29],22:[2,29],
23:[2,29],24:[2,29],25:[2,29],26:[2,29],27:[2,29],28:[2,29],29:[2,29],32:[2,29],33:[2,29],8:[2,29]},{5:[2,30],19:[2,30],20:[2,30],21:[2,30],22:[2,30],23:[2,30],24:[2,30],25:[2,30],26:[2,30],27:[2,30],28:[2,30],29:[2,30],32:[2,30],33:[2,30],8:[2,30]},{5:[2,31],19:[2,31],20:[2,31],21:[2,31],22:[2,31],23:[2,31],24:[2,31],25:[2,31],26:[2,31],27:[2,31],28:[2,31],29:[2,31],32:[2,31],33:[2,31],8:[2,31]},{29:[2,7],28:[2,7],27:[2,7],26:[2,7],25:[2,7],24:[2,7],23:[2,7],22:[2,7],21:[2,7],20:[2,7],19:[2,7],5:[2,
7],8:[2,7],33:[2,7],32:[2,7]},{4:39,30:[1,3],31:[1,4],20:[1,5],32:[1,6],33:[1,7],14:8,34:[1,9],16:[1,10],6:11,15:12,9:13,7:[1,14],17:[1,15],18:[1,16],10:[1,17],11:[1,18],12:[1,19],13:[1,20]},{6:40,7:[1,14]},{6:41,7:[1,14]},{5:[2,3],19:[2,3],20:[2,3],21:[2,3],22:[2,3],23:[2,3],24:[2,3],25:[2,3],26:[2,3],27:[2,3],28:[2,3],29:[2,3],32:[2,3],33:[2,3],8:[2,3]},{5:[2,4],19:[2,4],20:[2,4],21:[2,4],22:[2,4],23:[2,4],24:[2,4],25:[2,4],26:[2,4],27:[2,4],28:[2,4],29:[2,4],32:[2,4],33:[2,4],8:[2,4]},{5:[2,5],
19:[2,5],20:[2,5],21:[2,5],22:[2,5],23:[2,5],24:[2,5],25:[2,5],26:[2,5],27:[2,5],28:[2,5],29:[2,5],32:[2,5],33:[2,5],8:[2,5]},{5:[2,6],19:[2,6],20:[2,6],21:[2,6],22:[2,6],23:[2,6],24:[2,6],25:[2,6],26:[2,6],27:[2,6],28:[2,6],29:[2,6],32:[2,6],33:[2,6],8:[2,6]},{1:[2,1]},{4:42,30:[1,3],31:[1,4],20:[1,5],32:[1,6],33:[1,7],14:8,34:[1,9],16:[1,10],6:11,15:12,9:13,7:[1,14],17:[1,15],18:[1,16],10:[1,17],11:[1,18],12:[1,19],13:[1,20]},{4:43,30:[1,3],31:[1,4],20:[1,5],32:[1,6],33:[1,7],14:8,34:[1,9],16:[1,
10],6:11,15:12,9:13,7:[1,14],17:[1,15],18:[1,16],10:[1,17],11:[1,18],12:[1,19],13:[1,20]},{4:44,30:[1,3],31:[1,4],20:[1,5],32:[1,6],33:[1,7],14:8,34:[1,9],16:[1,10],6:11,15:12,9:13,7:[1,14],17:[1,15],18:[1,16],10:[1,17],11:[1,18],12:[1,19],13:[1,20]},{4:45,30:[1,3],31:[1,4],20:[1,5],32:[1,6],33:[1,7],14:8,34:[1,9],16:[1,10],6:11,15:12,9:13,7:[1,14],17:[1,15],18:[1,16],10:[1,17],11:[1,18],12:[1,19],13:[1,20]},{4:46,30:[1,3],31:[1,4],20:[1,5],32:[1,6],33:[1,7],14:8,34:[1,9],16:[1,10],6:11,15:12,9:13,
7:[1,14],17:[1,15],18:[1,16],10:[1,17],11:[1,18],12:[1,19],13:[1,20]},{4:47,30:[1,3],31:[1,4],20:[1,5],32:[1,6],33:[1,7],14:8,34:[1,9],16:[1,10],6:11,15:12,9:13,7:[1,14],17:[1,15],18:[1,16],10:[1,17],11:[1,18],12:[1,19],13:[1,20]},{4:48,30:[1,3],31:[1,4],20:[1,5],32:[1,6],33:[1,7],14:8,34:[1,9],16:[1,10],6:11,15:12,9:13,7:[1,14],17:[1,15],18:[1,16],10:[1,17],11:[1,18],12:[1,19],13:[1,20]},{4:49,30:[1,3],31:[1,4],20:[1,5],32:[1,6],33:[1,7],14:8,34:[1,9],16:[1,10],6:11,15:12,9:13,7:[1,14],17:[1,15],
18:[1,16],10:[1,17],11:[1,18],12:[1,19],13:[1,20]},{4:50,30:[1,3],31:[1,4],20:[1,5],32:[1,6],33:[1,7],14:8,34:[1,9],16:[1,10],6:11,15:12,9:13,7:[1,14],17:[1,15],18:[1,16],10:[1,17],11:[1,18],12:[1,19],13:[1,20]},{4:51,30:[1,3],31:[1,4],20:[1,5],32:[1,6],33:[1,7],14:8,34:[1,9],16:[1,10],6:11,15:12,9:13,7:[1,14],17:[1,15],18:[1,16],10:[1,17],11:[1,18],12:[1,19],13:[1,20]},{4:52,30:[1,3],31:[1,4],20:[1,5],32:[1,6],33:[1,7],14:8,34:[1,9],16:[1,10],6:11,15:12,9:13,7:[1,14],17:[1,15],18:[1,16],10:[1,17],
11:[1,18],12:[1,19],13:[1,20]},{19:[2,22],20:[2,22],21:[2,22],22:[2,22],23:[2,22],24:[2,22],25:[2,22],26:[2,22],27:[2,22],28:[2,22],29:[2,22],5:[2,22],32:[2,22],33:[2,22],8:[2,22]},{19:[2,23],20:[2,23],21:[2,23],22:[2,23],23:[2,23],24:[2,23],25:[2,23],26:[2,23],27:[2,23],28:[2,23],29:[2,23],5:[2,23],32:[2,23],33:[2,23],8:[2,23]},{19:[2,24],20:[2,24],21:[2,24],22:[2,24],23:[2,24],24:[2,24],25:[2,24],26:[2,24],27:[2,24],28:[2,24],29:[2,24],5:[2,24],32:[2,24],33:[2,24],8:[2,24]},{32:[1,53],19:[1,22],
20:[1,23],21:[1,24],22:[1,25],23:[1,26],24:[1,27],25:[1,28],26:[1,29],27:[1,30],28:[1,31],29:[1,32]},{33:[1,54],19:[1,22],20:[1,23],21:[1,24],22:[1,25],23:[1,26],24:[1,27],25:[1,28],26:[1,29],27:[1,30],28:[1,31],29:[1,32]},{29:[2,8],28:[2,8],27:[2,8],26:[2,8],25:[2,8],24:[2,8],23:[2,8],22:[2,8],21:[2,8],20:[2,8],19:[2,8],5:[2,8],8:[2,8],33:[2,8],32:[2,8]},{8:[1,55],19:[1,22],20:[1,23],21:[1,24],22:[1,25],23:[1,26],24:[1,27],25:[1,28],26:[1,29],27:[1,30],28:[1,31],29:[1,32]},{29:[2,9],28:[2,9],27:[2,
9],26:[2,9],25:[2,9],24:[2,9],23:[2,9],22:[2,9],21:[2,9],20:[2,9],19:[2,9],5:[2,9],8:[2,9],33:[2,9],32:[2,9]},{29:[2,10],28:[2,10],27:[2,10],26:[2,10],25:[2,10],24:[2,10],23:[2,10],22:[2,10],21:[2,10],20:[2,10],19:[2,10],5:[2,10],8:[2,10],33:[2,10],32:[2,10]},{19:[2,11],20:[2,11],21:[1,24],22:[1,25],23:[1,26],24:[2,11],25:[2,11],26:[2,11],27:[2,11],28:[2,11],29:[2,11],5:[2,11],32:[2,11],33:[2,11],8:[2,11]},{19:[2,12],20:[2,12],21:[1,24],22:[1,25],23:[1,26],24:[2,12],25:[2,12],26:[2,12],27:[2,12],
28:[2,12],29:[2,12],5:[2,12],32:[2,12],33:[2,12],8:[2,12]},{19:[2,13],20:[2,13],21:[2,13],22:[2,13],23:[1,26],24:[2,13],25:[2,13],26:[2,13],27:[2,13],28:[2,13],29:[2,13],5:[2,13],32:[2,13],33:[2,13],8:[2,13]},{19:[2,14],20:[2,14],21:[2,14],22:[2,14],23:[1,26],24:[2,14],25:[2,14],26:[2,14],27:[2,14],28:[2,14],29:[2,14],5:[2,14],32:[2,14],33:[2,14],8:[2,14]},{19:[2,15],20:[2,15],21:[2,15],22:[2,15],23:[2,15],24:[2,15],25:[2,15],26:[2,15],27:[2,15],28:[2,15],29:[2,15],5:[2,15],32:[2,15],33:[2,15],8:[2,
15]},{19:[1,22],20:[1,23],21:[1,24],22:[1,25],23:[1,26],24:[2,16],25:[2,16],26:[2,16],27:[2,16],28:[2,16],29:[2,16],5:[2,16],32:[2,16],33:[2,16],8:[2,16]},{19:[1,22],20:[1,23],21:[1,24],22:[1,25],23:[1,26],24:[2,17],25:[2,17],26:[2,17],27:[2,17],28:[2,17],29:[2,17],5:[2,17],32:[2,17],33:[2,17],8:[2,17]},{19:[1,22],20:[1,23],21:[1,24],22:[1,25],23:[1,26],24:[2,18],25:[2,18],26:[2,18],27:[2,18],28:[2,18],29:[2,18],5:[2,18],32:[2,18],33:[2,18],8:[2,18]},{19:[1,22],20:[1,23],21:[1,24],22:[1,25],23:[1,
26],24:[2,19],25:[2,19],26:[2,19],27:[2,19],28:[2,19],29:[2,19],5:[2,19],32:[2,19],33:[2,19],8:[2,19]},{19:[1,22],20:[1,23],21:[1,24],22:[1,25],23:[1,26],24:[2,20],25:[2,20],26:[2,20],27:[2,20],28:[2,20],29:[2,20],5:[2,20],32:[2,20],33:[2,20],8:[2,20]},{19:[1,22],20:[1,23],21:[1,24],22:[1,25],23:[1,26],24:[2,21],25:[2,21],26:[2,21],27:[2,21],28:[2,21],29:[2,21],5:[2,21],32:[2,21],33:[2,21],8:[2,21]},{5:[2,25],19:[2,25],20:[2,25],21:[2,25],22:[2,25],23:[2,25],24:[2,25],25:[2,25],26:[2,25],27:[2,25],
28:[2,25],29:[2,25],32:[2,25],33:[2,25],8:[2,25]},{5:[2,26],19:[2,26],20:[2,26],21:[2,26],22:[2,26],23:[2,26],24:[2,26],25:[2,26],26:[2,26],27:[2,26],28:[2,26],29:[2,26],32:[2,26],33:[2,26],8:[2,26]},{29:[2,2],28:[2,2],27:[2,2],26:[2,2],25:[2,2],24:[2,2],23:[2,2],22:[2,2],21:[2,2],20:[2,2],19:[2,2],5:[2,2],8:[2,2],33:[2,2],32:[2,2]}],defaultActions:{21:[2,1]},parseError:function(a,d){if(d.recoverable)this.trace(a);else throw Error(a);},parse:function(a){var d=[0],e=[null],c=[],r=this.table,b="",f=
0,m=0,k=0;this.lexer.setInput(a);this.lexer.yy=this.yy;this.yy.lexer=this.lexer;this.yy.parser=this;"undefined"==typeof this.lexer.yylloc&&(this.lexer.yylloc={});a=this.lexer.yylloc;c.push(a);var p=this.lexer.options&&this.lexer.options.ranges;this.parseError="function"===typeof this.yy.parseError?this.yy.parseError:Object.getPrototypeOf(this).parseError;for(var g,q,n,h,s={},t,l;;){n=d[d.length-1];if(this.defaultActions[n])h=this.defaultActions[n];else{if(null===g||"undefined"==typeof g)g=void 0,
g=this.lexer.lex()||1,"number"!==typeof g&&(g=this.symbols_[g]||g);h=r[n]&&r[n][g]}if("undefined"===typeof h||!h.length||!h[0]){var u="";l=[];for(t in r[n])this.terminals_[t]&&2<t&&l.push("'"+this.terminals_[t]+"'");u=this.lexer.showPosition?"Parse error on line "+(f+1)+":\n"+this.lexer.showPosition()+"\nExpecting "+l.join(", ")+", got '"+(this.terminals_[g]||g)+"'":"Parse error on line "+(f+1)+": Unexpected "+(1==g?"end of input":"'"+(this.terminals_[g]||g)+"'");this.parseError(u,{text:this.lexer.match,
token:this.terminals_[g]||g,line:this.lexer.yylineno,loc:a,expected:l})}if(h[0]instanceof Array&&1<h.length)throw Error("Parse Error: multiple actions possible at state: "+n+", token: "+g);switch(h[0]){case 1:d.push(g);e.push(this.lexer.yytext);c.push(this.lexer.yylloc);d.push(h[1]);g=null;q?(g=q,q=null):(m=this.lexer.yyleng,b=this.lexer.yytext,f=this.lexer.yylineno,a=this.lexer.yylloc,0<k&&k--);break;case 2:l=this.productions_[h[1]][1];s.$=e[e.length-l];s._$={first_line:c[c.length-(l||1)].first_line,
last_line:c[c.length-1].last_line,first_column:c[c.length-(l||1)].first_column,last_column:c[c.length-1].last_column};p&&(s._$.range=[c[c.length-(l||1)].range[0],c[c.length-1].range[1]]);n=this.performAction.call(s,b,m,f,this.yy,h[1],e,c);if("undefined"!==typeof n)return n;l&&(d=d.slice(0,-2*l),e=e.slice(0,-1*l),c=c.slice(0,-1*l));d.push(this.productions_[h[1]][0]);e.push(s.$);c.push(s._$);h=r[d[d.length-2]][d[d.length-1]];d.push(h);break;case 3:return!0}}}},v=function(){return{EOF:1,parseError:function(a,
d){if(this.yy.parser)this.yy.parser.parseError(a,d);else throw Error(a);},setInput:function(a){this._input=a;this._more=this._backtrack=this.done=!1;this.yylineno=this.yyleng=0;this.yytext=this.matched=this.match="";this.conditionStack=["INITIAL"];this.yylloc={first_line:1,first_column:0,last_line:1,last_column:0};this.options.ranges&&(this.yylloc.range=[0,0]);this.offset=0;return this},input:function(){var a=this._input[0];this.yytext+=a;this.yyleng++;this.offset++;this.match+=a;this.matched+=a;
a.match(/(?:\r\n?|\n).*/g)?(this.yylineno++,this.yylloc.last_line++):this.yylloc.last_column++;this.options.ranges&&this.yylloc.range[1]++;this._input=this._input.slice(1);return a},unput:function(a){var d=a.length,e=a.split(/(?:\r\n?|\n)/g);this._input=a+this._input;this.yytext=this.yytext.substr(0,this.yytext.length-d-1);this.offset-=d;a=this.match.split(/(?:\r\n?|\n)/g);this.match=this.match.substr(0,this.match.length-1);this.matched=this.matched.substr(0,this.matched.length-1);e.length-1&&(this.yylineno-=
e.length-1);var c=this.yylloc.range;this.yylloc={first_line:this.yylloc.first_line,last_line:this.yylineno+1,first_column:this.yylloc.first_column,last_column:e?(e.length===a.length?this.yylloc.first_column:0)+a[a.length-e.length].length-e[0].length:this.yylloc.first_column-d};this.options.ranges&&(this.yylloc.range=[c[0],c[0]+this.yyleng-d]);this.yyleng=this.yytext.length;return this},more:function(){this._more=!0;return this},reject:function(){if(this.options.backtrack_lexer)this._backtrack=!0;
else return this.parseError("Lexical error on line "+(this.yylineno+1)+". You can only invoke reject() in the lexer when the lexer is of the backtracking persuasion (options.backtrack_lexer = true).\n"+this.showPosition(),{text:"",token:null,line:this.yylineno});return this},less:function(a){this.unput(this.match.slice(a))},pastInput:function(){var a=this.matched.substr(0,this.matched.length-this.match.length);return(20<a.length?"...":"")+a.substr(-20).replace(/\n/g,"")},upcomingInput:function(){var a=
this.match;20>a.length&&(a+=this._input.substr(0,20-a.length));return(a.substr(0,20)+(20<a.length?"...":"")).replace(/\n/g,"")},showPosition:function(){var a=this.pastInput(),d=Array(a.length+1).join("-");return a+this.upcomingInput()+"\n"+d+"^"},test_match:function(a,d){var e,c;this.options.backtrack_lexer&&(c={yylineno:this.yylineno,yylloc:{first_line:this.yylloc.first_line,last_line:this.last_line,first_column:this.yylloc.first_column,last_column:this.yylloc.last_column},yytext:this.yytext,match:this.match,
matches:this.matches,matched:this.matched,yyleng:this.yyleng,offset:this.offset,_more:this._more,_input:this._input,yy:this.yy,conditionStack:this.conditionStack.slice(0),done:this.done},this.options.ranges&&(c.yylloc.range=this.yylloc.range.slice(0)));if(e=a[0].match(/(?:\r\n?|\n).*/g))this.yylineno+=e.length;this.yylloc={first_line:this.yylloc.last_line,last_line:this.yylineno+1,first_column:this.yylloc.last_column,last_column:e?e[e.length-1].length-e[e.length-1].match(/\r?\n?/)[0].length:this.yylloc.last_column+
a[0].length};this.yytext+=a[0];this.match+=a[0];this.matches=a;this.yyleng=this.yytext.length;this.options.ranges&&(this.yylloc.range=[this.offset,this.offset+=this.yyleng]);this._backtrack=this._more=!1;this._input=this._input.slice(a[0].length);this.matched+=a[0];e=this.performAction.call(this,this.yy,this,d,this.conditionStack[this.conditionStack.length-1]);this.done&&this._input&&(this.done=!1);if(e)return this.options.backtrack_lexer&&delete c,e;if(this._backtrack){for(var f in c)this[f]=c[f];
return!1}this.options.backtrack_lexer&&delete c;return!1},next:function(){if(this.done)return this.EOF;this._input||(this.done=!0);var a,d,e;this._more||(this.match=this.yytext="");for(var c=this._currentRules(),f=0;f<c.length;f++)if((d=this._input.match(this.rules[c[f]]))&&(!a||d[0].length>a[0].length))if(a=d,e=f,this.options.backtrack_lexer){a=this.test_match(d,c[f]);if(!1!==a)return a;if(this._backtrack)a=!1;else return!1}else if(!this.options.flex)break;return a?(a=this.test_match(a,c[e]),!1!==
a?a:!1):""===this._input?this.EOF:this.parseError("Lexical error on line "+(this.yylineno+1)+". Unrecognized text.\n"+this.showPosition(),{text:"",token:null,line:this.yylineno})},lex:function(){var a=this.next();return a?a:this.lex()},begin:function(a){this.conditionStack.push(a)},popState:function(){return 0<this.conditionStack.length-1?this.conditionStack.pop():this.conditionStack[0]},_currentRules:function(){return this.conditionStack.length&&this.conditionStack[this.conditionStack.length-1]?
this.conditions[this.conditionStack[this.conditionStack.length-1]].rules:this.conditions.INITIAL.rules},topState:function(a){a=this.conditionStack.length-1-Math.abs(a||0);return 0<=a?this.conditionStack[a]:"INITIAL"},pushState:function(a){this.begin(a)},stateStackSize:function(){return this.conditionStack.length},options:{},performAction:function(a,d,e,c){switch(e){case 1:return 34;case 2:return 11;case 3:return 10;case 4:return 21;case 5:return 22;case 6:return 20;case 7:return 19;case 8:return 23;
case 9:return 7;case 10:return 8;case 11:return 30;case 12:return 33;case 13:return 32;case 14:return",";case 15:return 24;case 16:return 25;case 17:return 26;case 18:return 26;case 19:return 27;case 20:return 27;case 21:return 28;case 22:return 29;case 23:return 31;case 24:return 5;case 25:return 12;case 26:return 13;case 27:return 18;case 28:return 17;case 29:return 16;case 30:return"INVALID"}},rules:[/^(?:\s+)/,/^(?:\(-?[0-9]+(\.[0-9]+)?\b,-?[0-9]+(\.[0-9]+)?\b\))/,/^(?:[0-9]+(\.[0-9]+)\b)/,/^(?:[0-9]+)/,
/^(?:\*)/,/^(?:\/)/,/^(?:-)/,/^(?:\+)/,/^(?:\^)/,/^(?:\()/,/^(?:\))/,/^(?:#)/,/^(?:\|\|)/,/^(?:\|)/,/^(?:,)/,/^(?:==)/,/^(?:!=)/,/^(?:<=)/,/^(?:=<)/,/^(?:>=)/,/^(?:=>)/,/^(?:<)/,/^(?:>)/,/^(?:!)/,/^(?:$)/,/^(?:E\b)/,/^(?:PI\b)/,/^(?:manhattan|norm|cabs|arg|imag|dot|real|log\b)/,/^(?:pow|exp|asinh|acosh|atanh|asin|acos|atan|sinh|cosh|tanh|sin|cos|tan|sqrt|ln|log10\b)/,/^(?:[@:]*[_a-zA-Z][_a-zA-Z0-9]*(\.[w-z])?)/,/^(?:.)/],conditions:{INITIAL:{rules:[0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,
20,21,22,23,24,25,26,27,28,29,30],inclusive:!0}}}}();q.lexer=v;f.prototype=q;q.Parser=f;return new f}();
"undefined"!==typeof require&&"undefined"!==typeof exports&&(exports.parser=parser,exports.Parser=parser.Parser,exports.parse=function(){return parser.parse.apply(parser,arguments)},exports.main=function(f){f[1]||(console.log("Usage: "+f[0]+" FILE"),process.exit(1));f=require("fs").readFileSync(require("path").normalize(f[1]),"utf8");return exports.parser.parse(f)},"undefined"!==typeof module&&require.main===module&&exports.main(process.argv.slice(1)));
